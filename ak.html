<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NexChat - Advanced Chat App</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Dark background */
            color: #e2e8f0; /* Light text color */
        }
        /* Custom animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        /* Scrollbar styling for chat messages */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #2d3748; /* Darker gray for track */
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #4a5568; /* Medium gray for thumb */
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #636b77; /* Lighter gray on hover */
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <!-- Loading Screen -->
    <div id="loading-screen" class="absolute inset-0 flex items-center justify-center bg-gray-900 text-teal-400 text-4xl font-extrabold z-50">
        Loading NexChat...
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="hidden w-full h-full max-w-7xl mx-auto flex flex-col items-center justify-center">
        <!-- Authentication Forms (Sign In, Sign Up, Forgot Password) -->
        <div id="auth-forms" class="w-full max-w-md">
            <!-- Forms will be dynamically loaded here -->
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="hidden w-full h-full flex flex-col bg-gray-900 text-white rounded-xl shadow-2xl overflow-hidden">
            <!-- Header -->
            <header class="flex justify-between items-center p-6 bg-gray-800 shadow-lg">
                <h1 class="text-4xl font-extrabold text-teal-400">NexChat</h1>
                <div class="flex items-center space-x-4">
                    <span id="welcome-message" class="text-lg text-gray-300"></span>
                    <button id="sign-out-button" class="bg-red-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-700 transition-all duration-300 shadow-md">
                        Sign Out
                    </button>
                </div>
            </header>

            <!-- Navigation Tabs -->
            <nav class="flex justify-center bg-gray-700 p-3 shadow-inner">
                <button id="tab-profile" class="px-6 py-3 rounded-lg font-semibold mx-2 transition-all duration-300 text-gray-300 hover:bg-gray-600">
                    My Profile
                </button>
                <button id="tab-chat-rooms" class="px-6 py-3 rounded-lg font-semibold mx-2 transition-all duration-300 text-gray-300 hover:bg-gray-600">
                    Chat Rooms
                </button>
                <button id="tab-friends" class="px-6 py-3 rounded-lg font-semibold mx-2 transition-all duration-300 text-gray-300 hover:bg-gray-600">
                    Friends
                </button>
            </nav>

            <!-- Main Content Area -->
            <main id="main-content" class="flex-grow p-8 overflow-auto custom-scrollbar">
                <!-- Content for selected tab will be loaded here -->
            </main>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            signInWithCustomToken,
            signInAnonymously,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            sendPasswordResetEmail,
            onAuthStateChanged,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            doc,
            setDoc,
            getDoc,
            updateDoc,
            collection,
            query,
            where,
            getDocs,
            writeBatch
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Configuration (from user prompt)
        const firebaseConfig = {
            apiKey: "AIzaSyB_Q5EseET7WykS4WcIQs1Y7a-CMcbn",
            authDomain: "aapurti-9e385.firebaseapp.com",
            databaseURL: "https://aapurti-9e385-default-rtdb.firebaseio.com",
            projectId: "aapurti-9e385",
            storageBucket: "aapurti-9e385.appspot.com",
            messagingSenderId: "72618637937",
            appId: "1:72618637937:web:e89cca640172708f23f9d0",
            measurementId: "G-4C479V87YN"
        };

        // Global Firebase instances
        let app;
        let auth;
        let db;
        let currentUser = null;
        let currentAuthMode = 'signIn'; // 'signIn', 'signUp', 'forgotPassword'
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- Helper Functions ---

        /**
         * Displays a message box with a given message and type (success/error).
         * @param {string} message - The message to display.
         * @param {'success'|'error'} type - The type of message.
         */
        function showMessageBox(message, type) {
            const messageBoxContainer = document.getElementById('message-box-container');
            if (!messageBoxContainer) {
                const appContainer = document.getElementById('app-container');
                if (appContainer) {
                    const div = document.createElement('div');
                    div.id = 'message-box-container';
                    div.className = 'absolute top-4 w-full max-w-md z-50 flex justify-center';
                    appContainer.prepend(div); // Prepend to show above forms/dashboard
                }
            }

            const box = document.createElement('div');
            const bgColor = type === 'error' ? 'bg-red-500' : 'bg-green-500';
            box.className = `${bgColor} text-white p-4 rounded-lg shadow-lg mb-4 flex justify-between items-center animate-fade-in`;
            box.innerHTML = `
                <span>${message}</span>
                <button class="text-white font-bold ml-4 close-message-box">X</button>
            `;
            document.getElementById('message-box-container').innerHTML = ''; // Clear previous
            document.getElementById('message-box-container').appendChild(box);

            box.querySelector('.close-message-box').onclick = () => {
                box.remove();
            };
        }

        /**
         * Hides the message box.
         */
        function hideMessageBox() {
            const messageBoxContainer = document.getElementById('message-box-container');
            if (messageBoxContainer) {
                messageBoxContainer.innerHTML = '';
            }
        }

        /**
         * Renders the Sign Up form.
         */
        function renderSignUpForm() {
            hideMessageBox();
            const authFormsDiv = document.getElementById('auth-forms');
            authFormsDiv.innerHTML = `
                <div class="flex flex-col items-center justify-center p-8 bg-gray-800 rounded-xl shadow-2xl w-full max-w-md animate-fade-in">
                    <h2 class="text-3xl font-bold text-teal-400 mb-6">Sign Up</h2>
                    <form id="signup-form" class="w-full space-y-4">
                        <input type="text" id="signup-name" placeholder="Name" class="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:border-teal-400 focus:outline-none transition-all duration-300" required />
                        <input type="number" id="signup-age" placeholder="Age" class="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:border-teal-400 focus:outline-none transition-all duration-300" required />
                        <select id="signup-gender" class="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:border-teal-400 focus:outline-none transition-all duration-300" required>
                            <option value="">Select Gender</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                        <input type="tel" id="signup-mobile" placeholder="Mobile Number" class="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:border-teal-400 focus:outline-none transition-all duration-300" required />
                        <input type="email" id="signup-email" placeholder="Email" class="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:border-teal-400 focus:outline-none transition-all duration-300" required />
                        <input type="password" id="signup-password" placeholder="Password" class="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:border-teal-400 focus:outline-none transition-all duration-300" required />
                        <input type="text" id="signup-username" placeholder="Unique Username (e.g., @johndoe)" class="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:border-teal-400 focus:outline-none transition-all duration-300" required />
                        <button type="submit" id="signup-button" class="w-full bg-gradient-to-r from-teal-500 to-blue-600 text-white p-3 rounded-lg font-semibold hover:from-teal-600 hover:to-blue-700 transition-all duration-300 shadow-lg transform hover:scale-105">
                            Sign Up
                        </button>
                    </form>
                    <p class="text-gray-400 mt-6">
                        Already have an account?
                        <button id="signin-link-from-signup" class="text-teal-400 hover:underline">Sign In</button>
                    </p>
                </div>
            `;

            document.getElementById('signup-form').addEventListener('submit', handleSignUp);
            document.getElementById('signin-link-from-signup').addEventListener('click', () => {
                currentAuthMode = 'signIn';
                renderAuthUI();
            });
        }

        /**
         * Renders the Sign In form.
         */
        function renderSignInForm() {
            hideMessageBox();
            const authFormsDiv = document.getElementById('auth-forms');
            authFormsDiv.innerHTML = `
                <div class="flex flex-col items-center justify-center p-8 bg-gray-800 rounded-xl shadow-2xl w-full max-w-md animate-fade-in">
                    <h2 class="text-3xl font-bold text-teal-400 mb-6">Sign In</h2>
                    <form id="signin-form" class="w-full space-y-4">
                        <input type="email" id="signin-email" placeholder="Email" class="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:border-teal-400 focus:outline-none transition-all duration-300" required />
                        <input type="password" id="signin-password" placeholder="Password" class="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:border-teal-400 focus:outline-none transition-all duration-300" required />
                        <button type="submit" id="signin-button" class="w-full bg-gradient-to-r from-teal-500 to-blue-600 text-white p-3 rounded-lg font-semibold hover:from-teal-600 hover:to-blue-700 transition-all duration-300 shadow-lg transform hover:scale-105">
                            Sign In
                        </button>
                    </form>
                    <p class="text-gray-400 mt-6">
                        Don't have an account?
                        <button id="signup-link-from-signin" class="text-teal-400 hover:underline">Sign Up</button>
                    </p>
                    <p class="text-gray-400 mt-2">
                        <button id="forgot-password-link" class="text-teal-400 hover:underline">Forgot Password?</button>
                    </p>
                </div>
            `;

            document.getElementById('signin-form').addEventListener('submit', handleSignIn);
            document.getElementById('signup-link-from-signin').addEventListener('click', () => {
                currentAuthMode = 'signUp';
                renderAuthUI();
            });
            document.getElementById('forgot-password-link').addEventListener('click', () => {
                currentAuthMode = 'forgotPassword';
                renderAuthUI();
            });
        }

        /**
         * Renders the Forgot Password form.
         */
        function renderForgotPasswordForm() {
            hideMessageBox();
            const authFormsDiv = document.getElementById('auth-forms');
            authFormsDiv.innerHTML = `
                <div class="flex flex-col items-center justify-center p-8 bg-gray-800 rounded-xl shadow-2xl w-full max-w-md animate-fade-in">
                    <h2 class="text-3xl font-bold text-teal-400 mb-6">Forgot Password</h2>
                    <form id="forgot-password-form" class="w-full space-y-4">
                        <input type="email" id="forgot-password-email" placeholder="Enter your email" class="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:border-teal-400 focus:outline-none transition-all duration-300" required />
                        <button type="submit" id="forgot-password-button" class="w-full bg-gradient-to-r from-teal-500 to-blue-600 text-white p-3 rounded-lg font-semibold hover:from-teal-600 hover:to-blue-700 transition-all duration-300 shadow-lg transform hover:scale-105">
                            Reset Password
                        </button>
                    </form>
                    <p class="text-gray-400 mt-6">
                        Remember your password?
                        <button id="signin-link-from-forgot" class="text-teal-400 hover:underline">Sign In</button>
                    </p>
                </div>
            `;

            document.getElementById('forgot-password-form').addEventListener('submit', handleForgotPassword);
            document.getElementById('signin-link-from-forgot').addEventListener('click', () => {
                currentAuthMode = 'signIn';
                renderAuthUI();
            });
        }

        /**
         * Handles user sign-up.
         * @param {Event} e - The form submission event.
         */
        async function handleSignUp(e) {
            e.preventDefault();
            hideMessageBox();
            const name = document.getElementById('signup-name').value;
            const age = document.getElementById('signup-age').value;
            const gender = document.getElementById('signup-gender').value;
            const mobileNumber = document.getElementById('signup-mobile').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const username = document.getElementById('signup-username').value.toLowerCase().replace(/\s/g, '');
            const signUpButton = document.getElementById('signup-button');

            signUpButton.disabled = true;
            signUpButton.textContent = 'Signing Up...';

            try {
                // Check for unique username first
                const usernameRef = doc(db, `artifacts/${appId}/public/data/usernames`, username);
                const usernameSnap = await getDoc(usernameRef);

                if (usernameSnap.exists()) {
                    showMessageBox('Username already taken. Please choose another.', 'error');
                    return;
                }

                // Create user in Firebase Authentication
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // Use a batch for atomic write to users and usernames collections
                const batch = writeBatch(db);

                // Add user profile to 'users' collection
                const userProfileRef = doc(db, `artifacts/${appId}/users/${user.uid}/profiles/profile`);
                batch.set(userProfileRef, {
                    uid: user.uid,
                    email: user.email,
                    name,
                    age: parseInt(age),
                    gender,
                    mobileNumber,
                    username: username,
                    profilePictureUrl: '', // Default empty
                    createdAt: new Date().toISOString()
                });

                // Add username to 'usernames' collection for uniqueness check
                batch.set(usernameRef, {
                    uid: user.uid,
                    username: username
                });

                await batch.commit();

                showMessageBox('Sign Up successful! You can now sign in.', 'success');
                // Clear form fields
                document.getElementById('signup-name').value = '';
                document.getElementById('signup-age').value = '';
                document.getElementById('signup-gender').value = '';
                document.getElementById('signup-mobile').value = '';
                document.getElementById('signup-email').value = '';
                document.getElementById('signup-password').value = '';
                document.getElementById('signup-username').value = '';

                currentAuthMode = 'signIn';
                renderAuthUI(); // Redirect to sign-in
            } catch (error) {
                showMessageBox(`Sign Up failed: ${error.message}`, 'error');
                console.error("Sign Up Error:", error);
            } finally {
                signUpButton.disabled = false;
                signUpButton.textContent = 'Sign Up';
            }
        }

        /**
         * Handles user sign-in.
         * @param {Event} e - The form submission event.
         */
        async function handleSignIn(e) {
            e.preventDefault();
            hideMessageBox();
            const email = document.getElementById('signin-email').value;
            const password = document.getElementById('signin-password').value;
            const signInButton = document.getElementById('signin-button');

            signInButton.disabled = true;
            signInButton.textContent = 'Signing In...';

            try {
                await signInWithEmailAndPassword(auth, email, password);
                showMessageBox('Signed in successfully!', 'success');
            } catch (error) {
                showMessageBox(`Sign In failed: ${error.message}`, 'error');
                console.error("Sign In Error:", error);
            } finally {
                signInButton.disabled = false;
                signInButton.textContent = 'Sign In';
            }
        }

        /**
         * Handles forgot password request.
         * @param {Event} e - The form submission event.
         */
        async function handleForgotPassword(e) {
            e.preventDefault();
            hideMessageBox();
            const email = document.getElementById('forgot-password-email').value;
            const resetButton = document.getElementById('forgot-password-button');

            resetButton.disabled = true;
            resetButton.textContent = 'Sending...';

            try {
                await sendPasswordResetEmail(auth, email);
                showMessageBox('Password reset email sent! Check your inbox.', 'success');
                document.getElementById('forgot-password-email').value = '';
            } catch (error) {
                showMessageBox(`Failed to send reset email: ${error.message}`, 'error');
                console.error("Forgot Password Error:", error);
            } finally {
                resetButton.disabled = false;
                resetButton.textContent = 'Reset Password';
            }
        }

        /**
         * Renders the appropriate authentication UI based on currentAuthMode.
         */
        function renderAuthUI() {
            const authFormsDiv = document.getElementById('auth-forms');
            const dashboardDiv = document.getElementById('dashboard');
            authFormsDiv.classList.remove('hidden');
            dashboardDiv.classList.add('hidden');

            if (currentAuthMode === 'signIn') {
                renderSignInForm();
            } else if (currentAuthMode === 'signUp') {
                renderSignUpForm();
            } else if (currentAuthMode === 'forgotPassword') {
                renderForgotPasswordForm();
            }
        }

        /**
         * Renders the Dashboard UI.
         */
        function renderDashboardUI() {
            hideMessageBox();
            const authFormsDiv = document.getElementById('auth-forms');
            const dashboardDiv = document.getElementById('dashboard');
            authFormsDiv.classList.add('hidden');
            dashboardDiv.classList.remove('hidden');

            document.getElementById('welcome-message').textContent = `Welcome, ${currentUser?.email || 'Guest'}!`;
            document.getElementById('sign-out-button').onclick = handleSignOut;

            // Set initial active tab
            setActiveTab('profile'); // Default to profile tab
        }

        /**
         * Sets the active tab in the dashboard.
         * @param {string} tabName - The name of the tab ('profile', 'chatRooms', 'friends').
         */
        function setActiveTab(tabName) {
            const tabs = ['profile', 'chatRooms', 'friends'];
            tabs.forEach(tab => {
                const button = document.getElementById(`tab-${tab}`);
                if (button) {
                    if (tab === tabName) {
                        button.classList.add('bg-teal-500', 'text-white', 'shadow-md');
                        button.classList.remove('text-gray-300', 'hover:bg-gray-600');
                    } else {
                        button.classList.remove('bg-teal-500', 'text-white', 'shadow-md');
                        button.classList.add('text-gray-300', 'hover:bg-gray-600');
                    }
                }
            });

            const mainContent = document.getElementById('main-content');
            if (mainContent) {
                mainContent.innerHTML = ''; // Clear previous content
                if (tabName === 'profile') {
                    renderProfileContent();
                } else if (tabName === 'chatRooms') {
                    renderChatRoomsContent();
                } else if (tabName === 'friends') {
                    renderFriendsContent();
                }
            }
        }

        /**
         * Handles user sign-out.
         */
        async function handleSignOut() {
            try {
                await signOut(auth);
                showMessageBox('Signed out successfully.', 'success');
                // onAuthStateChanged will handle rendering auth UI
            } catch (error) {
                showMessageBox(`Error signing out: ${error.message}`, 'error');
                console.error("Sign Out Error:", error);
            }
        }

        /**
         * Renders the Profile content.
         */
        async function renderProfileContent() {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `<div class="text-teal-400 text-center text-xl">Loading profile...</div>`; // Loading indicator

            if (!currentUser || !currentUser.uid) {
                mainContent.innerHTML = `<div class="text-red-400 text-center text-xl">User not authenticated.</div>`;
                return;
            }

            try {
                const profileRef = doc(db, `artifacts/${appId}/users/${currentUser.uid}/profiles/profile`);
                const profileSnap = await getDoc(profileRef);

                if (profileSnap.exists()) {
                    const profileData = profileSnap.data();
                    mainContent.innerHTML = `
                        <div id="profile-display" class="bg-gray-800 p-8 rounded-xl shadow-2xl max-w-2xl mx-auto animate-fade-in">
                            <h3 class="text-3xl font-bold text-teal-400 mb-6">My Profile</h3>
                            <div id="profile-message-box-container"></div>
                            <div class="space-y-4">
                                <div class="flex items-center space-x-4 mb-6">
                                    <img id="profile-pic" src="${profileData.profilePictureUrl || `https://placehold.co/100x100/333333/FFFFFF?text=${profileData.name.charAt(0).toUpperCase()}`}"
                                        alt="Profile" class="w-24 h-24 rounded-full object-cover border-4 border-teal-500 shadow-lg"
                                        onerror="this.onerror=null;this.src='https://placehold.co/100x100/333333/FFFFFF?text=P';" />
                                    <div>
                                        <p class="text-2xl font-semibold text-white">${profileData.name}</p>
                                        <p class="text-lg text-gray-400">@${profileData.username}</p>
                                        <p class="text-sm text-gray-500">UID: ${currentUser.uid}</p>
                                    </div>
                                </div>
                                <p class="text-lg text-gray-300">Email: <span class="text-white">${profileData.email}</span></p>
                                <p class="text-lg text-gray-300">Age: <span class="text-white">${profileData.age}</span></p>
                                <p class="text-lg text-gray-300">Gender: <span class="text-white">${profileData.gender}</span></p>
                                <p class="text-lg text-gray-300">Mobile: <span class="text-white">${profileData.mobileNumber}</span></p>
                                <button id="edit-profile-button" class="mt-6 bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition-all duration-300 shadow-lg transform hover:scale-105">
                                    Edit Profile
                                </button>
                            </div>
                        </div>
                    `;
                    document.getElementById('edit-profile-button').onclick = () => renderEditProfileForm(profileData);
                } else {
                    mainContent.innerHTML = `<div class="text-red-400 text-center text-xl">Profile not found. Please complete your registration.</div>`;
                }
            } catch (error) {
                mainContent.innerHTML = `<div class="text-red-400 text-center text-xl">Error fetching profile: ${error.message}</div>`;
                console.error("Error fetching profile:", error);
            }
        }

        /**
         * Renders the Edit Profile form.
         * @param {Object} profileData - The current profile data.
         */
        function renderEditProfileForm(profileData) {
            const profileDisplayDiv = document.getElementById('profile-display');
            if (!profileDisplayDiv) return; // Should not happen if called correctly

            hideMessageBox(); // Hide any existing message box

            profileDisplayDiv.innerHTML = `
                <h3 class="text-3xl font-bold text-teal-400 mb-6">Edit Profile</h3>
                <div id="profile-message-box-container"></div>
                <form id="edit-profile-form" class="space-y-4">
                    <label class="block text-gray-300">Name:</label>
                    <input type="text" id="edit-name" value="${profileData.name}" class="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:border-teal-400 focus:outline-none transition-all duration-300" required />
                    <label class="block text-gray-300">Age:</label>
                    <input type="number" id="edit-age" value="${profileData.age}" class="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:border-teal-400 focus:outline-none transition-all duration-300" required />
                    <label class="block text-gray-300">Gender:</label>
                    <select id="edit-gender" class="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:border-teal-400 focus:outline-none transition-all duration-300" required>
                        <option value="">Select Gender</option>
                        <option value="Male" ${profileData.gender === 'Male' ? 'selected' : ''}>Male</option>
                        <option value="Female" ${profileData.gender === 'Female' ? 'selected' : ''}>Female</option>
                        <option value="Other" ${profileData.gender === 'Other' ? 'selected' : ''}>Other</option>
                    </select>
                    <label class="block text-gray-300">Profile Picture URL:</label>
                    <input type="url" id="edit-profile-picture-url" placeholder="Enter image URL" value="${profileData.profilePictureUrl || ''}" class="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:border-teal-400 focus:outline-none transition-all duration-300" />
                    <div class="flex justify-end space-x-4 mt-6">
                        <button type="button" id="cancel-edit-button" class="bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-gray-700 transition-all duration-300 shadow-lg">
                            Cancel
                        </button>
                        <button type="submit" id="save-profile-button" class="bg-teal-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-teal-700 transition-all duration-300 shadow-lg transform hover:scale-105">
                            Save Changes
                        </button>
                    </div>
                </form>
            `;

            document.getElementById('edit-profile-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                hideMessageBox(); // Hide previous messages from this form
                const saveButton = document.getElementById('save-profile-button');
                saveButton.disabled = true;
                saveButton.textContent = 'Saving...';

                try {
                    const profileRef = doc(db, `artifacts/${appId}/users/${currentUser.uid}/profiles/profile`);
                    await updateDoc(profileRef, {
                        name: document.getElementById('edit-name').value,
                        age: parseInt(document.getElementById('edit-age').value),
                        gender: document.getElementById('edit-gender').value,
                        profilePictureUrl: document.getElementById('edit-profile-picture-url').value
                    });
                    showMessageBox('Profile updated successfully!', 'success');
                    renderProfileContent(); // Re-render profile display
                } catch (error) {
                    showMessageBox(`Error updating profile: ${error.message}`, 'error');
                    console.error("Error updating profile:", error);
                } finally {
                    saveButton.disabled = false;
                    saveButton.textContent = 'Save Changes';
                }
            });

            document.getElementById('cancel-edit-button').onclick = () => renderProfileContent();
        }


        /**
         * Renders the Chat Rooms content (placeholder).
         */
        function renderChatRoomsContent() {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div class="bg-gray-800 p-8 rounded-xl shadow-2xl max-w-2xl mx-auto animate-fade-in">
                    <h3 class="text-3xl font-bold text-teal-400 mb-6">Chat Rooms</h3>
                    <p class="text-gray-300 mb-4">
                        Here you will be able to create and join public or private chat rooms.
                        Private rooms will require creator approval and can be shared via invite.
                    </p>
                    <p class="text-gray-400 text-sm">
                        Current User UID: <span class="font-mono text-teal-300">${currentUser?.uid}</span>
                    </p>
                    <div class="mt-8 p-4 border border-gray-600 rounded-lg text-gray-500 italic">
                        <p>Features to be implemented:</p>
                        <ul class="list-disc list-inside ml-4">
                            <li>Create Public/Private Chat Rooms</li>
                            <li>Share Private Rooms by username</li>
                            <li>Creator approval for Private Rooms</li>
                            <li>Invite system for rooms</li>
                            <li>View joined rooms and activity</li>
                        </ul>
                    </div>
                </div>
            `;
        }

        /**
         * Renders the Friends content (placeholder).
         */
        function renderFriendsContent() {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = `
                <div class="bg-gray-800 p-8 rounded-xl shadow-2xl max-w-2xl mx-auto animate-fade-in">
                    <h3 class="text-3xl font-bold text-teal-400 mb-6">Friend System</h3>
                    <p class="text-gray-300 mb-4">
                        Connect with other users! Search for friends, send requests, and direct message them.
                    </p>
                    <p class="text-gray-400 text-sm">
                        Current User UID: <span class="font-mono text-teal-300">${currentUser?.uid}</span>
                    </p>
                    <div class="mt-8 p-4 border border-gray-600 rounded-lg text-gray-500 italic">
                        <p>Features to be implemented:</p>
                        <ul class="list-disc list-inside ml-4">
                            <li>Search users by username</li>
                            <li>Send/Accept/Decline Friend Requests</li>
                            <li>Real-time online/offline status for friends</li>
                            <li>Direct Messaging outside chat rooms</li>
                            <li>Notifications for friend requests/messages</li>
                        </ul>
                    </div>
                </div>
            `;
        }

        // --- Initialization and Auth State Listener ---

        /**
         * Initializes Firebase and sets up the authentication state listener.
         */
        async function initializeAppAndAuth() {
            // Hide loading screen
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');

            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            // Initial sign-in with custom token or anonymously
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Error during initial sign-in:", error);
                // If initial sign-in fails, default to sign-in form
                currentUser = null;
                renderAuthUI();
            }

            // Listen for authentication state changes
            onAuthStateChanged(auth, (user) => {
                currentUser = user;
                if (currentUser) {
                    renderDashboardUI();
                } else {
                    currentAuthMode = 'signIn'; // Always default to sign-in when logged out
                    renderAuthUI();
                }
            });

            // Add event listeners for navigation tabs
            document.getElementById('tab-profile').addEventListener('click', () => setActiveTab('profile'));
            document.getElementById('tab-chat-rooms').addEventListener('click', () => setActiveTab('chatRooms'));
            document.getElementById('tab-friends').addEventListener('click', () => setActiveTab('friends'));
        }

        // Start the application when the window loads
        window.onload = initializeAppAndAuth;

    </script>
</body>
</html>
