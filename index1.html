import React, { useState, useEffect, useRef, useCallback } from 'react';
import { initializeApp } from 'firebase/app';
import {
  getAuth,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  signOut,
  sendPasswordResetEmail,
  updateProfile,
  updatePassword,
  reauthenticateWithCredential,
  EmailAuthProvider,
  onAuthStateChanged,
  signInAnonymously,
  signInWithCustomToken
} from 'firebase/auth';
import {
  getFirestore,
  doc,
  getDoc,
  addDoc,
  setDoc,
  updateDoc,
  deleteDoc,
  onSnapshot,
  collection,
  query,
  where,
  getDocs,
  serverTimestamp
} from 'firebase/firestore';

// Ensure Prism.js is loaded in the HTML file for syntax highlighting
// Example:
// <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.27.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
// <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.27.0/prism.min.js"></script>
// <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.27.0/components/prism-json.min.js"></script>
// <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.27.0/components/prism-javascript.min.js"></script>


// Global variables provided by the Canvas environment
// Ensure these are defined in your environment or provide fallbacks
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = typeof __firebase_config !== 'undefined'
  ? JSON.parse(__firebase_config)
  : {
      apiKey: "AIzaSyB_Q5EseET7WykS4WcIQs1Y7a-CMmcbnp8",
      authDomain: "aapurti-9e385.firebaseapp.com",
      databaseURL: "https://aapurti-9e385-default-rtdb.firebaseio.com",
      projectId: "aapurti-9e385",
      storageBucket: "aapurti-9e385.appspot.com",
      messagingSenderId: "72618637937",
      appId: "1:72618637937:web:e89cca640172708f23f9d0",
      measurementId: "G-4C479V87YN"
    };
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// Initialize Firebase App
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Helper function to format dates
const formatDate = (timestamp) => {
  if (!timestamp) return 'N/A';
  const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
  return date.toLocaleString();
};

// Reusable Modal Component
const Modal = ({ isOpen, onClose, title, children }) => {
  if (!isOpen) return null;
  return (
    <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 p-4">
      <div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-lg mx-auto p-6 relative transform transition-all sm:my-8 sm:align-middle sm:max-w-xl sm:w-full">
        <h3 className="text-xl font-semibold text-gray-900 dark:text-white mb-4">{title}</h3>
        <button
          onClick={onClose}
          className="absolute top-4 right-4 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors"
        >
          <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
        <div className="text-gray-700 dark:text-gray-300">
          {children}
        </div>
      </div>
    </div>
  );
};

// Loading Spinner Component
const LoadingSpinner = () => (
  <div className="flex justify-center items-center py-4">
    <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
  </div>
);

// Auth Forms (Sign In / Sign Up)
const AuthPage = ({ onAuthSuccess, showMessage }) => {
  const [isLogin, setIsLogin] = useState(true);
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [displayName, setDisplayName] = useState('');
  const [loading, setLoading] = useState(false);

  const handleAuth = async (e) => {
    e.preventDefault();
    setLoading(true);
    try {
      if (isLogin) {
        await signInWithEmailAndPassword(auth, email, password);
        showMessage('Logged in successfully!', 'success');
      } else {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        await updateProfile(userCredential.user, { displayName });
        showMessage('Account created successfully!', 'success');
      }
      onAuthSuccess();
    } catch (error) {
      showMessage(`Authentication Error: ${error.message}`, 'error');
    } finally {
      setLoading(false);
    }
  };

  const handlePasswordReset = async () => {
    if (!email) {
      showMessage('Please enter your email to reset password.', 'warning');
      return;
    }
    setLoading(true);
    try {
      await sendPasswordResetEmail(auth, email);
      showMessage('Password reset email sent. Check your inbox.', 'success');
    } catch (error) {
      showMessage(`Password Reset Error: ${error.message}`, 'error');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="flex flex-col items-center justify-center min-h-screen bg-gray-100 dark:bg-gray-900 p-4">
      <div className="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-xl w-full max-w-md">
        <h2 className="text-2xl font-bold text-center text-gray-900 dark:text-white mb-6">
          {isLogin ? 'Login' : 'Sign Up'}
        </h2>
        <form onSubmit={handleAuth} className="space-y-4">
          {!isLogin && (
            <div>
              <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" htmlFor="displayName">Display Name</label>
              <input
                type="text"
                id="displayName"
                className="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white"
                value={displayName}
                onChange={(e) => setDisplayName(e.target.value)}
                required={!isLogin}
              />
            </div>
          )}
          <div>
            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" htmlFor="email">Email</label>
            <input
              type="email"
              id="email"
              className="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              required
            />
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" htmlFor="password">Password</label>
            <input
              type="password"
              id="password"
              className="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              required
            />
          </div>
          <button
            type="submit"
            className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-md transition-colors duration-200 shadow-md"
            disabled={loading}
          >
            {loading ? <LoadingSpinner /> : (isLogin ? 'Login' : 'Sign Up')}
          </button>
        </form>
        <div className="mt-6 text-center">
          <button
            onClick={() => setIsLogin(!isLogin)}
            className="text-blue-600 hover:underline text-sm"
          >
            {isLogin ? 'Need an account? Sign Up' : 'Already have an account? Login'}
          </button>
          {isLogin && (
            <button
              onClick={handlePasswordReset}
              className="block mt-2 text-blue-600 hover:underline text-sm mx-auto"
            >
              Forgot Password?
            </button>
          )}
        </div>
      </div>
    </div>
  );
};

// Request Tester Component
const RequestTester = ({ user, showMessage, logActivity }) => {
  const [url, setUrl] = useState('https://jsonplaceholder.typicode.com/posts/1');
  const [method, setMethod] = useState('GET');
  const [headers, setHeaders] = useState('{}');
  const [body, setBody] = useState('');
  const [responseStatus, setResponseStatus] = useState(null);
  const [responseHeaders, setResponseHeaders] = useState('');
  const [responseBody, setResponseBody] = useState('');
  const [loading, setLoading] = useState(false);
  const [shareLink, setShareLink] = useState('');
  const [showFullResponseModal, setShowFullResponseModal] = useState(false);
  const [fullResponseBody, setFullResponseBody] = useState('');

  const responseBodyRef = useRef(null);
  const responseHeadersRef = useRef(null);

  const applySyntaxHighlighting = useCallback(() => {
    if (window.Prism) {
      if (responseBodyRef.current) {
        window.Prism.highlightElement(responseBodyRef.current);
      }
      if (responseHeadersRef.current) {
        window.Prism.highlightElement(responseHeadersRef.current);
      }
    }
  }, []);

  useEffect(() => {
    applySyntaxHighlighting();
  }, [responseBody, responseHeaders, applySyntaxHighlighting]);

  const getStatusCodeColor = (status) => {
    if (!status) return 'text-gray-500';
    if (status >= 200 && status < 300) return 'text-green-500';
    if (status >= 300 && status < 400) return 'text-yellow-500';
    return 'text-red-500';
  };

  const sendRequest = async () => {
    setLoading(true);
    setResponseStatus(null);
    setResponseHeaders('');
    setResponseBody('');
    setShareLink('');
    setFullResponseBody('');

    let parsedHeaders = {};
    try {
      parsedHeaders = JSON.parse(headers);
    } catch (e) {
      showMessage('Invalid Headers JSON. Please ensure it is valid JSON.', 'error');
      setLoading(false);
      return;
    }

    const requestOptions = {
      method: method,
      headers: {
        'Content-Type': 'application/json', // Default content type for body
        ...parsedHeaders
      },
    };

    if (method !== 'GET' && method !== 'HEAD') {
      try {
        // Attempt to parse body as JSON, otherwise send as plain text
        requestOptions.body = JSON.stringify(JSON.parse(body));
      } catch (e) {
        requestOptions.body = body; // Send as plain text if not valid JSON
        if (!parsedHeaders['Content-Type']) {
          requestOptions.headers['Content-Type'] = 'text/plain';
        }
      }
    }

    const startTime = performance.now();
    try {
      const response = await fetch(url, requestOptions);
      const endTime = performance.now();
      const responseTime = (endTime - startTime).toFixed(2);

      setResponseStatus(response.status);

      const responseHeadersObj = {};
      response.headers.forEach((value, name) => {
        responseHeadersObj[name] = value;
      });
      setResponseHeaders(JSON.stringify(responseHeadersObj, null, 2));

      const responseText = await response.text();
      setFullResponseBody(responseText); // Store raw response for full view

      let formattedBody = responseText;
      try {
        formattedBody = JSON.stringify(JSON.parse(responseText), null, 2);
        setResponseBody(formattedBody);
      } catch (e) {
        setResponseBody(responseText); // Not JSON, display as plain text
      }

      showMessage(`Request successful! Status: ${response.status} (${responseTime} ms)`, 'success');

      // Log activity
      await logActivity('API Request', {
        url,
        method,
        status: response.status,
        responseTime: parseFloat(responseTime),
        sharedResponseId: null // Will be updated if shared
      });

    } catch (error) {
      showMessage(`Request Error: ${error.message}`, 'error');
      setResponseStatus('Error');
      setResponseBody(`Error: ${error.message}`);
      await logActivity('API Request Failed', { url, method, error: error.message });
    } finally {
      setLoading(false);
    }
  };

  const shareResponse = async () => {
    if (!user || !responseStatus) {
      showMessage('Perform a request first and be logged in to share.', 'warning');
      return;
    }
    setLoading(true);
    try {
      const responseData = {
        userId: user.uid,
        url,
        method,
        requestHeaders: headers,
        requestBody: body,
        responseStatus,
        responseHeaders,
        responseBody: fullResponseBody, // Store raw body for sharing
        timestamp: serverTimestamp(),
      };

      const docRef = await addDoc(collection(db, `sharedResponses`), responseData);
      const generatedShareLink = `${window.location.origin}/share/${docRef.id}`;
      setShareLink(generatedShareLink);
      showMessage('Response shared successfully!', 'success');

      // Update activity log with shared link
      await logActivity('Response Shared', {
        url,
        method,
        status: responseStatus,
        sharedResponseId: docRef.id,
        shareLink: generatedShareLink
      });

    } catch (error) {
      showMessage(`Error sharing response: ${error.message}`, 'error');
    } finally {
      setLoading(false);
    }
  };

  const copyShareLink = () => {
    if (shareLink) {
      document.execCommand('copy'); // Fallback for navigator.clipboard.writeText not working in some iframes
      const textarea = document.createElement('textarea');
      textarea.value = shareLink;
      document.body.appendChild(textarea);
      textarea.select();
      document.execCommand('copy');
      document.body.removeChild(textarea);
      showMessage('Share link copied to clipboard!', 'success');
    }
  };

  return (
    <div className="p-6 bg-gray-100 dark:bg-gray-900 min-h-screen text-gray-900 dark:text-white">
      <h2 className="text-3xl font-bold mb-6 text-center">API Request Tester</h2>

      <div className="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-6">
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
          <div className="md:col-span-2">
            <label htmlFor="url" className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">URL</label>
            <input
              type="text"
              id="url"
              className="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white"
              value={url}
              onChange={(e) => setUrl(e.target.value)}
              placeholder="e.g., https://api.example.com/data"
            />
          </div>
          <div>
            <label htmlFor="method" className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Method</label>
            <select
              id="method"
              className="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white"
              value={method}
              onChange={(e) => setMethod(e.target.value)}
            >
              <option value="GET">GET</option>
              <option value="POST">POST</option>
              <option value="PUT">PUT</option>
              <option value="PATCH">PATCH</option>
              <option value="DELETE">DELETE</option>
            </select>
          </div>
        </div>

        <div className="mb-4">
          <label htmlFor="headers" className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Headers (JSON)</label>
          <textarea
            id="headers"
            rows="4"
            className="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500 font-mono text-sm bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white"
            value={headers}
            onChange={(e) => setHeaders(e.target.value)}
            placeholder='{"Content-Type": "application/json", "Authorization": "Bearer token"}'
          ></textarea>
        </div>

        {(method !== 'GET' && method !== 'HEAD') && (
          <div className="mb-4">
            <label htmlFor="body" className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Request Body (JSON or Text)</label>
            <textarea
              id="body"
              rows="6"
              className="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500 font-mono text-sm bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white"
              value={body}
              onChange={(e) => setBody(e.target.value)}
              placeholder='{"key": "value", "number": 123}'
            ></textarea>
          </div>
        )}

        <button
          onClick={sendRequest}
          className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-md transition-colors duration-200 shadow-md"
          disabled={loading}
        >
          {loading ? <LoadingSpinner /> : 'Send Request'}
        </button>
      </div>

      {responseStatus && (
        <div className="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
          <h3 className="text-xl font-bold mb-4">Response</h3>

          <div className="mb-4">
            <p className="text-sm font-medium text-gray-700 dark:text-gray-300">Status Code:</p>
            <span className={`text-2xl font-bold ${getStatusCodeColor(responseStatus)}`}>
              {responseStatus}
            </span>
          </div>

          <div className="mb-4">
            <p className="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Headers:</p>
            <pre className="p-3 bg-gray-50 dark:bg-gray-700 rounded-md overflow-auto max-h-60">
              <code ref={responseHeadersRef} className="language-json text-sm">
                {responseHeaders}
              </code>
            </pre>
          </div>

          <div className="mb-4">
            <p className="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Response Body:</p>
            <pre className="p-3 bg-gray-50 dark:bg-gray-700 rounded-md overflow-auto max-h-96">
              <code ref={responseBodyRef} className={responseBody.startsWith('{') || responseBody.startsWith('[') ? "language-json" : "language-text"}>
                {responseBody}
              </code>
            </pre>
            <button
              onClick={() => {
                setFullResponseBody(fullResponseBody); // Ensure the latest raw body is set
                setShowFullResponseModal(true);
              }}
              className="mt-2 text-blue-600 hover:underline text-sm"
            >
              View Full Raw Response
            </button>
          </div>

          <div className="flex flex-col sm:flex-row gap-4">
            <button
              onClick={shareResponse}
              className="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-md transition-colors duration-200 shadow-md"
              disabled={loading}
            >
              Share Response
            </button>
            {shareLink && (
              <button
                onClick={copyShareLink}
                className="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-md transition-colors duration-200 shadow-md"
              >
                Copy Share Link
              </button>
            )}
          </div>
          {shareLink && (
            <p className="mt-4 text-sm text-gray-600 dark:text-gray-400 break-all">
              Shareable Link: <a href={shareLink} target="_blank" rel="noopener noreferrer" className="text-blue-500 hover:underline">{shareLink}</a>
            </p>
          )}
        </div>
      )}

      <Modal isOpen={showFullResponseModal} onClose={() => setShowFullResponseModal(false)} title="Full Raw Response">
        <pre className="p-3 bg-gray-100 dark:bg-gray-700 rounded-md overflow-auto max-h-[70vh] text-sm font-mono text-gray-900 dark:text-white">
          {fullResponseBody}
        </pre>
      </Modal>
    </div>
  );
};

// Profile Page Component
const ProfilePage = ({ user, showMessage, logActivity, userId }) => {
  const [displayName, setDisplayName] = useState(user?.displayName || '');
  const [newPassword, setNewPassword] = useState('');
  const [currentPassword, setCurrentPassword] = useState('');
  const [loading, setLoading] = useState(false);
  const [activityHistory, setActivityHistory] = useState([]);

  useEffect(() => {
    if (!user) return;

    const historyRef = collection(db, `artifacts/${appId}/users/${userId}/activityHistory`);
    // Note: We are not using orderBy here to avoid index issues, sorting will be done in memory.
    const unsubscribe = onSnapshot(historyRef, (snapshot) => {
      const history = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      // Sort by timestamp in descending order in memory
      history.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));
      setActivityHistory(history);
    }, (error) => {
      console.error("Error fetching activity history:", error);
      showMessage(`Error loading activity history: ${error.message}`, 'error');
    });

    return () => unsubscribe();
  }, [user, showMessage, userId]);

  const handleUpdateProfile = async (e) => {
    e.preventDefault();
    setLoading(true);
    try {
      if (auth.currentUser) {
        await updateProfile(auth.currentUser, { displayName });
        showMessage('Profile updated successfully!', 'success');
        await logActivity('Profile Updated', { newDisplayName: displayName });
      }
    } catch (error) {
      showMessage(`Error updating profile: ${error.message}`, 'error');
    } finally {
      setLoading(false);
    }
  };

  const handleChangePassword = async (e) => {
    e.preventDefault();
    setLoading(true);
    try {
      if (auth.currentUser && currentPassword && newPassword) {
        const credential = EmailAuthProvider.credential(auth.currentUser.email, currentPassword);
        await reauthenticateWithCredential(auth.currentUser, credential);
        await updatePassword(auth.currentUser, newPassword);
        showMessage('Password changed successfully! You might need to log in again.', 'success');
        setNewPassword('');
        setCurrentPassword('');
        await logActivity('Password Changed');
      } else {
        showMessage('Please enter both current and new passwords.', 'warning');
      }
    } catch (error) {
      showMessage(`Error changing password: ${error.message}`, 'error');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="p-6 bg-gray-100 dark:bg-gray-900 min-h-screen text-gray-900 dark:text-white">
      <h2 className="text-3xl font-bold mb-6 text-center">User Profile</h2>

      <div className="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-6">
        <h3 className="text-xl font-bold mb-4">Account Information</h3>
        <p className="mb-2"><span className="font-semibold">Email:</span> {user?.email}</p>
        <p className="mb-2"><span className="font-semibold">Display Name:</span> {user?.displayName || 'N/A'}</p>
        <p className="mb-2"><span className="font-semibold">Account Created:</span> {formatDate(user?.metadata?.creationTime)}</p>
        <p className="mb-2"><span className="font-semibold">Last Login:</span> {formatDate(user?.metadata?.lastSignInTime)}</p>
        <p className="mb-2"><span className="font-semibold">User ID:</span> {userId}</p>
      </div>

      <div className="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-6">
        <h3 className="text-xl font-bold mb-4">Edit Profile</h3>
        <form onSubmit={handleUpdateProfile} className="space-y-4">
          <div>
            <label htmlFor="editDisplayName" className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Display Name</label>
            <input
              type="text"
              id="editDisplayName"
              className="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white"
              value={displayName}
              onChange={(e) => setDisplayName(e.target.value)}
            />
          </div>
          <button
            type="submit"
            className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-md transition-colors duration-200 shadow-md"
            disabled={loading}
          >
            {loading ? <LoadingSpinner /> : 'Update Profile'}
          </button>
        </form>
      </div>

      <div className="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-6">
        <h3 className="text-xl font-bold mb-4">Change Password</h3>
        <form onSubmit={handleChangePassword} className="space-y-4">
          <div>
            <label htmlFor="currentPassword" className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Current Password</label>
            <input
              type="password"
              id="currentPassword"
              className="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white"
              value={currentPassword}
              onChange={(e) => setCurrentPassword(e.target.value)}
              required
            />
          </div>
          <div>
            <label htmlFor="newPassword" className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">New Password</label>
            <input
              type="password"
              id="newPassword"
              className="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md focus:ring-blue-500 focus:border-blue-500 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white"
              value={newPassword}
              onChange={(e) => setNewPassword(e.target.value)}
              required
            />
          </div>
          <button
            type="submit"
            className="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-md transition-colors duration-200 shadow-md"
            disabled={loading}
          >
            {loading ? <LoadingSpinner /> : 'Change Password'}
          </button>
        </form>
      </div>

      <div className="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
        <h3 className="text-xl font-bold mb-4">Activity History</h3>
        {activityHistory.length === 0 ? (
          <p className="text-gray-600 dark:text-gray-400">No activity logged yet.</p>
        ) : (
          <ul className="divide-y divide-gray-200 dark:divide-gray-700">
            {activityHistory.map((activity) => (
              <li key={activity.id} className="py-3">
                <p className="text-sm font-semibold text-gray-800 dark:text-gray-200">{activity.type}</p>
                <p className="text-xs text-gray-500 dark:text-gray-400">{formatDate(activity.timestamp)}</p>
                {activity.url && <p className="text-sm text-gray-700 dark:text-gray-300">URL: <span className="font-mono">{activity.url}</span></p>}
                {activity.method && <p className="text-sm text-gray-700 dark:text-gray-300">Method: {activity.method}</p>}
                {activity.status && <p className="text-sm text-gray-700 dark:text-gray-300">Status: {activity.status}</p>}
                {activity.newDisplayName && <p className="text-sm text-gray-700 dark:text-gray-300">New Display Name: {activity.newDisplayName}</p>}
                {activity.shareLink && (
                  <p className="text-sm text-blue-500 mt-1">
                    <a href={activity.shareLink} target="_blank" rel="noopener noreferrer" className="hover:underline">
                      View Shared Response
                    </a>
                  </p>
                )}
                {activity.error && <p className="text-sm text-red-500">Error: {activity.error}</p>}
              </li>
            ))}
          </ul>
        )}
      </div>
    </div>
  );
};

// Shared Response Viewer Component
const SharedResponseViewer = ({ responseId, showMessage }) => {
  const [response, setResponse] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);

  const responseBodyRef = useRef(null);
  const responseHeadersRef = useRef(null);

  const applySyntaxHighlighting = useCallback(() => {
    if (window.Prism && response) {
      if (responseBodyRef.current) {
        window.Prism.highlightElement(responseBodyRef.current);
      }
      if (responseHeadersRef.current) {
        window.Prism.highlightElement(responseHeadersRef.current);
      }
    }
  }, [response]);

  useEffect(() => {
    const fetchSharedResponse = async () => {
      setLoading(true);
      setError(null);
      try {
        const docRef = doc(db, `sharedResponses`, responseId);
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
          const data = docSnap.data();
          setResponse(data);
          showMessage('Shared response loaded.', 'success');
        } else {
          setError('Response not found or invalid link.');
          showMessage('Response not found or invalid link.', 'error');
        }
      } catch (e) {
        setError(`Error loading response: ${e.message}`);
        showMessage(`Error loading response: ${e.message}`, 'error');
      } finally {
        setLoading(false);
      }
    };

    if (responseId) {
      fetchSharedResponse();
    }
  }, [responseId, showMessage]);

  useEffect(() => {
    if (response) {
      applySyntaxHighlighting();
    }
  }, [response, applySyntaxHighlighting]);

  const getStatusCodeColor = (status) => {
    if (!status) return 'text-gray-500';
    if (status >= 200 && status < 300) return 'text-green-500';
    if (status >= 300 && status < 400) return 'text-yellow-500';
    return 'text-red-500';
  };

  if (loading) return <LoadingSpinner />;
  if (error) return <div className="p-6 text-red-500 text-center">{error}</div>;
  if (!response) return <div className="p-6 text-gray-600 text-center">No response to display.</div>;

  let formattedBody = response.responseBody;
  try {
    formattedBody = JSON.stringify(JSON.parse(response.responseBody), null, 2);
  } catch (e) {
    // Not JSON, keep as is
  }

  return (
    <div className="p-6 bg-gray-100 dark:bg-gray-900 min-h-screen text-gray-900 dark:text-white">
      <h2 className="text-3xl font-bold mb-6 text-center">Shared API Response</h2>

      <div className="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-6">
        <h3 className="text-xl font-bold mb-4">Request Details</h3>
        <p className="mb-2"><span className="font-semibold">URL:</span> <span className="font-mono">{response.url}</span></p>
        <p className="mb-2"><span className="font-semibold">Method:</span> {response.method}</p>
        <div className="mb-2">
          <p className="font-semibold">Request Headers:</p>
          <pre className="p-2 bg-gray-50 dark:bg-gray-700 rounded-md overflow-auto max-h-40">
            <code className="language-json text-sm">
              {response.requestHeaders || '{}'}
            </code>
          </pre>
        </div>
        {(response.method !== 'GET' && response.method !== 'HEAD') && (
          <div className="mb-2">
            <p className="font-semibold">Request Body:</p>
            <pre className="p-2 bg-gray-50 dark:bg-gray-700 rounded-md overflow-auto max-h-40">
              <code className={response.requestBody?.startsWith('{') || response.requestBody?.startsWith('[') ? "language-json" : "language-text"}>
                {response.requestBody || ''}
              </code>
            </pre>
          </div>
        )}
        <p className="mb-2"><span className="font-semibold">Shared On:</span> {formatDate(response.timestamp)}</p>
      </div>

      <div className="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
        <h3 className="text-xl font-bold mb-4">Response Details</h3>
        <div className="mb-4">
          <p className="text-sm font-medium text-gray-700 dark:text-gray-300">Status Code:</p>
          <span className={`text-2xl font-bold ${getStatusCodeColor(response.responseStatus)}`}>
            {response.responseStatus}
          </span>
        </div>
        <div className="mb-4">
          <p className="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Headers:</p>
          <pre className="p-3 bg-gray-50 dark:bg-gray-700 rounded-md overflow-auto max-h-60">
            <code ref={responseHeadersRef} className="language-json text-sm">
              {response.responseHeaders}
            </code>
          </pre>
        </div>
        <div className="mb-4">
          <p className="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Response Body:</p>
          <pre className="p-3 bg-gray-50 dark:bg-gray-700 rounded-md overflow-auto max-h-96">
            <code ref={responseBodyRef} className={formattedBody.startsWith('{') || formattedBody.startsWith('[') ? "language-json" : "language-text"}>
              {formattedBody}
            </code>
          </pre>
        </div>
      </div>
    </div>
  );
};

// Main App Component
const App = () => {
  const [user, setUser] = useState(null);
  const [loadingAuth, setLoadingAuth] = useState(true);
  const [currentPage, setCurrentPage] = useState('tester'); // 'tester', 'profile', 'auth', 'shared'
  const [message, setMessage] = useState(null); // { type: 'success'|'error'|'warning', text: '...' }
  const [isDarkTheme, setIsDarkTheme] = useState(false);
  const [currentUserId, setCurrentUserId] = useState(null);

  // Function to show messages
  const showMessage = useCallback((text, type = 'info') => {
    setMessage({ text, type });
    const timer = setTimeout(() => {
      setMessage(null);
    }, 5000); // Message disappears after 5 seconds
    return () => clearTimeout(timer);
  }, []);

  // Function to log activity to Firestore
  const logActivity = useCallback(async (type, details = {}) => {
    if (!user) return; // Only log for authenticated users

    const userId = user.uid;
    const activityData = {
      type,
      timestamp: serverTimestamp(),
      ...details,
    };

    try {
      // Use the correct Firestore path for private user data
      await addDoc(collection(db, `artifacts/${appId}/users/${userId}/activityHistory`), activityData);
    } catch (error) {
      console.error("Error logging activity:", error);
      showMessage(`Failed to log activity: ${error.message}`, 'error');
    }
  }, [user, showMessage]);

  // Handle initial authentication and auth state changes
  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, async (currentUser) => {
      if (currentUser) {
        setUser(currentUser);
        setCurrentUserId(currentUser.uid);
        if (!initialAuthToken) { // Only log if not signing in with custom token (which happens on initial load)
          await logActivity('Logged In', { email: currentUser.email });
        }
        // Check if the current URL is a shared link
        const path = window.location.pathname;
        if (path.startsWith('/share/')) {
          const responseId = path.split('/share/')[1];
          setCurrentPage({ name: 'shared', id: responseId });
        } else {
          setCurrentPage('tester');
        }
      } else {
        setUser(null);
        setCurrentUserId(null); // Clear userId if logged out
        // If not authenticated, check if it's a shared link
        const path = window.location.pathname;
        if (path.startsWith('/share/')) {
          const responseId = path.split('/share/')[1];
          setCurrentPage({ name: 'shared', id: responseId });
        } else {
          setCurrentPage('auth');
        }
      }
      setLoadingAuth(false);
    });

    // Attempt to sign in with custom token if available
    const signInWithToken = async () => {
      if (initialAuthToken) {
        try {
          await signInWithCustomToken(auth, initialAuthToken);
          // onAuthStateChanged will handle setting the user
        } catch (error) {
          console.error("Error signing in with custom token:", error);
          showMessage(`Failed to authenticate with token: ${error.message}`, 'error');
          // Fallback to anonymous or regular auth if custom token fails
          try {
            await signInAnonymously(auth);
            showMessage('Signed in anonymously.', 'info');
          } catch (anonError) {
            console.error("Error signing in anonymously:", anonError);
            showMessage(`Failed to sign in: ${anonError.message}`, 'error');
          }
        }
      } else {
        // If no initial token, try anonymous sign-in
        try {
            await signInAnonymously(auth);
            showMessage('Signed in anonymously.', 'info');
        } catch (anonError) {
            console.error("Error signing in anonymously:", anonError);
            showMessage(`Failed to sign in: ${anonError.message}`, 'error');
        }
      }
    };

    if (loadingAuth) { // Only run this once on initial load
      signInWithToken();
    }

    return () => unsubscribe();
  }, [initialAuthToken, logActivity, loadingAuth, showMessage]); // Only re-run if initialAuthToken changes

  // Handle URL changes for shared links (e.g., if user navigates manually)
  useEffect(() => {
    const handlePopState = () => {
      const path = window.location.pathname;
      if (path.startsWith('/share/')) {
        const responseId = path.split('/share/')[1];
        setCurrentPage({ name: 'shared', id: responseId });
      } else if (user) {
        setCurrentPage('tester');
      } else {
        setCurrentPage('auth');
      }
    };

    window.addEventListener('popstate', handlePopState);
    return () => window.removeEventListener('popstate', handlePopState);
  }, [user]);

  const handleLogout = async () => {
    if (user) {
      await logActivity('Logged Out', { email: user.email });
    }
    await signOut(auth);
    showMessage('Logged out successfully.', 'success');
    setCurrentPage('auth');
  };

  const handleAuthSuccess = () => {
    // onAuthStateChanged listener will handle setting the user and navigating to 'tester'
    // No explicit setCurrentPage('tester') here to avoid race conditions
  };

  const toggleTheme = () => {
    setIsDarkTheme(!isDarkTheme);
    document.documentElement.classList.toggle('dark', !isDarkTheme);
  };

  if (loadingAuth) {
    return (
      <div className="flex justify-center items-center min-h-screen bg-gray-100 dark:bg-gray-900">
        <LoadingSpinner />
        <p className="ml-3 text-gray-700 dark:text-gray-300">Loading authentication...</p>
      </div>
    );
  }

  return (
    <div className={`min-h-screen flex flex-col ${isDarkTheme ? 'dark' : ''}`}>
      {/* Global Message Display */}
      {message && (
        <div
          className={`fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 transition-transform transform ${
            message.type === 'success' ? 'bg-green-500' :
            message.type === 'error' ? 'bg-red-500' :
            'bg-blue-500'
          } text-white`}
        >
          {message.text}
        </div>
      )}

      {/* Navigation */}
      {user && (currentPage.name !== 'shared' || user) && ( // Show nav if logged in or viewing shared link while logged in
        <nav className="bg-gray-800 dark:bg-gray-950 p-4 shadow-md flex justify-between items-center">
          <div className="flex items-center space-x-4">
            <h1 className="text-white text-xl font-bold">Request Analyzer</h1>
            <button
              onClick={() => setCurrentPage('tester')}
              className={`px-3 py-2 rounded-md transition-colors duration-200 ${
                currentPage === 'tester' ? 'bg-blue-600 text-white' : 'text-gray-300 hover:bg-gray-700 hover:text-white'
              }`}
            >
              Tester
            </button>
            <button
              onClick={() => setCurrentPage('profile')}
              className={`px-3 py-2 rounded-md transition-colors duration-200 ${
                currentPage === 'profile' ? 'bg-blue-600 text-white' : 'text-gray-300 hover:bg-gray-700 hover:text-white'
              }`}
            >
              Profile
            </button>
          </div>
          <div className="flex items-center space-x-4">
            <button
              onClick={toggleTheme}
              className="p-2 rounded-full bg-gray-700 dark:bg-gray-800 text-gray-300 hover:text-white hover:bg-gray-600 dark:hover:bg-gray-700 transition-colors"
              aria-label="Toggle dark mode"
            >
              {isDarkTheme ? (
                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.325 3.325l-.707.707M5.38 5.38l-.707-.707M18.615 5.38l.707-.707M5.38 18.615l-.707.707M12 7a5 5 0 100 10 5 5 0 000-10z"></path></svg>
              ) : (
                <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9 9 0 008.354-5.646z"></path></svg>
              )}
            </button>
            <span className="text-gray-300 text-sm hidden md:block">
              Welcome, {user?.displayName || user?.email || 'Guest'}
            </span>
            <button
              onClick={handleLogout}
              className="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md transition-colors duration-200"
            >
              Logout
            </button>
          </div>
        </nav>
      )}

      {/* Main Content Area */}
      <main className="flex-1">
        {currentPage === 'auth' && <AuthPage onAuthSuccess={handleAuthSuccess} showMessage={showMessage} />}
        {currentPage === 'tester' && user && <RequestTester user={user} showMessage={showMessage} logActivity={logActivity} />}
        {currentPage === 'profile' && user && <ProfilePage user={user} showMessage={showMessage} logActivity={logActivity} userId={currentUserId} />}
        {currentPage.name === 'shared' && <SharedResponseViewer responseId={currentPage.id} showMessage={showMessage} />}
      </main>
    </div>
  );
};

export default App;
