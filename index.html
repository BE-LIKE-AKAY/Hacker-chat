<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hacker Chat</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Google Fonts - Space Mono for hacker theme -->
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Custom Scrollbar Styles for a hacker look */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1a202c; /* gray-900 */
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #065F46; /* green-800 */
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #047857; /* green-700 */
        }

        /* Basic body styling for font and background */
        body {
            font-family: 'Space Mono', monospace;
            background-color: #0d1117; /* Even darker background */
            color: #00ff00; /* Neon green text */
            overflow: hidden; /* Prevent body scroll */
        }

        /* Modal backdrop */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.75);
        }

        /* Hacker-style input focus */
        input:focus, textarea:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(0, 255, 0, 0.5); /* Neon green glow */
        }

        /* Button hover effects */
        button {
            transition: all 0.3s ease-in-out;
        }
        button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.4);
        }

        /* Loader */
        .loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loader {
            border: 4px solid #1a202c; /* Dark background for loader border */
            border-top: 4px solid #00ff00; /* Neon green for spinning part */
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="flex h-screen bg-gray-950 text-green-400 font-mono overflow-hidden">

    <!-- Authentication Container (Initially shown) -->
    <div id="authContainer" class="flex flex-col items-center justify-center min-h-screen w-full p-4">
        <div class="bg-gray-900 p-8 rounded-lg border-2 border-green-700 shadow-xl shadow-green-500/30 w-full max-w-md">
            <h1 class="text-3xl font-bold text-green-300 mb-6 text-center animate-pulse">
                <span class="text-green-500">_</span>HackerChat Access
            </h1>

            <!-- Login Form -->
            <div id="loginForm" class="auth-form">
                <h2 class="text-xl font-semibold mb-4 text-green-300 border-b border-green-800 pb-2">Login</h2>
                <div class="mb-4">
                    <label for="loginEmail" class="block text-green-400 text-sm mb-2">Email:</label>
                    <input type="email" id="loginEmail" class="w-full p-2 rounded-md bg-gray-800 border border-green-700 text-white placeholder-gray-500 focus:outline-none focus:ring-1 focus:ring-green-500" placeholder="user@example.com">
                </div>
                <div class="mb-6">
                    <label for="loginPassword" class="block text-green-400 text-sm mb-2">Password:</label>
                    <input type="password" id="loginPassword" class="w-full p-2 rounded-md bg-gray-800 border border-green-700 text-white placeholder-gray-500 focus:outline-none focus:ring-1 focus:ring-green-500" placeholder="********">
                </div>
                <button id="loginButton" class="w-full py-2 px-4 bg-green-700 hover:bg-green-600 rounded-lg text-white font-bold transition-colors">
                    [LOGIN]
                </button>
                <p id="loginError" class="text-red-500 text-sm mt-2 text-center hidden"></p>
                <div class="flex justify-between items-center mt-4 text-sm">
                    <button id="showSignupButton" class="text-green-400 hover:text-green-300">[CREATE ACCOUNT]</button>
                    <button id="showForgotPasswordButton" class="text-gray-500 hover:text-gray-400">[FORGOT PASSWORD?]</button>
                </div>
            </div>

            <!-- Signup Form (Hidden by default) -->
            <div id="signupForm" class="auth-form hidden">
                <h2 class="text-xl font-semibold mb-4 text-green-300 border-b border-green-800 pb-2">Create Account</h2>
                <div class="mb-3">
                    <label for="signupName" class="block text-green-400 text-sm mb-1">Display Name:</label>
                    <input type="text" id="signupName" class="w-full p-2 rounded-md bg-gray-800 border border-green-700 text-white placeholder-gray-500 focus:outline-none focus:ring-1 focus:ring-green-500" placeholder="Your Hacker Alias">
                </div>
                <div class="mb-3">
                    <label for="signupUsername" class="block text-green-400 text-sm mb-1">Username (Unique):</label>
                    <input type="text" id="signupUsername" class="w-full p-2 rounded-md bg-gray-800 border border-green-700 text-white placeholder-gray-500 focus:outline-none focus:ring-1 focus:ring-green-500" placeholder="unique_hacker_tag">
                </div>
                <div class="mb-3">
                    <label for="signupEmail" class="block text-green-400 text-sm mb-1">Email:</label>
                    <input type="email" id="signupEmail" class="w-full p-2 rounded-md bg-gray-800 border border-green-700 text-white placeholder-gray-500 focus:outline-none focus:ring-1 focus:ring-green-500" placeholder="newuser@example.com">
                </div>
                <div class="mb-3">
                    <label for="signupPassword" class="block text-green-400 text-sm mb-1">Password:</label>
                    <input type="password" id="signupPassword" class="w-full p-2 rounded-md bg-gray-800 border border-green-700 text-white placeholder-gray-500 focus:outline-none focus:ring-1 focus:ring-green-500" placeholder="********">
                </div>
                <div class="mb-3">
                    <label for="signupMobile" class="block text-green-400 text-sm mb-1">Mobile (Optional):</label>
                    <input type="tel" id="signupMobile" class="w-full p-2 rounded-md bg-gray-800 border border-green-700 text-white placeholder-gray-500 focus:outline-none focus:ring-1 focus:ring-green-500" placeholder="+1234567890">
                </div>
                <div class="mb-3">
                    <label for="signupDOB" class="block text-green-400 text-sm mb-1">Date of Birth (Optional):</label>
                    <input type="date" id="signupDOB" class="w-full p-2 rounded-md bg-gray-800 border border-green-700 text-white focus:outline-none focus:ring-1 focus:ring-green-500">
                </div>
                <div class="mb-3">
                    <label for="signupGender" class="block text-green-400 text-sm mb-1">Gender (Optional):</label>
                    <select id="signupGender" class="w-full p-2 rounded-md bg-gray-800 border border-green-700 text-white focus:outline-none focus:ring-1 focus:ring-green-500">
                        <option value="">Select</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="other">Other</option>
                        <option value="prefer_not_say">Prefer not to say</option>
                    </select>
                </div>
                <button id="signupButton" class="w-full py-2 px-4 bg-green-700 hover:bg-green-600 rounded-lg text-white font-bold transition-colors">
                    [SIGN UP]
                </button>
                <p id="signupError" class="text-red-500 text-sm mt-2 text-center hidden"></p>
                <button id="backToLoginFromSignup" class="w-full text-gray-500 hover:text-gray-400 mt-4">[BACK TO LOGIN]</button>
            </div>

            <!-- Forgot Password Form (Hidden by default) -->
            <div id="forgotPasswordForm" class="auth-form hidden">
                <h2 class="text-xl font-semibold mb-4 text-green-300 border-b border-green-800 pb-2">Forgot Password</h2>
                <div class="mb-6">
                    <label for="forgotEmail" class="block text-green-400 text-sm mb-2">Enter your email:</label>
                    <input type="email" id="forgotEmail" class="w-full p-2 rounded-md bg-gray-800 border border-green-700 text-white placeholder-gray-500 focus:outline-none focus:ring-1 focus:ring-green-500" placeholder="your_email@example.com">
                </div>
                <button id="resetPasswordButton" class="w-full py-2 px-4 bg-green-700 hover:bg-green-600 rounded-lg text-white font-bold transition-colors">
                    [RESET PASSWORD]
                </button>
                <p id="forgotPasswordMessage" class="text-green-500 text-sm mt-2 text-center hidden"></p>
                <p id="forgotPasswordError" class="text-red-500 text-sm mt-2 text-center hidden"></p>
                <button id="backToLoginFromForgot" class="w-full text-gray-500 hover:text-gray-400 mt-4">[BACK TO LOGIN]</button>
            </div>

        </div>
    </div>

    <!-- Main Chat Application (Hidden initially, shown after authentication) -->
    <div id="mainChatApp" class="hidden flex-grow flex h-screen w-full">
        <!-- Sidebar - Chat Rooms & Online Users -->
        <div class="w-1/4 bg-gray-900 border-r-2 border-green-700 p-4 flex flex-col shadow-lg shadow-green-500/20">
            <div class="flex items-center justify-between mb-6 pb-4 border-b-2 border-green-700">
                <h1 class="text-2xl font-bold text-green-300 animate-pulse">
                    <span class="text-green-500">_</span>HackerChat
                </h1>
                <button id="profileButton" class="p-2 rounded-full bg-green-700 hover:bg-green-600 transition-all duration-300 transform hover:scale-105 shadow-md shadow-green-500/30" title="Update Profile">
                    <img id="profilePicDisplay" src="https://placehold.co/40x40/00FF00/000000?text=U" alt="Profile" class="w-8 h-8 rounded-full border-2 border-green-400 object-cover">
                </button>
            </div>

            <!-- User ID Display -->
            <div class="mb-4 text-sm text-gray-400 break-words">
                <span class="text-green-500">User ID:</span> <span id="currentUserId">Loading...</span>
            </div>

            <!-- Chat Rooms -->
            <h2 class="text-xl font-semibold mb-3 text-green-300 border-b border-green-800 pb-2">
                <span class="text-green-500">_</span>Rooms
            </h2>
            <div id="chatRoomsList" class="flex-grow overflow-y-auto custom-scrollbar pr-2">
                <!-- Chat rooms will be dynamically loaded here -->
            </div>
            <button id="createRoomButton" class="mt-4 w-full py-2 px-4 bg-green-700 hover:bg-green-600 rounded-lg transition-all duration-300 transform hover:scale-105 shadow-md shadow-green-500/30 text-white font-bold">
                [CREATE NEW ROOM]
            </button>

            <!-- Friends List -->
            <h2 class="text-xl font-semibold mt-6 mb-3 text-green-300 border-b border-green-800 pb-2">
                <span class="text-green-500">_</span>Friends (<span id="friendsCount">0</span>)
            </h2>
            <div id="friendsList" class="overflow-y-auto custom-scrollbar pr-2 h-40">
                <!-- Friends will be dynamically loaded here -->
            </div>
            <button id="findFriendsButton" class="mt-4 w-full py-2 px-4 bg-blue-700 hover:bg-blue-600 rounded-lg transition-all duration-300 transform hover:scale-105 shadow-md shadow-blue-500/30 text-white font-bold">
                [FIND FRIENDS]
            </button>

            <!-- Friend Requests -->
            <h2 class="text-xl font-semibold mt-6 mb-3 text-green-300 border-b border-green-800 pb-2">
                <span class="text-green-500">_</span>Friend Requests (<span id="friendRequestsCount">0</span>)
            </h2>
            <div id="friendRequestsList" class="overflow-y-auto custom-scrollbar pr-2 h-40">
                <!-- Friend requests will be dynamically loaded here -->
            </div>

            <button id="logoutButton" class="mt-4 w-full py-2 px-4 bg-red-700 hover:bg-red-600 rounded-lg transition-all duration-300 transform hover:scale-105 shadow-md shadow-red-500/30 text-white font-bold">
                [LOGOUT]
            </button>
        </div>

        <!-- Main Chat Area -->
        <div class="flex-grow flex flex-col bg-gray-950 p-6 shadow-xl shadow-green-500/10 relative">
            <div id="chatAreaContent" class="flex-grow flex flex-col">
                <div class="flex flex-col items-center justify-center flex-grow text-gray-500 text-2xl">
                    <span class="text-green-500 text-4xl mb-4 animate-pulse">_</span>
                    Select a room or a friend to start chatting.
                </div>
            </div>

            <!-- Message Input (hidden by default, shown when room or DM is selected) -->
            <div id="messageInputArea" class="hidden items-center border-t-2 border-green-700 pt-4">
                <input
                    type="text"
                    id="newMessageInput"
                    placeholder="Type your encrypted message..."
                    class="flex-grow p-3 rounded-lg bg-gray-800 border-2 border-green-700 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-green-500 transition-all duration-300 shadow-inner shadow-green-500/20"
                />
                <button id="sendMessageButton" class="ml-4 py-3 px-6 bg-green-700 hover:bg-green-600 rounded-lg transition-all duration-300 transform hover:scale-105 shadow-md shadow-green-500/30 text-white font-bold">
                    [SEND]
                </button>
            </div>
        </div>
    </div>

    <!-- Profile View (Full-screen, hidden by default) -->
    <div id="profileView" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-50 p-4">
        <div class="bg-gray-900 p-8 rounded-lg border-2 border-green-700 shadow-xl shadow-green-500/30 w-full max-w-2xl h-full max-h-[90vh] overflow-y-auto custom-scrollbar flex flex-col">
            <div class="flex justify-between items-center mb-6 pb-4 border-b-2 border-green-700">
                <h3 class="text-2xl font-bold text-green-300">
                    <span class="text-green-500">_</span>User Profile
                </h3>
                <button id="backToChatFromProfile" class="py-2 px-4 bg-gray-700 hover:bg-gray-600 rounded-lg text-white transition-colors">
                    [BACK TO CHAT]
                </button>
            </div>

            <div class="flex flex-col md:flex-row items-center md:items-start mb-6">
                <div class="text-center md:mr-8 mb-4 md:mb-0">
                    <img id="profilePicInputDisplay" src="https://placehold.co/120x120/00FF00/000000?text=U" alt="Profile" class="w-32 h-32 rounded-full border-4 border-green-500 object-cover mx-auto mb-4">
                    <label for="profilePicUrlInput" class="block text-green-400 text-sm mb-2">Profile Picture URL:</label>
                    <input
                        type="text"
                        id="profilePicUrlInput"
                        placeholder="https://example.com/your-pic.jpg"
                        class="w-full p-2 rounded-md bg-gray-800 border border-green-700 text-white focus:outline-none focus:ring-1 focus:ring-green-500"
                    />
                    <p class="text-xs text-gray-500 mt-1">
                        (Direct image upload not supported. Provide a URL.)
                    </p>
                </div>

                <div class="flex-grow w-full">
                    <div class="mb-4">
                        <label for="profileNameInput" class="block text-green-400 text-sm mb-2">Display Name:</label>
                        <input
                            type="text"
                            id="profileNameInput"
                            class="w-full p-2 rounded-md bg-gray-800 border border-green-700 text-white focus:outline-none focus:ring-1 focus:ring-green-500"
                        />
                    </div>
                    <div class="mb-4">
                        <label for="profileUsernameDisplay" class="block text-green-400 text-sm mb-2">Username:</label>
                        <input
                            type="text"
                            id="profileUsernameDisplay"
                            class="w-full p-2 rounded-md bg-gray-800 border border-green-700 text-white cursor-not-allowed"
                            disabled
                        />
                        <p class="text-xs text-gray-500 mt-1">Username cannot be changed.</p>
                    </div>
                    <div class="mb-4">
                        <label for="profileEmailDisplay" class="block text-green-400 text-sm mb-2">Email:</label>
                        <input
                            type="email"
                            id="profileEmailDisplay"
                            class="w-full p-2 rounded-md bg-gray-800 border border-green-700 text-white cursor-not-allowed"
                            disabled
                        />
                    </div>
                    <div class="mb-4">
                        <label for="profileMobileInput" class="block text-green-400 text-sm mb-2">Mobile:</label>
                        <input
                            type="tel"
                            id="profileMobileInput"
                            class="w-full p-2 rounded-md bg-gray-800 border border-green-700 text-white focus:outline-none focus:ring-1 focus:ring-green-500"
                        />
                    </div>
                    <div class="mb-4">
                        <label for="profileDOBInput" class="block text-green-400 text-sm mb-2">Date of Birth:</label>
                        <input
                            type="date"
                            id="profileDOBInput"
                            class="w-full p-2 rounded-md bg-gray-800 border border-green-700 text-white focus:outline-none focus:ring-1 focus:ring-green-500"
                        />
                    </div>
                    <div class="mb-6">
                        <label for="profileGenderSelect" class="block text-green-400 text-sm mb-2">Gender:</label>
                        <select id="profileGenderSelect" class="w-full p-2 rounded-md bg-gray-800 border border-green-700 text-white focus:outline-none focus:ring-1 focus:ring-green-500">
                            <option value="">Select</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                            <option value="other">Other</option>
                            <option value="prefer_not_say">Prefer not to say</option>
                        </select>
                    </div>
                    <button id="saveProfileUpdate" class="w-full py-2 px-4 bg-green-700 hover:bg-green-600 rounded-lg text-white font-bold transition-colors">
                        [UPDATE PROFILE]
                    </button>
                </div>
            </div>

            <!-- My Room Activity Section (Moved here) -->
            <h2 class="text-xl font-semibold mt-6 mb-3 text-green-300 border-b border-green-800 pb-2">
                <span class="text-green-500">_</span>My Room Activity
            </h2>
            <div id="userRoomActivity" class="overflow-y-auto custom-scrollbar pr-2 flex-grow">
                <!-- User room activity will be dynamically loaded here -->
            </div>
        </div>
    </div>

    <!-- Create Room Modal -->
    <div id="createRoomModal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-50">
        <div class="bg-gray-900 p-8 rounded-lg border-2 border-green-700 shadow-xl shadow-green-500/30 w-96">
            <h3 class="text-2xl font-bold text-green-300 mb-6 border-b border-green-800 pb-2">
                <span class="text-green-500">_</span>Create New Room
            </h3>
            <div class="mb-4">
                <label for="newRoomNameInput" class="block text-green-400 text-sm mb-2">Room Name:</label>
                <input
                    type="text"
                    id="newRoomNameInput"
                    class="w-full p-2 rounded-md bg-gray-800 border border-green-700 text-white focus:outline-none focus:ring-1 focus:ring-green-500"
                    placeholder="e.g., 'DarkWeb Alley'"
                />
            </div>
            <div class="flex justify-end">
                <button id="cancelCreateRoom" class="py-2 px-4 bg-gray-700 hover:bg-gray-600 rounded-lg text-white mr-2 transition-colors">
                    [CANCEL]
                </button>
                <button id="confirmCreateRoom" class="py-2 px-4 bg-green-700 hover:bg-green-600 rounded-lg text-white font-bold transition-colors">
                    [CREATE]
                </button>
            </div>
        </div>
    </div>

    <!-- Invite User to Room Modal -->
    <div id="inviteUserModal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-50">
        <div class="bg-gray-900 p-8 rounded-lg border-2 border-green-700 shadow-xl shadow-green-500/30 w-96">
            <h3 class="text-2xl font-bold text-green-300 mb-6 border-b border-green-800 pb-2">
                <span class="text-green-500">_</span>Invite User
            </h3>
            <div class="mb-4">
                <label for="inviteUsernameInput" class="block text-green-400 text-sm mb-2">Username:</label>
                <input
                    type="text"
                    id="inviteUsernameInput"
                    class="w-full p-2 rounded-md bg-gray-800 border border-green-700 text-white focus:outline-none focus:ring-1 focus:ring-green-500"
                    placeholder="Enter username to invite"
                />
            </div>
            <p id="inviteUserMessage" class="text-red-500 text-sm mt-2 text-center hidden"></p>
            <div class="flex justify-end mt-4">
                <button id="cancelInviteUser" class="py-2 px-4 bg-gray-700 hover:bg-gray-600 rounded-lg text-white mr-2 transition-colors">
                    [CANCEL]
                </button>
                <button id="confirmInviteUser" class="py-2 px-4 bg-green-700 hover:bg-green-600 rounded-lg text-white font-bold transition-colors">
                    [INVITE]
                </button>
            </div>
        </div>
    </div>

    <!-- Find Friends Modal -->
    <div id="findFriendsModal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-50">
        <div class="bg-gray-900 p-8 rounded-lg border-2 border-green-700 shadow-xl shadow-green-500/30 w-96">
            <h3 class="text-2xl font-bold text-green-300 mb-6 border-b border-green-800 pb-2">
                <span class="text-green-500">_</span>Find Friends
            </h3>
            <div class="mb-4">
                <label for="searchUsernameInput" class="block text-green-400 text-sm mb-2">Search Username:</label>
                <input
                    type="text"
                    id="searchUsernameInput"
                    class="w-full p-2 rounded-md bg-gray-800 border border-green-700 text-white focus:outline-none focus:ring-1 focus:ring-green-500"
                    placeholder="Enter username"
                />
            </div>
            <button id="searchUsersButton" class="w-full py-2 px-4 bg-blue-700 hover:bg-blue-600 rounded-lg text-white font-bold transition-colors mb-4">
                [SEARCH]
            </button>
            <div id="searchResults" class="max-h-60 overflow-y-auto custom-scrollbar pr-2 border border-gray-700 rounded-md p-2">
                <!-- Search results will appear here -->
                <p class="text-gray-500 text-sm">No results.</p>
            </div>
            <p id="findFriendsMessage" class="text-red-500 text-sm mt-2 text-center hidden"></p>
            <div class="flex justify-end mt-4">
                <button id="cancelFindFriends" class="py-2 px-4 bg-gray-700 hover:bg-gray-600 rounded-lg text-white transition-colors">
                    [CLOSE]
                </button>
            </div>
        </div>
    </div>

    <!-- User Profile Details Modal (from search results) -->
    <div id="userProfileDetailsModal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-50">
        <div class="bg-gray-900 p-8 rounded-lg border-2 border-green-700 shadow-xl shadow-green-500/30 w-96">
            <h3 class="text-2xl font-bold text-green-300 mb-6 border-b border-green-800 pb-2">
                <span class="text-green-500">_</span>User Details
            </h3>
            <div class="text-center mb-4">
                <img id="modalProfilePic" src="https://placehold.co/80x80/00FF00/000000?text=U" alt="Profile" class="w-20 h-20 rounded-full border-2 border-green-400 object-cover mx-auto mb-2">
                <p id="modalDisplayName" class="text-xl font-bold text-green-300"></p>
                <p id="modalUsername" class="text-gray-400 text-sm"></p>
            </div>
            <div class="text-sm text-green-400 space-y-2 mb-6">
                <p><strong>Email:</strong> <span id="modalEmail" class="text-white"></span></p>
                <p><strong>Mobile:</strong> <span id="modalMobile" class="text-white"></span></p>
                <p><strong>DOB:</strong> <span id="modalDOB" class="text-white"></span></p>
                <p><strong>Gender:</strong> <span id="modalGender" class="text-white"></span></p>
            </div>
            <button id="sendFriendRequestButton" class="w-full py-2 px-4 bg-green-700 hover:bg-green-600 rounded-lg text-white font-bold transition-colors">
                [SEND FRIEND REQUEST]
            </button>
            <p id="userProfileDetailsMessage" class="text-red-500 text-sm mt-2 text-center hidden"></p>
            <div class="flex justify-end mt-4">
                <button id="closeUserProfileDetails" class="py-2 px-4 bg-gray-700 hover:bg-gray-600 rounded-lg text-white transition-colors">
                    [CLOSE]
                </button>
            </div>
        </div>
    </div>

    <!-- Generic Message Modal -->
    <div id="messageModal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-50">
        <div class="bg-gray-900 p-8 rounded-lg border-2 border-green-700 shadow-xl shadow-green-500/30 w-96">
            <h3 id="messageModalTitle" class="text-2xl font-bold text-green-300 mb-4 border-b border-green-800 pb-2"></h3>
            <p id="messageModalBody" class="text-white mb-6"></p>
            <button id="messageModalClose" class="w-full py-2 px-4 bg-green-700 hover:bg-green-600 rounded-lg text-white font-bold transition-colors">
                [OK]
            </button>
        </div>
    </div>

    <!-- Loader overlay -->
    <div id="loader-overlay" class="loader-overlay hidden">
        <div class="loader"></div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, updateProfile, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, onSnapshot, collection, query, where, serverTimestamp, getDocs, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Configuration (from your provided details)
        const appId = "1:72618637937:web:e89cca640172708f23f9d0";
        const firebaseConfig = {
            apiKey: "AIzaSyB_Q5EseET7WykS4WcIQs1Y7a-CMmcbnp8",
            authDomain: "aapurti-9e385.firebaseapp.com",
            databaseURL: "https://aapurti-9e385-default-rtdb.firebaseio.com",
            projectId: "aapurti-9e385",
            storageBucket: "aapurti-9e385.appspot.com",
            messagingSenderId: "72618637937",
            appId: "1:72618637937:web:e89cca640172708f23f9d0",
            measurementId: "G-4C479V87YN"
        };

        let app;
        let db;
        let auth;
        let currentUserId = null;
        let currentUserProfile = null;
        let selectedChat = null; // Can be a room or a direct message
        let selectedChatType = null; // 'room' or 'direct'
        let onlineUsers = [];
        let allUsers = []; // All registered users for search
        let chatRooms = []; // Keep track of rooms globally for activity rendering
        let userRoomActivityData = [];
        let friendRequestsReceived = []; // Current user's received friend requests
        let friendsList = []; // Current user's friends list

        // Unsubscribe functions for real-time listeners
        let unsubscribeMessages = null;
        let unsubscribeOnlineUsers = null;
        let unsubscribeChatRooms = null;
        let unsubscribeUserRoomActivity = null;
        let unsubscribeFriends = null;
        let unsubscribeFriendRequests = null;
        let unsubscribeAllUsers = null; // For search feature

        // DOM Elements
        const authContainer = document.getElementById('authContainer');
        const mainChatApp = document.getElementById('mainChatApp');
        const profileView = document.getElementById('profileView'); // New profile view

        // Auth Forms
        const loginForm = document.getElementById('loginForm');
        const signupForm = document.getElementById('signupForm');
        const forgotPasswordForm = document.getElementById('forgotPasswordForm');

        // Login Elements
        const loginEmailInput = document.getElementById('loginEmail');
        const loginPasswordInput = document.getElementById('loginPassword');
        const loginButton = document.getElementById('loginButton');
        const loginError = document.getElementById('loginError');
        const showSignupButton = document.getElementById('showSignupButton');
        const showForgotPasswordButton = document.getElementById('showForgotPasswordButton');

        // Signup Elements
        const signupNameInput = document.getElementById('signupName');
        const signupUsernameInput = document.getElementById('signupUsername'); // New username input
        const signupEmailInput = document.getElementById('signupEmail');
        const signupPasswordInput = document.getElementById('signupPassword');
        const signupMobileInput = document.getElementById('signupMobile');
        const signupDOBInput = document.getElementById('signupDOB');
        const signupGenderSelect = document.getElementById('signupGender');
        const signupButton = document.getElementById('signupButton');
        const signupError = document.getElementById('signupError');
        const backToLoginFromSignup = document.getElementById('backToLoginFromSignup');

        // Forgot Password Elements
        const forgotEmailInput = document.getElementById('forgotEmail');
        const resetPasswordButton = document.getElementById('resetPasswordButton');
        const forgotPasswordMessage = document.getElementById('forgotPasswordMessage');
        const forgotPasswordError = document.getElementById('forgotPasswordError');
        const backToLoginFromForgot = document.getElementById('backToLoginFromForgot');

        // Main App Elements
        const currentUserIdSpan = document.getElementById('currentUserId');
        const profileButton = document.getElementById('profileButton');
        const profilePicDisplay = document.getElementById('profilePicDisplay');
        const chatRoomsList = document.getElementById('chatRoomsList');
        const createRoomButton = document.getElementById('createRoomButton');
        const friendsListDiv = document.getElementById('friendsList'); // Renamed for clarity
        const friendsCountSpan = document.getElementById('friendsCount');
        const findFriendsButton = document.getElementById('findFriendsButton'); // New button
        const friendRequestsListDiv = document.getElementById('friendRequestsList'); // New element
        const friendRequestsCountSpan = document.getElementById('friendRequestsCount');
        const chatAreaContent = document.getElementById('chatAreaContent');
        const messageInputArea = document.getElementById('messageInputArea');
        const newMessageInput = document.getElementById('newMessageInput');
        const sendMessageButton = document.getElementById('sendMessageButton');
        const logoutButton = document.getElementById('logoutButton');

        // Profile View Elements
        const profilePicInputDisplay = document.getElementById('profilePicInputDisplay');
        const profileNameInput = document.getElementById('profileNameInput');
        const profileUsernameDisplay = document.getElementById('profileUsernameDisplay'); // Display-only username
        const profileEmailDisplay = document.getElementById('profileEmailDisplay'); // Display-only email
        const profilePicUrlInput = document.getElementById('profilePicUrlInput');
        const profileMobileInput = document.getElementById('profileMobileInput');
        const profileDOBInput = document.getElementById('profileDOBInput');
        const profileGenderSelect = document.getElementById('profileGenderSelect');
        const saveProfileUpdate = document.getElementById('saveProfileUpdate');
        const backToChatFromProfile = document.getElementById('backToChatFromProfile');
        const userRoomActivityDiv = document.getElementById('userRoomActivity'); // Moved here

        // Modals
        const createRoomModal = document.getElementById('createRoomModal');
        const newRoomNameInput = document.getElementById('newRoomNameInput');
        const cancelCreateRoom = document.getElementById('cancelCreateRoom');
        const confirmCreateRoom = document.getElementById('confirmCreateRoom');

        const inviteUserModal = document.getElementById('inviteUserModal'); // New modal
        const inviteUsernameInput = document.getElementById('inviteUsernameInput');
        const inviteUserMessage = document.getElementById('inviteUserMessage');
        const cancelInviteUser = document.getElementById('cancelInviteUser');
        const confirmInviteUser = document.getElementById('confirmInviteUser');

        const findFriendsModal = document.getElementById('findFriendsModal'); // New modal
        const searchUsernameInput = document.getElementById('searchUsernameInput');
        const searchUsersButton = document.getElementById('searchUsersButton');
        const searchResultsDiv = document.getElementById('searchResults');
        const findFriendsMessage = document.getElementById('findFriendsMessage');
        const cancelFindFriends = document.getElementById('cancelFindFriends');

        const userProfileDetailsModal = document.getElementById('userProfileDetailsModal'); // New modal
        const modalProfilePic = document.getElementById('modalProfilePic');
        const modalDisplayName = document.getElementById('modalDisplayName');
        const modalUsername = document.getElementById('modalUsername');
        const modalEmail = document.getElementById('modalEmail');
        const modalMobile = document.getElementById('modalMobile');
        const modalDOB = document.getElementById('modalDOB');
        const modalGender = document.getElementById('modalGender');
        const sendFriendRequestButton = document.getElementById('sendFriendRequestButton');
        const userProfileDetailsMessage = document.getElementById('userProfileDetailsMessage');
        const closeUserProfileDetails = document.getElementById('closeUserProfileDetails');

        const messageModal = document.getElementById('messageModal'); // Generic message modal
        const messageModalTitle = document.getElementById('messageModalTitle');
        const messageModalBody = document.getElementById('messageModalBody');
        const messageModalClose = document.getElementById('messageModalClose');

        // Loader Elements
        const loaderOverlay = document.getElementById('loader-overlay');
        let loaderTimeout = null;
        let loaderStartTime = 0;
        const MIN_LOADER_DISPLAY_TIME = 300; // Minimum time in milliseconds the loader will be displayed

        // --- Utility Functions ---
        function showLoader() {
            loaderOverlay.classList.remove('hidden');
            loaderStartTime = Date.now();
        }

        function hideLoader() {
            const elapsedTime = Date.now() - loaderStartTime;
            if (elapsedTime < MIN_LOADER_DISPLAY_TIME) {
                loaderTimeout = setTimeout(() => {
                    loaderOverlay.classList.add('hidden');
                }, MIN_LOADER_DISPLAY_TIME - elapsedTime);
            } else {
                loaderOverlay.classList.add('hidden');
            }
        }

        function formatTimestamp(timestamp) {
            if (!timestamp) return 'N/A';
            const date = timestamp.toDate();
            return date.toLocaleString();
        }

        function formatDuration(durationMs) {
            if (!durationMs) return '0s';
            const seconds = Math.floor(durationMs / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);

            if (days > 0) return `${days}d ${hours % 24}h`;
            if (hours > 0) return `${hours}h ${minutes % 60}m`;
            if (minutes > 0) return `${minutes}m ${seconds % 60}s`;
            return `${seconds}s`;
        }

        function getUserDisplayName(uid) {
            const user = allUsers.find(u => u.id === uid); // Search all users
            return user?.displayName || `Unknown User (${uid.substring(0, 6)})`;
        }

        function getUserProfilePic(uid) {
            const user = allUsers.find(u => u.id === uid); // Search all users
            return user?.profilePicUrl || `https://placehold.co/40x40/00FF00/000000?text=${uid[0].toUpperCase()}`;
        }

        function scrollToBottom(element) {
            element.scrollTop = element.scrollHeight;
        }

        function showView(viewElement) {
            const views = [authContainer, mainChatApp, profileView];
            views.forEach(view => view.classList.add('hidden'));
            viewElement.classList.remove('hidden');
            if (viewElement === mainChatApp) {
                viewElement.classList.add('flex');
            } else {
                viewElement.classList.remove('flex');
            }
        }

        function showAuthForm(formToShow) {
            loginForm.classList.add('hidden');
            signupForm.classList.add('hidden');
            forgotPasswordForm.classList.add('hidden');
            loginError.classList.add('hidden');
            signupError.classList.add('hidden');
            forgotPasswordMessage.classList.add('hidden');
            forgotPasswordError.classList.add('hidden');

            formToShow.classList.remove('hidden');
        }

        function showModal(modalElement, title = '', body = '') {
            if (title) modalElement.querySelector('h3').textContent = title;
            if (body) modalElement.querySelector('p').textContent = body;
            modalElement.classList.remove('hidden');
        }

        function closeModal(modalElement) {
            modalElement.classList.add('hidden');
        }

        function displayError(element, message) {
            element.textContent = message;
            element.classList.remove('hidden');
        }

        function hideError(element) {
            element.classList.add('hidden');
            element.textContent = '';
        }

        // --- Firebase Initialization and Authentication ---
        async function initializeFirebase() {
            showLoader(); // Show loader on initial Firebase load
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        currentUserIdSpan.textContent = currentUserId;

                        // Set user online status and fetch profile
                        const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, user.uid);
                        const userProfileSnap = await getDoc(userDocRef);

                        if (userProfileSnap.exists()) {
                            currentUserProfile = userProfileSnap.data();
                            await updateDoc(userDocRef, { isOnline: true, lastSeen: serverTimestamp() });
                        } else {
                            // This case should be handled by signup, but as a fallback
                            console.warn("User profile not found after login. Creating a basic one.");
                            currentUserProfile = {
                                displayName: user.displayName || `User-${user.uid.substring(0, 6)}`,
                                username: `user_${user.uid.substring(0, 8)}`, // Fallback username
                                email: user.email,
                                profilePicUrl: user.photoURL || `https://placehold.co/40x40/00FF00/000000?text=${user.displayName ? user.displayName[0].toUpperCase() : 'U'}`,
                                isOnline: true,
                                lastSeen: serverTimestamp(),
                                mobile: null, dob: null, gender: null,
                                friends: [], friendRequestsSent: [], friendRequestsReceived: []
                            };
                            await setDoc(userDocRef, currentUserProfile);
                            // Also add to public usernames collection
                            await setDoc(doc(db, `artifacts/${appId}/public/data/usernames`, currentUserProfile.username.toLowerCase()), { uid: user.uid });
                        }

                        profilePicDisplay.src = currentUserProfile.profilePicUrl;
                        setupListeners(); // Start listening to data once authenticated
                        showView(mainChatApp);
                    } else {
                        // Clear all data and UI if no user
                        currentUserId = null;
                        currentUserProfile = null;
                        selectedChat = null;
                        selectedChatType = null;
                        onlineUsers = [];
                        allUsers = [];
                        chatRooms = [];
                        userRoomActivityData = [];
                        friendRequestsReceived = [];
                        friendsList = [];

                        // Stop all listeners
                        if (unsubscribeMessages) unsubscribeMessages();
                        if (unsubscribeOnlineUsers) unsubscribeOnlineUsers();
                        if (unsubscribeChatRooms) unsubscribeChatRooms();
                        if (unsubscribeUserRoomActivity) unsubscribeUserRoomActivity();
                        if (unsubscribeFriends) unsubscribeFriends();
                        if (unsubscribeFriendRequests) unsubscribeFriendRequests();
                        if (unsubscribeAllUsers) unsubscribeAllUsers();

                        renderChatRooms([]);
                        renderFriendsList([]);
                        renderFriendRequests([]);
                        renderUserRoomActivity([]);
                        renderMessages([]); // Clear chat area
                        messageInputArea.classList.add('hidden'); // Hide message input
                        showView(authContainer);
                    }
                    hideLoader(); // Hide loader after auth state is processed
                });

                // Handle user going offline when window closes/refreshes
                window.addEventListener('beforeunload', async () => {
                    if (currentUserId && db) {
                        const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, currentUserId);
                        await updateDoc(userDocRef, { isOnline: false, lastSeen: serverTimestamp() });
                    }
                });

            } catch (error) {
                console.error("Error initializing Firebase:", error);
                currentUserIdSpan.textContent = 'Error loading user.';
                hideLoader(); // Hide loader on error
            }
        }

        // --- Data Fetching and Listeners ---
        function setupListeners() {
            // Listen for current user's profile changes
            if (currentUserId) {
                onSnapshot(doc(db, `artifacts/${appId}/public/data/users`, currentUserId), (docSnap) => {
                    if (docSnap.exists()) {
                        currentUserProfile = docSnap.data();
                        profilePicDisplay.src = currentUserProfile.profilePicUrl || `https://placehold.co/40x40/00FF00/000000?text=${currentUserProfile.displayName ? currentUserProfile.displayName[0].toUpperCase() : 'U'}`;
                    }
                });
            }

            // Listen for all users (for search and display names)
            if (unsubscribeAllUsers) unsubscribeAllUsers();
            unsubscribeAllUsers = onSnapshot(collection(db, `artifacts/${appId}/public/data/users`), (snapshot) => {
                allUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderFriendsList(friendsList); // Re-render friends to update online status based on allUsers
            });

            // Listen for chat rooms
            if (unsubscribeChatRooms) unsubscribeChatRooms();
            unsubscribeChatRooms = onSnapshot(collection(db, `artifacts/${appId}/public/data/chatRooms`), (snapshot) => {
                chatRooms = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderChatRooms(chatRooms);
                renderUserRoomActivity(); // Re-render activity as room names might be needed
            });

            // Listen for current user's friends list
            if (unsubscribeFriends) unsubscribeFriends();
            unsubscribeFriends = onSnapshot(doc(db, `artifacts/${appId}/public/data/users`, currentUserId), (docSnap) => {
                if (docSnap.exists()) {
                    friendsList = docSnap.data().friends || [];
                    renderFriendsList(friendsList);
                }
            });

            // Listen for current user's friend requests
            if (unsubscribeFriendRequests) unsubscribeFriendRequests();
            unsubscribeFriendRequests = onSnapshot(doc(db, `artifacts/${appId}/public/data/users`, currentUserId), (docSnap) => {
                if (docSnap.exists()) {
                    friendRequestsReceived = docSnap.data().friendRequestsReceived || [];
                    renderFriendRequests(friendRequestsReceived);
                }
            });

            // Listen for user room activity
            if (unsubscribeUserRoomActivity) unsubscribeUserRoomActivity();
            unsubscribeUserRoomActivity = onSnapshot(collection(db, `artifacts/${appId}/users/${currentUserId}/userRooms`), (snapshot) => {
                userRoomActivityData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderUserRoomActivity();
            });
        }

        // --- Render Functions ---
        function renderChatRooms(rooms) {
            chatRoomsList.innerHTML = '';
            rooms.forEach(room => {
                const roomDiv = document.createElement('div');
                roomDiv.className = `p-3 mb-2 rounded-lg cursor-pointer transition-all duration-300 flex justify-between items-center ${selectedChat?.id === room.id && selectedChatType === 'room' ? 'bg-green-800 border-l-4 border-green-400 shadow-inner shadow-green-500/20' : 'bg-gray-800 hover:bg-gray-700 border-l-4 border-transparent'}`;
                roomDiv.innerHTML = `<span class="text-green-200">${room.name}</span>`;

                if (selectedChat?.id === room.id && selectedChatType === 'room') {
                    const inviteButton = document.createElement('button');
                    inviteButton.className = "text-blue-400 hover:text-blue-300 text-sm ml-2 px-2 py-1 rounded bg-blue-800 hover:bg-blue-700 transition-colors";
                    inviteButton.textContent = "[INVITE]";
                    inviteButton.title = "Invite User to Room";
                    inviteButton.onclick = (e) => {
                        e.stopPropagation();
                        showInviteUserModal(room.id);
                    };
                    roomDiv.appendChild(inviteButton);

                    const leaveButton = document.createElement('button');
                    leaveButton.className = "text-red-400 hover:text-red-300 text-sm ml-2 px-2 py-1 rounded bg-red-800 hover:bg-red-700 transition-colors";
                    leaveButton.textContent = "[LEAVE]";
                    leaveButton.title = "Leave Room";
                    leaveButton.onclick = (e) => {
                        e.stopPropagation();
                        handleLeaveRoom(room.id);
                    };
                    roomDiv.appendChild(leaveButton);
                }

                roomDiv.onclick = () => handleJoinRoom(room.id);
                roomDiv.dataset.roomId = room.id; // Store room ID for re-rendering
                chatRoomsList.appendChild(roomDiv);
            });
        }

        function renderFriendsList(friendsUids) {
            friendsListDiv.innerHTML = '';
            friendsCountSpan.textContent = friendsUids.length;

            if (friendsUids.length === 0) {
                friendsListDiv.innerHTML = '<p class="text-gray-600 text-sm">No friends yet. Find some!</p>';
                return;
            }

            friendsUids.forEach(friendUid => {
                const friend = allUsers.find(u => u.id === friendUid);
                if (!friend) return; // Skip if friend data not yet loaded

                const friendDiv = document.createElement('div');
                friendDiv.className = `p-3 mb-2 rounded-lg cursor-pointer transition-all duration-300 flex justify-between items-center ${selectedChat?.id === friend.id && selectedChatType === 'direct' ? 'bg-green-800 border-l-4 border-green-400 shadow-inner shadow-green-500/20' : 'bg-gray-800 hover:bg-gray-700 border-l-4 border-transparent'}`;
                friendDiv.innerHTML = `
                    <div class="flex items-center">
                        <img src="${friend.profilePicUrl || 'https://placehold.co/30x30/00FF00/000000?text=U'}" alt="User" class="w-7 h-7 rounded-full border border-green-500 object-cover mr-2">
                        <span class="text-green-200">${friend.displayName}</span>
                    </div>
                    ${friend.isOnline ? '<span class="w-2 h-2 bg-green-500 rounded-full ml-2 animate-pulse" title="Online"></span>' : ''}
                `;
                friendDiv.onclick = () => startDirectChat(friend.id, friend.displayName);
                friendsListDiv.appendChild(friendDiv);
            });
        }

        function renderFriendRequests(requestsUids) {
            friendRequestsListDiv.innerHTML = '';
            friendRequestsCountSpan.textContent = requestsUids.length;

            if (requestsUids.length === 0) {
                friendRequestsListDiv.innerHTML = '<p class="text-gray-600 text-sm">No pending requests.</p>';
                return;
            }

            requestsUids.forEach(requesterUid => {
                const requester = allUsers.find(u => u.id === requesterUid);
                if (!requester) return;

                const requestDiv = document.createElement('div');
                requestDiv.className = `p-3 mb-2 rounded-lg bg-gray-800 border-l-4 border-yellow-700 flex flex-col`;
                requestDiv.innerHTML = `
                    <div class="flex items-center mb-2">
                        <img src="${requester.profilePicUrl || 'https://placehold.co/30x30/00FF00/000000?text=U'}" alt="User" class="w-7 h-7 rounded-full border border-green-500 object-cover mr-2">
                        <span class="text-green-200">${requester.displayName}</span>
                        <span class="text-gray-500 text-xs ml-auto">sent a request</span>
                    </div>
                    <div class="flex justify-end space-x-2">
                        <button class="py-1 px-3 bg-green-700 hover:bg-green-600 rounded-lg text-white text-sm" onclick="handleFriendRequest('${requester.id}', true)">[ACCEPT]</button>
                        <button class="py-1 px-3 bg-red-700 hover:bg-red-600 rounded-lg text-white text-sm" onclick="handleFriendRequest('${requester.id}', false)">[DENY]</button>
                    </div>
                `;
                friendRequestsListDiv.appendChild(requestDiv);
            });
        }

        function renderMessages(messages) {
            chatAreaContent.innerHTML = ''; // Clear previous content
            if (!selectedChat) {
                chatAreaContent.innerHTML = `
                    <div class="flex flex-col items-center justify-center flex-grow text-gray-500 text-2xl">
                        <span class="text-green-500 text-4xl mb-4 animate-pulse">_</span>
                        Select a room or a friend to start chatting.
                    </div>
                `;
                messageInputArea.classList.add('hidden');
                messageInputArea.classList.remove('flex');
                return;
            }

            // Display chat header
            const chatHeader = document.createElement('div');
            chatHeader.className = "flex items-center justify-between mb-6 pb-4 border-b-2 border-green-700";
            chatHeader.innerHTML = `
                <h2 class="text-3xl font-bold text-green-300">
                    <span class="text-green-500">_</span> ${selectedChat.name}
                </h2>
                ${selectedChatType === 'room' ? `
                    <button id="inviteUserToRoomButton" class="py-1 px-3 bg-blue-700 hover:bg-blue-600 rounded-lg text-white text-sm">
                        [INVITE USER]
                    </button>
                ` : ''}
            `;
            chatAreaContent.appendChild(chatHeader);

            // Add event listener for invite button if it exists
            if (selectedChatType === 'room') {
                document.getElementById('inviteUserToRoomButton').addEventListener('click', () => {
                    showInviteUserModal(selectedChat.id);
                });
            }


            // Messages container
            const messagesContainer = document.createElement('div');
            messagesContainer.className = "flex-grow overflow-y-auto custom-scrollbar pr-4 mb-4";
            messagesContainer.id = "messagesContainer"; // Add ID for scrolling

            messages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `flex items-start mb-4 p-3 rounded-lg border-2 max-w-[70%] transition-all duration-300 transform hover:scale-[1.01] shadow-md shadow-green-500/10 ${msg.senderId === currentUserId ? 'bg-green-900 border-green-700 ml-auto flex-row-reverse' : 'bg-gray-800 border-gray-700'}`;
                messageDiv.onmouseenter = () => handleMessageSeen(msg.id); // Mark as seen on hover

                messageDiv.innerHTML = `
                    <img src="${getUserProfilePic(msg.senderId)}" alt="Sender" class="w-10 h-10 rounded-full border-2 border-green-400 object-cover ${msg.senderId === currentUserId ? 'ml-3' : 'mr-3'}">
                    <div class="flex flex-col ${msg.senderId === currentUserId ? 'items-end' : 'items-start'} flex-grow">
                        <div class="flex items-center mb-1">
                            <span class="font-bold text-green-300 text-sm">
                                ${getUserDisplayName(msg.senderId)}
                            </span>
                            <span class="text-xs text-gray-500 ml-2">
                                ${formatTimestamp(msg.timestamp)}
                            </span>
                        </div>
                        <p class="text-white text-base break-words whitespace-pre-wrap">${msg.text}</p>
                        <div class="flex mt-2 -mb-1" id="reactions-${msg.id}">
                            ${Object.entries(msg.reactions || {}).map(([emoji, reactors]) =>
                                reactors.length > 0 ? `
                                    <span class="bg-gray-700 text-xs px-2 py-1 rounded-full mr-1 flex items-center border border-green-800">
                                        ${emoji} <span class="ml-1 text-green-400">${reactors.length}</span>
                                    </span>
                                ` : ''
                            ).join('')}
                        </div>
                        <div class="flex text-xs text-gray-500 mt-1">
                            ${msg.delivered ? '<span class="mr-2">Delivered </span>' : ''}
                            ${msg.seenBy && msg.seenBy.length > 0 ? `<span>Seen by ${msg.seenBy.length} ${msg.seenBy.length === 1 ? 'user' : 'users'} </span>` : ''}
                        </div>
                    </div>
                    <div class="flex flex-col ml-2 ${msg.senderId === currentUserId ? 'order-first mr-3' : ''}">
                        ${['', '', '', '', ''].map(emoji => `
                            <button
                                class="text-lg p-1 rounded-full hover:bg-gray-700 transition-colors mb-1 ${msg.reactions?.[emoji]?.includes(currentUserId) ? 'bg-green-700' : 'bg-gray-900'}"
                                title="React with ${emoji}"
                                data-message-id="${msg.id}"
                                data-emoji="${emoji}"
                            >
                                ${emoji}
                            </button>
                        `).join('')}
                    </div>
                `;
                messagesContainer.appendChild(messageDiv);
            });

            chatAreaContent.appendChild(messagesContainer);
            messageInputArea.classList.remove('hidden');
            messageInputArea.classList.add('flex');
            scrollToBottom(messagesContainer);
        }

        function renderUserRoomActivity() {
            userRoomActivityDiv.innerHTML = '';
            if (userRoomActivityData.length === 0) {
                userRoomActivityDiv.innerHTML = '<p class="text-gray-600 text-sm">No room activity recorded yet.</p>';
                return;
            }

            userRoomActivityData.forEach(activity => {
                // Find the corresponding room name from the global chatRooms list
                const room = chatRooms.find(r => r.id === activity.id);
                if (!room) return; // Skip if room not found (e.g., room was deleted)

                const activityDiv = document.createElement('div');
                activityDiv.className = "p-2 mb-2 bg-gray-800 rounded-lg text-sm";
                activityDiv.innerHTML = `
                    <span class="font-bold text-green-300">${room.name}</span><br>
                    <span class="text-gray-500">Joined: ${formatTimestamp(activity.joinedAt)}</span><br>
                    <span class="text-gray-500">Left: ${activity.leftAt ? formatTimestamp(activity.leftAt) : 'Still in room'}</span><br>
                    <span class="text-gray-500">Duration: ${formatDuration(activity.duration)}</span>
                `;
                userRoomActivityDiv.appendChild(activityDiv);
            });
        }


        // --- Authentication Event Handlers ---
        loginButton.addEventListener('click', async () => {
            showLoader();
            const email = loginEmailInput.value;
            const password = loginPasswordInput.value;
            hideError(loginError);
            if (!email || !password) {
                displayError(loginError, "Email and password cannot be empty.");
                hideLoader();
                return;
            }
            try {
                await signInWithEmailAndPassword(auth, email, password);
                // Auth state change listener will handle UI update
            } catch (error) {
                console.error("Login error:", error);
                displayError(loginError, error.message);
            } finally {
                hideLoader();
            }
        });

        showSignupButton.addEventListener('click', () => showAuthForm(signupForm));
        backToLoginFromSignup.addEventListener('click', () => showAuthForm(loginForm));
        showForgotPasswordButton.addEventListener('click', () => showAuthForm(forgotPasswordForm));
        backToLoginFromForgot.addEventListener('click', () => showAuthForm(loginForm));


        signupButton.addEventListener('click', async () => {
            showLoader();
            const name = signupNameInput.value.trim();
            const username = signupUsernameInput.value.trim().toLowerCase(); // Store username in lowercase
            const email = signupEmailInput.value.trim();
            const password = signupPasswordInput.value;
            const mobile = signupMobileInput.value.trim();
            const dob = signupDOBInput.value;
            const gender = signupGenderSelect.value;
            hideError(signupError);

            if (!name || !username || !email || !password) {
                displayError(signupError, "Display Name, Username, Email, and Password are required.");
                hideLoader();
                return;
            }
            if (password.length < 6) {
                displayError(signupError, "Password must be at least 6 characters long.");
                hideLoader();
                return;
            }

            try {
                // Check if username already exists
                const usernameDocRef = doc(db, `artifacts/${appId}/public/data/usernames`, username);
                const usernameDocSnap = await getDoc(usernameDocRef);
                if (usernameDocSnap.exists()) {
                    displayError(signupError, "Username is already taken. Please choose another.");
                    hideLoader();
                    return;
                }

                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // Update Firebase Auth profile
                await updateProfile(user, {
                    displayName: name,
                    photoURL: `https://placehold.co/40x40/00FF00/000000?text=${name[0].toUpperCase()}`, // Default profile pic
                });

                // Store additional user data in Firestore
                const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, user.uid);
                await setDoc(userDocRef, {
                    displayName: name,
                    username: username, // Store username here
                    email: email,
                    profilePicUrl: `https://placehold.co/40x40/00FF00/000000?text=${name[0].toUpperCase()}`,
                    isOnline: true,
                    lastSeen: serverTimestamp(),
                    mobile: mobile || null,
                    dob: dob || null,
                    gender: gender || null,
                    friends: [],
                    friendRequestsSent: [],
                    friendRequestsReceived: [],
                });

                // Store username in public collection for uniqueness check
                await setDoc(usernameDocRef, { uid: user.uid });

                // Auth state change listener will handle UI update
            } catch (error) {
                console.error("Signup error:", error);
                displayError(signupError, error.message);
            } finally {
                hideLoader();
            }
        });

        resetPasswordButton.addEventListener('click', async () => {
            showLoader();
            const email = forgotEmailInput.value.trim();
            hideError(forgotPasswordError);
            hideError(forgotPasswordMessage);

            if (!email) {
                displayError(forgotPasswordError, "Please enter your email address.");
                hideLoader();
                return;
            }
            try {
                await sendPasswordResetEmail(auth, email);
                displayError(forgotPasswordMessage, "Password reset email sent! Check your inbox.");
            } catch (error) {
                console.error("Forgot password error:", error);
                displayError(forgotPasswordError, error.message);
            } finally {
                hideLoader();
            }
        });

        logoutButton.addEventListener('click', async () => {
            showLoader();
            try {
                if (currentUserId && db) {
                    const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, currentUserId);
                    await updateDoc(userDocRef, { isOnline: false, lastSeen: serverTimestamp() });
                }
                await signOut(auth);
                // onAuthStateChanged will handle hiding the main app and showing auth forms
            } catch (error) {
                console.error("Logout error:", error);
            } finally {
                hideLoader();
            }
        });

        // --- Profile View Handlers ---
        profileButton.addEventListener('click', () => {
            if (currentUserProfile) {
                profilePicInputDisplay.src = currentUserProfile.profilePicUrl || `https://placehold.co/120x120/00FF00/000000?text=${currentUserProfile.displayName ? currentUserProfile.displayName[0].toUpperCase() : 'U'}`;
                profileNameInput.value = currentUserProfile.displayName || '';
                profileUsernameDisplay.value = currentUserProfile.username || ''; // Display username
                profileEmailDisplay.value = currentUserProfile.email || ''; // Display email
                profilePicUrlInput.value = currentUserProfile.profilePicUrl || '';
                profileMobileInput.value = currentUserProfile.mobile || '';
                profileDOBInput.value = currentUserProfile.dob || '';
                profileGenderSelect.value = currentUserProfile.gender || '';
            }
            showView(profileView);
        });

        backToChatFromProfile.addEventListener('click', () => {
            showView(mainChatApp);
        });

        saveProfileUpdate.addEventListener('click', async () => {
            showLoader();
            if (auth && currentUserId && db && currentUserProfile) {
                try {
                    const newDisplayName = profileNameInput.value.trim();
                    const newProfilePicUrl = profilePicUrlInput.value.trim();
                    const newMobile = profileMobileInput.value.trim();
                    const newDOB = profileDOBInput.value;
                    const newGender = profileGenderSelect.value;

                    // Update Firebase Auth profile
                    await updateProfile(auth.currentUser, {
                        displayName: newDisplayName,
                        photoURL: newProfilePicUrl,
                    });

                    // Update Firestore user document
                    const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, currentUserId);
                    await updateDoc(userDocRef, {
                        displayName: newDisplayName,
                        profilePicUrl: newProfilePicUrl,
                        mobile: newMobile,
                        dob: newDOB,
                        gender: newGender,
                    });
                    showModal(messageModal, 'Profile Updated', 'Your profile has been updated successfully!');
                } catch (error) {
                    console.error("Error updating profile:", error);
                    showModal(messageModal, 'Error', `Failed to update profile: ${error.message}`);
                } finally {
                    hideLoader();
                }
            } else {
                hideLoader();
            }
        });

        // --- Chat Room Functionality ---
        createRoomButton.addEventListener('click', () => {
            newRoomNameInput.value = '';
            showModal(createRoomModal, 'CREATE NEW CHAT ROOM', '');
        });

        cancelCreateRoom.addEventListener('click', () => closeModal(createRoomModal));

        confirmCreateRoom.addEventListener('click', async () => {
            showLoader();
            const roomName = newRoomNameInput.value.trim();
            if (!roomName) {
                displayError(createRoomModal.querySelector('p'), 'Room name cannot be empty.');
                hideLoader();
                return;
            }
            hideError(createRoomModal.querySelector('p'));

            try {
                const newRoomRef = await addDoc(collection(db, `artifacts/${appId}/public/data/chatRooms`), {
                    name: roomName,
                    createdAt: serverTimestamp(),
                    createdBy: currentUserId,
                    members: [currentUserId], // Creator is automatically a member
                    pendingInvitations: []
                });
                newRoomNameInput.value = '';
                closeModal(createRoomModal);
                await handleJoinRoom(newRoomRef.id); // Automatically join the new room
                showModal(messageModal, 'Room Created!', `Room "${roomName}" created and joined.`);
            } catch (error) {
                console.error("Error creating room:", error);
                displayError(createRoomModal.querySelector('p'), `Error: ${error.message}`);
            } finally {
                hideLoader();
            }
        });

        async function handleJoinRoom(roomId) {
            showLoader();
            if (db && currentUserId) {
                try {
                    // First, if currently in a room, record leave time
                    if (selectedChat && selectedChatType === 'room' && selectedChat.id !== roomId) {
                        await handleLeaveRoom(selectedChat.id);
                    }

                    const roomDocRef = doc(db, `artifacts/${appId}/public/data/chatRooms`, roomId);
                    const roomSnap = await getDoc(roomDocRef);

                    if (!roomSnap.exists()) {
                        showModal(messageModal, 'Error', 'Room not found.');
                        hideLoader();
                        return;
                    }

                    const roomData = roomSnap.data();
                    if (!roomData.members.includes(currentUserId)) {
                        // If not a member, check for invitation
                        if (roomData.pendingInvitations.includes(currentUserId)) {
                            // Accept invitation and join
                            await updateDoc(roomDocRef, {
                                members: arrayUnion(currentUserId),
                                pendingInvitations: arrayRemove(currentUserId)
                            });
                            showModal(messageModal, 'Invitation Accepted', `You have joined "${roomData.name}"!`);
                        } else {
                            showModal(messageModal, 'Access Denied', 'You are not a member of this room and have no pending invitations. Ask the creator to invite you.');
                            hideLoader();
                            return;
                        }
                    }

                    // Record join activity
                    const userRoomActivityDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/userRooms`, roomId);
                    const activitySnap = await getDoc(userRoomActivityDocRef);
                    if (!activitySnap.exists() || activitySnap.data().leftAt) { // If first time or previously left
                        await setDoc(userRoomActivityDocRef, {
                            joinedAt: serverTimestamp(),
                            leftAt: null,
                            duration: 0,
                        }, { merge: true });
                    }

                    selectedChat = { id: roomId, name: roomData.name };
                    selectedChatType = 'room';

                    // Clear previous messages listener
                    if (unsubscribeMessages) unsubscribeMessages();

                    // Listen for messages in the newly selected room
                    unsubscribeMessages = onSnapshot(
                        query(collection(db, `artifacts/${appId}/public/data/messages`), where('roomId', '==', roomId)),
                        (snapshot) => {
                            const messages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                                .sort((a, b) => a.timestamp?.toMillis() - b.timestamp?.toMillis());
                            renderMessages(messages);
                        }
                    );
                    renderChatRooms(chatRooms); // Re-render to highlight selected room
                } catch (error) {
                    console.error("Error joining room:", error);
                    showModal(messageModal, 'Error', `Failed to join room: ${error.message}`);
                } finally {
                    hideLoader();
                }
            } else {
                hideLoader();
            }
        }

        async function handleLeaveRoom(roomId) {
            showLoader();
            if (db && currentUserId) {
                try {
                    const roomDocRef = doc(db, `artifacts/${appId}/public/data/chatRooms`, roomId);
                    const roomSnap = await getDoc(roomDocRef);

                    if (roomSnap.exists() && roomSnap.data().members.includes(currentUserId)) {
                        await updateDoc(roomDocRef, {
                            members: arrayRemove(currentUserId)
                        });
                    }

                    // Record leave activity
                    const userRoomActivityDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/userRooms`, roomId);
                    const activitySnap = await getDoc(userRoomActivityDocRef);

                    if (activitySnap.exists() && activitySnap.data().joinedAt && !activitySnap.data().leftAt) {
                        const joinedAtMs = activitySnap.data().joinedAt.toMillis();
                        const nowMs = Date.now();
                        const sessionDuration = nowMs - joinedAtMs;
                        const currentTotalDuration = activitySnap.data().duration || 0;

                        await updateDoc(userRoomActivityDocRef, {
                            leftAt: serverTimestamp(),
                            duration: currentTotalDuration + sessionDuration
                        });
                    }

                    selectedChat = null; // Deselect room
                    selectedChatType = null;
                    renderMessages([]); // Clear messages display
                    renderChatRooms(chatRooms); // Re-render to update UI
                    showModal(messageModal, 'Room Left', 'You have left the chat room.');
                } catch (error) {
                    console.error("Error leaving room:", error);
                    showModal(messageModal, 'Error', `Failed to leave room: ${error.message}`);
                } finally {
                    hideLoader();
                }
            } else {
                hideLoader();
            }
        }

        // --- Message and Reaction Handlers ---
        sendMessageButton.addEventListener('click', handleSendMessage);

        newMessageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleSendMessage();
            }
        });

        async function handleSendMessage() {
            showLoader();
            if (db && currentUserId && selectedChat?.id && newMessageInput.value.trim()) {
                try {
                    let messagesCollectionRef;
                    if (selectedChatType === 'room') {
                        messagesCollectionRef = collection(db, `artifacts/${appId}/public/data/messages`);
                    } else if (selectedChatType === 'direct') {
                        messagesCollectionRef = collection(db, `artifacts/${appId}/public/data/directMessages/${selectedChat.id}/messages`);
                    } else {
                        console.error("No active chat selected.");
                        hideLoader();
                        return;
                    }

                    await addDoc(messagesCollectionRef, {
                        chatId: selectedChat.id, // Use chatId to filter messages in the listener
                        type: selectedChatType,
                        senderId: currentUserId,
                        text: newMessageInput.value.trim(),
                        timestamp: serverTimestamp(),
                        reactions: {},
                        delivered: true,
                        seenBy: [currentUserId], // Sender has seen it by default
                    });
                    newMessageInput.value = '';
                    const messagesContainer = document.getElementById('messagesContainer');
                    if (messagesContainer) {
                        scrollToBottom(messagesContainer);
                    }
                } catch (error) {
                    console.error("Error sending message:", error);
                    showModal(messageModal, 'Error', `Failed to send message: ${error.message}`);
                } finally {
                    hideLoader();
                }
            } else {
                hideLoader();
            }
        }

        chatAreaContent.addEventListener('click', (e) => {
            const target = e.target;
            if (target.tagName === 'BUTTON' && target.hasAttribute('data-message-id') && target.hasAttribute('data-emoji')) {
                const messageId = target.dataset.messageId;
                const emoji = target.dataset.emoji;
                handleReaction(messageId, emoji);
            }
        });

        async function handleReaction(messageId, emoji) {
            showLoader();
            if (db && currentUserId && selectedChat?.id) {
                try {
                    let messageDocRef;
                    if (selectedChatType === 'room') {
                        messageDocRef = doc(db, `artifacts/${appId}/public/data/messages`, messageId);
                    } else if (selectedChatType === 'direct') {
                        messageDocRef = doc(db, `artifacts/${appId}/public/data/directMessages/${selectedChat.id}/messages`, messageId);
                    } else {
                        hideLoader();
                        return;
                    }

                    const messageDocSnap = await getDoc(messageDocRef);

                    if (messageDocSnap.exists()) {
                        const currentReactions = messageDocSnap.data().reactions || {};
                        const usersForEmoji = currentReactions[emoji] || [];

                        let newUsersForEmoji;
                        if (usersForEmoji.includes(currentUserId)) {
                            newUsersForEmoji = usersForEmoji.filter((id) => id !== currentUserId);
                        } else {
                            newUsersForEmoji = [...usersForEmoji, currentUserId];
                        }

                        const newReactions = {
                            ...currentReactions,
                            [emoji]: newUsersForEmoji,
                        };

                        if (newUsersForEmoji.length === 0) {
                            delete newReactions[emoji];
                        }

                        await updateDoc(messageDocRef, {
                            reactions: newReactions,
                        });
                    }
                } catch (error) {
                    console.error("Error toggling reaction:", error);
                } finally {
                    hideLoader();
                }
            } else {
                hideLoader();
            }
        }

        async function handleMessageSeen(messageId) {
            // No loader for this as it's a passive background update
            if (db && currentUserId && selectedChat?.id) {
                try {
                    let messageDocRef;
                    if (selectedChatType === 'room') {
                        messageDocRef = doc(db, `artifacts/${appId}/public/data/messages`, messageId);
                    } else if (selectedChatType === 'direct') {
                        messageDocRef = doc(db, `artifacts/${appId}/public/data/directMessages/${selectedChat.id}/messages`, messageId);
                    } else {
                        return;
                    }

                    const messageDocSnap = await getDoc(messageDocRef);

                    if (messageDocSnap.exists()) {
                        const seenBy = messageDocSnap.data().seenBy || [];
                        if (!seenBy.includes(currentUserId)) {
                            await updateDoc(messageDocRef, {
                                seenBy: arrayUnion(currentUserId),
                            });
                        }
                    }
                } catch (error) {
                    console.error("Error marking message as seen:", error);
                }
            }
        }

        // --- Room Invitation Feature ---
        function showInviteUserModal(roomId) {
            inviteUsernameInput.value = '';
            hideError(inviteUserMessage);
            inviteUserModal.dataset.roomId = roomId; // Store room ID for later use
            showModal(inviteUserModal, 'INVITE USER TO ROOM', '');
        }

        cancelInviteUser.addEventListener('click', () => closeModal(inviteUserModal));

        confirmInviteUser.addEventListener('click', async () => {
            showLoader();
            const roomId = inviteUserModal.dataset.roomId;
            const targetUsername = inviteUsernameInput.value.trim().toLowerCase();
            if (!roomId || !targetUsername) {
                displayError(inviteUserMessage, 'Please enter a username.');
                hideLoader();
                return;
            }
            hideError(inviteUserMessage);

            try {
                // Find target user's UID by username
                const usernameDocRef = doc(db, `artifacts/${appId}/public/data/usernames`, targetUsername);
                const usernameDocSnap = await getDoc(usernameDocRef);

                if (!usernameDocSnap.exists()) {
                    displayError(inviteUserMessage, `User "${targetUsername}" not found.`);
                    hideLoader();
                    return;
                }
                const targetUid = usernameDocSnap.data().uid;

                // Check if target user is already a member
                const roomDocRef = doc(db, `artifacts/${appId}/public/data/chatRooms`, roomId);
                const roomSnap = await getDoc(roomDocRef);
                if (roomSnap.exists() && roomSnap.data().members.includes(targetUid)) {
                    displayError(inviteUserMessage, `${targetUsername} is already a member of this room.`);
                    hideLoader();
                    return;
                }

                // Add to pending invitations
                await updateDoc(roomDocRef, {
                    pendingInvitations: arrayUnion(targetUid)
                });
                closeModal(inviteUserModal);
                showModal(messageModal, 'Invitation Sent', `Invitation sent to ${targetUsername}.`);
            } catch (error) {
                console.error("Error inviting user:", error);
                displayError(inviteUserMessage, `Error: ${error.message}`);
            } finally {
                hideLoader();
            }
        });

        // --- Find Friends Feature ---
        findFriendsButton.addEventListener('click', () => {
            searchUsernameInput.value = '';
            searchResultsDiv.innerHTML = '<p class="text-gray-500 text-sm">No results.</p>';
            hideError(findFriendsMessage);
            showModal(findFriendsModal, 'SEARCH FOR USERS', '');
        });

        cancelFindFriends.addEventListener('click', () => closeModal(findFriendsModal));

        searchUsersButton.addEventListener('click', async () => {
            showLoader();
            const searchTerm = searchUsernameInput.value.trim().toLowerCase();
            searchResultsDiv.innerHTML = '';
            hideError(findFriendsMessage);

            if (!searchTerm) {
                displayError(findFriendsMessage, 'Please enter a username to search.');
                hideLoader();
                return;
            }

            try {
                // Search in the public usernames collection
                const usernameDocRef = doc(db, `artifacts/${appId}/public/data/usernames`, searchTerm);
                const usernameDocSnap = await getDoc(usernameDocRef);

                if (usernameDocSnap.exists()) {
                    const foundUid = usernameDocSnap.data().uid;
                    if (foundUid === currentUserId) {
                        searchResultsDiv.innerHTML = '<p class="text-gray-500 text-sm">That\'s you!</p>';
                        hideLoader();
                        return;
                    }

                    const foundUser = allUsers.find(u => u.id === foundUid);
                    if (foundUser) {
                        const userItemDiv = document.createElement('div');
                        userItemDiv.className = 'flex items-center justify-between p-2 mb-2 bg-gray-700 rounded-md';
                        userItemDiv.innerHTML = `
                            <div class="flex items-center">
                                <img src="${foundUser.profilePicUrl || 'https://placehold.co/30x30/00FF00/000000?text=U'}" alt="User" class="w-8 h-8 rounded-full border border-green-500 object-cover mr-2">
                                <span class="text-green-200 font-semibold">${foundUser.displayName}</span>
                                <span class="text-gray-500 text-xs ml-2">@${foundUser.username}</span>
                            </div>
                            <button class="py-1 px-3 bg-blue-700 hover:bg-blue-600 rounded-lg text-white text-sm" data-uid="${foundUser.id}" onclick="showUserProfileDetails('${foundUser.id}')">[VIEW PROFILE]</button>
                        `;
                        searchResultsDiv.appendChild(userItemDiv);
                    } else {
                        searchResultsDiv.innerHTML = '<p class="text-gray-500 text-sm">User profile data not found.</p>';
                    }
                } else {
                    searchResultsDiv.innerHTML = '<p class="text-gray-500 text-sm">No users found with that username.</p>';
                }
            } catch (error) {
                console.error("Error searching users:", error);
                displayError(findFriendsMessage, `Error: ${error.message}`);
            } finally {
                hideLoader();
            }
        });

        window.showUserProfileDetails = async (targetUid) => {
            showLoader();
            const targetUser = allUsers.find(u => u.id === targetUid);
            if (!targetUser) {
                showModal(messageModal, 'Error', 'User data not available.');
                hideLoader();
                return;
            }

            modalProfilePic.src = targetUser.profilePicUrl || `https://placehold.co/80x80/00FF00/000000?text=${targetUser.displayName ? targetUser.displayName[0].toUpperCase() : 'U'}`;
            modalDisplayName.textContent = targetUser.displayName;
            modalUsername.textContent = `@${targetUser.username}`;
            modalEmail.textContent = targetUser.email || 'N/A';
            modalMobile.textContent = targetUser.mobile || 'N/A';
            modalDOB.textContent = targetUser.dob || 'N/A';
            modalGender.textContent = targetUser.gender || 'N/A';

            sendFriendRequestButton.dataset.targetUid = targetUid;
            hideError(userProfileDetailsMessage);

            // Check friendship status
            if (friendsList.includes(targetUid)) {
                sendFriendRequestButton.textContent = '[ALREADY FRIENDS]';
                sendFriendRequestButton.disabled = true;
                sendFriendRequestButton.classList.remove('bg-green-700', 'hover:bg-green-600');
                sendFriendRequestButton.classList.add('bg-gray-600', 'cursor-not-allowed');
            } else if (currentUserProfile.friendRequestsSent.includes(targetUid)) {
                sendFriendRequestButton.textContent = '[REQUEST SENT]';
                sendFriendRequestButton.disabled = true;
                sendFriendRequestButton.classList.remove('bg-green-700', 'hover:bg-green-600');
                sendFriendRequestButton.classList.add('bg-gray-600', 'cursor-not-allowed');
            } else if (currentUserProfile.friendRequestsReceived.includes(targetUid)) {
                sendFriendRequestButton.textContent = '[REQUEST RECEIVED]';
                sendFriendRequestButton.disabled = true;
                sendFriendRequestButton.classList.remove('bg-green-700', 'hover:bg-green-600');
                sendFriendRequestButton.classList.add('bg-gray-600', 'cursor-not-allowed');
            } else {
                sendFriendRequestButton.textContent = '[SEND FRIEND REQUEST]';
                sendFriendRequestButton.disabled = false;
                sendFriendRequestButton.classList.add('bg-green-700', 'hover:bg-green-600');
                sendFriendRequestButton.classList.remove('bg-gray-600', 'cursor-not-allowed');
            }

            showModal(userProfileDetailsModal);
            hideLoader();
        };

        closeUserProfileDetails.addEventListener('click', () => closeModal(userProfileDetailsModal));

        sendFriendRequestButton.addEventListener('click', async (e) => {
            showLoader();
            const targetUid = e.target.dataset.targetUid;
            if (!targetUid || !currentUserId) {
                showModal(messageModal, 'Error', 'Invalid user for friend request.');
                hideLoader();
                return;
            }

            try {
                // Update sender's sent requests
                await updateDoc(doc(db, `artifacts/${appId}/public/data/users`, currentUserId), {
                    friendRequestsSent: arrayUnion(targetUid)
                });
                // Update receiver's received requests
                await updateDoc(doc(db, `artifacts/${appId}/public/data/users`, targetUid), {
                    friendRequestsReceived: arrayUnion(currentUserId)
                });

                displayError(userProfileDetailsMessage, 'Friend request sent!');
                e.target.textContent = '[REQUEST SENT]';
                e.target.disabled = true;
                e.target.classList.remove('bg-green-700', 'hover:bg-green-600');
                e.target.classList.add('bg-gray-600', 'cursor-not-allowed');
            } catch (error) {
                console.error("Error sending friend request:", error);
                displayError(userProfileDetailsMessage, `Error: ${error.message}`);
            } finally {
                hideLoader();
            }
        });

        window.handleFriendRequest = async (requesterUid, accept) => {
            showLoader();
            try {
                const currentUserDocRef = doc(db, `artifacts/${appId}/public/data/users`, currentUserId);
                const requesterUserDocRef = doc(db, `artifacts/${appId}/public/data/users`, requesterUid);

                if (accept) {
                    // Add to friends list for both
                    await updateDoc(currentUserDocRef, {
                        friends: arrayUnion(requesterUid),
                        friendRequestsReceived: arrayRemove(requesterUid)
                    });
                    await updateDoc(requesterUserDocRef, {
                        friends: arrayUnion(currentUserId),
                        friendRequestsSent: arrayRemove(currentUserId)
                    });
                    showModal(messageModal, 'Friend Request Accepted', `${getUserDisplayName(requesterUid)} is now your friend!`);
                } else {
                    // Remove from requests for both
                    await updateDoc(currentUserDocRef, {
                        friendRequestsReceived: arrayRemove(requesterUid)
                    });
                    await updateDoc(requesterUserDocRef, {
                        friendRequestsSent: arrayRemove(currentUserId)
                    });
                    showModal(messageModal, 'Friend Request Denied', `You denied the request from ${getUserDisplayName(requesterUid)}.`);
                }
            } catch (error) {
                console.error("Error handling friend request:", error);
                showModal(messageModal, 'Error', `Failed to handle request: ${error.message}`);
            } finally {
                hideLoader();
            }
        };

        // --- Direct Chat Functionality ---
        async function startDirectChat(friendUid, friendDisplayName) {
            showLoader();
            if (currentUserId === friendUid) {
                showModal(messageModal, 'Error', 'You cannot chat with yourself directly.');
                hideLoader();
                return;
            }

            // Record leave time if currently in a room
            if (selectedChat && selectedChatType === 'room') {
                await handleLeaveRoom(selectedChat.id);
            }

            // Generate a consistent DM ID (sorted UIDs)
            const dmId = [currentUserId, friendUid].sort().join('_');

            try {
                // Ensure the direct message document exists for both users
                const dmRef = doc(db, `artifacts/${appId}/public/data/directMessages`, dmId);
                const dmSnap = await getDoc(dmRef);

                if (!dmSnap.exists()) {
                    await setDoc(dmRef, {
                        members: [currentUserId, friendUid],
                        createdAt: serverTimestamp()
                    });
                }

                selectedChat = { id: dmId, name: `DM with ${friendDisplayName}` };
                selectedChatType = 'direct';

                // Clear previous messages listener
                if (unsubscribeMessages) unsubscribeMessages();

                // Listen for messages in the direct chat
                unsubscribeMessages = onSnapshot(
                    query(collection(db, `artifacts/${appId}/public/data/directMessages/${dmId}/messages`)),
                    (snapshot) => {
                        const messages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                            .sort((a, b) => a.timestamp?.toMillis() - b.timestamp?.toMillis());
                        renderMessages(messages);
                    }
                );
                renderFriendsList(friendsList); // Re-render to highlight selected DM
            } catch (error) {
                console.error("Error starting direct chat:", error);
                showModal(messageModal, 'Error', `Failed to start direct chat: ${error.message}`);
            } finally {
                hideLoader();
            }
        }

        // --- Generic Message Modal Close ---
        messageModalClose.addEventListener('click', () => closeModal(messageModal));

        // --- Initial Load ---
        window.onload = initializeFirebase;

    </script>
</body>
</html>
