<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatVibe - Modern Chat Experience</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        * {
            font-family: 'Inter', sans-serif;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .chat-bubble {
            animation: slideInUp 0.3s ease-out;
        }
        
        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .pulse-dot {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .typing-indicator {
            animation: typing 1.4s infinite;
        }
        
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }
        
        .notification-slide {
            animation: slideInRight 0.3s ease-out;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .hover-lift:hover {
            transform: translateY(-2px);
            transition: all 0.3s ease;
        }
        
        .emoji-picker {
            display: none;
            position: absolute;
            bottom: 100%;
            right: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            padding: 12px;
            z-index: 1000;
        }
        
        .emoji-picker.show {
            display: block;
            animation: fadeInUp 0.2s ease-out;
        }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .status-online { color: #10b981; }
        .status-away { color: #f59e0b; }
        .status-offline { color: #6b7280; }
        
        .message-status {
            font-size: 10px;
            margin-top: 2px;
        }
        
        .message-delivered { color: #6b7280; }
        .message-seen { color: #3b82f6; }
        
        .dark-theme {
            background: #1a1a2e;
            color: #eee;
        }
        
        .dark-theme .glass-effect {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        @media (max-width: 768px) {
            .mobile-hidden { display: none; }
            .mobile-full { width: 100%; }
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 gradient-bg flex items-center justify-center z-50">
        <div class="text-center text-white">
            <div class="w-16 h-16 border-4 border-white border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <h2 class="text-2xl font-bold mb-2">ChatVibe</h2>
            <p class="text-white/80">Loading your conversations...</p>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notification-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <!-- Authentication Screen -->
    <div id="auth-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="glass-effect rounded-3xl shadow-2xl w-full max-w-md p-8 text-white">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                    </svg>
                </div>
                <h1 class="text-3xl font-bold mb-2">ChatVibe</h1>
                <p class="text-white/80">Connect, Chat, Vibe Together</p>
            </div>
            
            <!-- Sign In Form -->
            <div id="signin-form" class="space-y-6">
                <h2 class="text-2xl font-semibold text-center">Welcome Back</h2>
                <div class="space-y-4">
                    <input type="email" id="signin-email" placeholder="Email" class="w-full p-4 bg-white/10 border border-white/20 rounded-xl text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-white/50">
                    <input type="password" id="signin-password" placeholder="Password" class="w-full p-4 bg-white/10 border border-white/20 rounded-xl text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-white/50">
                    <button onclick="signIn()" class="w-full bg-white text-purple-600 p-4 rounded-xl hover:bg-white/90 transition duration-200 font-semibold">
                        Sign In
                    </button>
                </div>
                <div class="text-center space-y-3">
                    <button onclick="showForgotPassword()" class="text-white/80 hover:text-white text-sm underline">Forgot Password?</button>
                    <p class="text-white/80 text-sm">New to ChatVibe? <button onclick="showSignUp()" class="text-white font-semibold underline">Create Account</button></p>
                </div>
            </div>
            
            <!-- Sign Up Form -->
            <div id="signup-form" class="space-y-6 hidden">
                <h2 class="text-2xl font-semibold text-center">Join ChatVibe</h2>
                <div class="space-y-4">
                    <input type="text" id="signup-name" placeholder="Full Name" class="w-full p-4 bg-white/10 border border-white/20 rounded-xl text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-white/50">
                    <input type="text" id="signup-username" placeholder="Username" class="w-full p-4 bg-white/10 border border-white/20 rounded-xl text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-white/50">
                    <input type="email" id="signup-email" placeholder="Email" class="w-full p-4 bg-white/10 border border-white/20 rounded-xl text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-white/50">
                    <input type="password" id="signup-password" placeholder="Password" class="w-full p-4 bg-white/10 border border-white/20 rounded-xl text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-white/50">
                    <button onclick="signUp()" class="w-full bg-white text-purple-600 p-4 rounded-xl hover:bg-white/90 transition duration-200 font-semibold">
                        Create Account
                    </button>
                </div>
                <div class="text-center">
                    <p class="text-white/80 text-sm">Already have an account? <button onclick="showSignIn()" class="text-white font-semibold underline">Sign In</button></p>
                </div>
            </div>
            
            <!-- Forgot Password Form -->
            <div id="forgot-password-form" class="space-y-6 hidden">
                <h2 class="text-2xl font-semibold text-center">Reset Password</h2>
                <div class="space-y-4">
                    <input type="email" id="forgot-email" placeholder="Enter your email" class="w-full p-4 bg-white/10 border border-white/20 rounded-xl text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-white/50">
                    <button onclick="resetPassword()" class="w-full bg-white text-purple-600 p-4 rounded-xl hover:bg-white/90 transition duration-200 font-semibold">
                        Send Reset Link
                    </button>
                </div>
                <div class="text-center">
                    <button onclick="showSignIn()" class="text-white/80 hover:text-white text-sm underline">Back to Sign In</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="main-app" class="hidden h-screen flex">
        <!-- Sidebar -->
        <div class="w-80 glass-effect border-r border-white/10 flex flex-col mobile-hidden">
            <!-- User Profile Header -->
            <div class="p-6 border-b border-white/10">
                <div class="flex items-center space-x-4">
                    <div class="relative">
                        <img id="user-avatar" src="" alt="Avatar" class="w-12 h-12 rounded-full object-cover border-2 border-white/20">
                        <div id="user-status-dot" class="absolute -bottom-1 -right-1 w-4 h-4 bg-green-500 rounded-full border-2 border-white"></div>
                    </div>
                    <div class="flex-1">
                        <h3 id="user-name" class="text-white font-semibold"></h3>
                        <p id="user-username" class="text-white/60 text-sm"></p>
                    </div>
                    <button onclick="showProfile()" class="p-2 hover:bg-white/10 rounded-lg transition-colors">
                        <svg class="w-5 h-5 text-white/80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Navigation Tabs -->
            <div class="flex border-b border-white/10">
                <button onclick="showTab('chats')" class="flex-1 p-4 text-white/80 hover:text-white hover:bg-white/5 transition-colors tab-btn active" data-tab="chats">
                    <div class="flex items-center justify-center space-x-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                        </svg>
                        <span class="text-sm font-medium">Chats</span>
                    </div>
                </button>
                <button onclick="showTab('friends')" class="flex-1 p-4 text-white/80 hover:text-white hover:bg-white/5 transition-colors tab-btn" data-tab="friends">
                    <div class="flex items-center justify-center space-x-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                        </svg>
                        <span class="text-sm font-medium">Friends</span>
                    </div>
                </button>
                <button onclick="showTab('rooms')" class="flex-1 p-4 text-white/80 hover:text-white hover:bg-white/5 transition-colors tab-btn" data-tab="rooms">
                    <div class="flex items-center justify-center space-x-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                        <span class="text-sm font-medium">Rooms</span>
                    </div>
                </button>
            </div>

            <!-- Tab Content -->
            <div class="flex-1 overflow-y-auto">
                <!-- Chats Tab -->
                <div id="chats-tab" class="tab-content">
                    <div class="p-4">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-white font-semibold">Direct Messages</h3>
                            <button onclick="showNewChatModal()" class="p-2 hover:bg-white/10 rounded-lg transition-colors">
                                <svg class="w-5 h-5 text-white/80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                            </button>
                        </div>
                        <div id="direct-messages-list" class="space-y-2">
                            <!-- Direct messages will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Friends Tab -->
                <div id="friends-tab" class="tab-content hidden">
                    <div class="p-4">
                        <div class="mb-4">
                            <div class="flex space-x-2">
                                <input type="text" id="search-users" placeholder="Search users..." class="flex-1 p-3 bg-white/10 border border-white/20 rounded-lg text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-white/50">
                                <button onclick="searchUsers()" class="px-4 py-3 bg-white/20 hover:bg-white/30 rounded-lg transition-colors">
                                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Friend Requests -->
                        <div class="mb-6">
                            <h4 class="text-white/80 text-sm font-medium mb-3">Friend Requests</h4>
                            <div id="friend-requests-list" class="space-y-2">
                                <!-- Friend requests will be populated here -->
                            </div>
                        </div>

                        <!-- Friends List -->
                        <div>
                            <h4 class="text-white/80 text-sm font-medium mb-3">Friends</h4>
                            <div id="friends-list" class="space-y-2">
                                <!-- Friends will be populated here -->
                            </div>
                        </div>

                        <!-- Search Results -->
                        <div id="search-results" class="mt-4 space-y-2 hidden">
                            <!-- Search results will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Rooms Tab -->
                <div id="rooms-tab" class="tab-content hidden">
                    <div class="p-4">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-white font-semibold">Chat Rooms</h3>
                            <button onclick="showCreateRoomModal()" class="p-2 hover:bg-white/10 rounded-lg transition-colors">
                                <svg class="w-5 h-5 text-white/80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                            </button>
                        </div>
                        <div id="rooms-list" class="space-y-2">
                            <!-- Rooms will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Area -->
        <div class="flex-1 flex flex-col">
            <!-- Welcome Screen -->
            <div id="welcome-screen" class="flex-1 flex items-center justify-center">
                <div class="text-center text-white/80">
                    <div class="w-24 h-24 bg-white/10 rounded-full flex items-center justify-center mx-auto mb-6">
                        <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                        </svg>
                    </div>
                    <h2 class="text-2xl font-bold mb-2">Welcome to ChatVibe</h2>
                    <p class="text-lg">Select a chat to start messaging</p>
                </div>
            </div>

            <!-- Chat Interface -->
            <div id="chat-interface" class="hidden flex-1 flex flex-col">
                <!-- Chat Header -->
                <div class="glass-effect border-b border-white/10 p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <button onclick="closeChatMobile()" class="md:hidden p-2 hover:bg-white/10 rounded-lg">
                                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                                </svg>
                            </button>
                            <div class="relative">
                                <img id="chat-avatar" src="" alt="Avatar" class="w-10 h-10 rounded-full object-cover">
                                <div id="chat-status-dot" class="absolute -bottom-1 -right-1 w-3 h-3 bg-green-500 rounded-full border-2 border-white"></div>
                            </div>
                            <div>
                                <h3 id="chat-name" class="text-white font-semibold"></h3>
                                <p id="chat-status" class="text-white/60 text-sm"></p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button onclick="showChatInfo()" class="p-2 hover:bg-white/10 rounded-lg transition-colors">
                                <svg class="w-5 h-5 text-white/80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Messages Area -->
                <div id="messages-container" class="flex-1 overflow-y-auto p-4 space-y-4">
                    <!-- Messages will be populated here -->
                </div>

                <!-- Typing Indicator -->
                <div id="typing-indicator" class="hidden px-4 py-2">
                    <div class="flex items-center space-x-2 text-white/60">
                        <div class="flex space-x-1">
                            <div class="w-2 h-2 bg-white/60 rounded-full typing-indicator"></div>
                            <div class="w-2 h-2 bg-white/60 rounded-full typing-indicator" style="animation-delay: 0.2s;"></div>
                            <div class="w-2 h-2 bg-white/60 rounded-full typing-indicator" style="animation-delay: 0.4s;"></div>
                        </div>
                        <span class="text-sm">Someone is typing...</span>
                    </div>
                </div>

                <!-- Message Input -->
                <div class="glass-effect border-t border-white/10 p-4">
                    <div class="flex items-end space-x-3">
                        <div class="flex-1 relative">
                            <textarea id="message-input" placeholder="Type your message..." class="w-full p-3 bg-white/10 border border-white/20 rounded-xl text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-white/50 resize-none max-h-32" rows="1"></textarea>
                            <div class="absolute right-3 top-3 flex items-center space-x-2">
                                <button onclick="toggleEmojiPicker()" class="p-1 hover:bg-white/10 rounded transition-colors">
                                    <span class="text-lg">üòä</span>
                                </button>
                                <div id="emoji-picker" class="emoji-picker">
                                    <div class="grid grid-cols-6 gap-2">
                                        <button onclick="addEmoji('üòÄ')" class="p-2 hover:bg-gray-100 rounded">üòÄ</button>
                                        <button onclick="addEmoji('üòÇ')" class="p-2 hover:bg-gray-100 rounded">üòÇ</button>
                                        <button onclick="addEmoji('üòç')" class="p-2 hover:bg-gray-100 rounded">üòç</button>
                                        <button onclick="addEmoji('ü•∞')" class="p-2 hover:bg-gray-100 rounded">ü•∞</button>
                                        <button onclick="addEmoji('üòé')" class="p-2 hover:bg-gray-100 rounded">üòé</button>
                                        <button onclick="addEmoji('ü§î')" class="p-2 hover:bg-gray-100 rounded">ü§î</button>
                                        <button onclick="addEmoji('üëç')" class="p-2 hover:bg-gray-100 rounded">üëç</button>
                                        <button onclick="addEmoji('‚ù§Ô∏è')" class="p-2 hover:bg-gray-100 rounded">‚ù§Ô∏è</button>
                                        <button onclick="addEmoji('üî•')" class="p-2 hover:bg-gray-100 rounded">üî•</button>
                                        <button onclick="addEmoji('‚ú®')" class="p-2 hover:bg-gray-100 rounded">‚ú®</button>
                                        <button onclick="addEmoji('üéâ')" class="p-2 hover:bg-gray-100 rounded">üéâ</button>
                                        <button onclick="addEmoji('üíØ')" class="p-2 hover:bg-gray-100 rounded">üíØ</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button onclick="sendMessage()" class="p-3 bg-white text-purple-600 rounded-xl hover:bg-white/90 transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profile-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="glass-effect rounded-3xl shadow-2xl w-full max-w-md p-8 text-white">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold">Profile</h2>
                <button onclick="closeProfile()" class="p-2 hover:bg-white/10 rounded-lg">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="text-center mb-6">
                <div class="relative inline-block">
                    <img id="profile-avatar" src="" alt="Avatar" class="w-24 h-24 rounded-full object-cover mx-auto mb-4">
                    <button onclick="changeProfilePicture()" class="absolute bottom-2 right-2 p-2 bg-white text-purple-600 rounded-full hover:bg-white/90 transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                    </button>
                </div>
                <input type="file" id="avatar-input" accept="image/*" class="hidden" onchange="uploadProfilePicture()">
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Display Name</label>
                    <input type="text" id="profile-name" class="w-full p-3 bg-white/10 border border-white/20 rounded-xl text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-white/50">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Username</label>
                    <input type="text" id="profile-username" class="w-full p-3 bg-white/10 border border-white/20 rounded-xl text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-white/50">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Status</label>
                    <select id="profile-status" class="w-full p-3 bg-white/10 border border-white/20 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-white/50">
                        <option value="online" class="bg-purple-600">Online</option>
                        <option value="away" class="bg-purple-600">Away</option>
                        <option value="busy" class="bg-purple-600">Busy</option>
                        <option value="offline" class="bg-purple-600">Offline</option>
                    </select>
                </div>
            </div>

            <div class="flex space-x-4 mt-8">
                <button onclick="updateProfile()" class="flex-1 bg-white text-purple-600 p-3 rounded-xl hover:bg-white/90 transition-colors font-semibold">
                    Save Changes
                </button>
                <button onclick="signOut()" class="flex-1 bg-red-500/20 text-red-300 p-3 rounded-xl hover:bg-red-500/30 transition-colors font-semibold">
                    Sign Out
                </button>
            </div>

            <!-- Room Activity Section -->
            <div class="mt-8 pt-6 border-t border-white/20">
                <h3 class="text-lg font-semibold mb-4">Room Activity</h3>
                <div id="room-activity-list" class="space-y-3 max-h-40 overflow-y-auto">
                    <!-- Room activity will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Create Room Modal -->
    <div id="create-room-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="glass-effect rounded-3xl shadow-2xl w-full max-w-md p-8 text-white">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold">Create Room</h2>
                <button onclick="closeCreateRoom()" class="p-2 hover:bg-white/10 rounded-lg">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Room Name</label>
                    <input type="text" id="room-name" placeholder="Enter room name" class="w-full p-3 bg-white/10 border border-white/20 rounded-xl text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-white/50">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Description</label>
                    <textarea id="room-description" placeholder="Room description (optional)" class="w-full p-3 bg-white/10 border border-white/20 rounded-xl text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-white/50 resize-none h-24"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Room Type</label>
                    <div class="flex space-x-4">
                        <label class="flex items-center space-x-2">
                            <input type="radio" name="room-type" value="public" checked class="text-white">
                            <span>Public</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="radio" name="room-type" value="private" class="text-white">
                            <span>Private</span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="flex space-x-4 mt-8">
                <button onclick="closeCreateRoom()" class="flex-1 bg-white/20 text-white p-3 rounded-xl hover:bg-white/30 transition-colors font-semibold">
                    Cancel
                </button>
                <button onclick="createRoom()" class="flex-1 bg-white text-purple-600 p-3 rounded-xl hover:bg-white/90 transition-colors font-semibold">
                    Create Room
                </button>
            </div>
        </div>
    </div>

    <!-- New Chat Modal -->
    <div id="new-chat-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="glass-effect rounded-3xl shadow-2xl w-full max-w-md p-8 text-white">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold">New Chat</h2>
                <button onclick="closeNewChat()" class="p-2 hover:bg-white/10 rounded-lg">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="space-y-4">
                <input type="text" id="new-chat-search" placeholder="Search friends..." class="w-full p-3 bg-white/10 border border-white/20 rounded-xl text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-white/50">
                <div id="new-chat-friends" class="space-y-2 max-h-60 overflow-y-auto">
                    <!-- Friends list for new chat will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB_Q5EseET7WykS4WcIQs1Y7a-CMmcbnp8",
            authDomain: "aapurti-9e385.firebaseapp.com",
            databaseURL: "https://aapurti-9e385-default-rtdb.firebaseio.com",
            projectId: "aapurti-9e385",
            storageBucket: "aapurti-9e385.appspot.com",
            messagingSenderId: "72618637937",
            appId: "1:72618637937:web:e89cca640172708f23f9d0",
            measurementId: "G-4C479V87YN"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // Global variables
        let currentUser = null;
        let currentChat = null;
        let unsubscribers = [];

        // Utility Functions
        function showNotification(message, type = 'success') {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            notification.className = `notification-slide p-4 rounded-xl shadow-lg text-white max-w-sm ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 
                'bg-blue-500'
            }`;
            notification.textContent = message;
            container.appendChild(notification);
            
            setTimeout(() => {
                if (container.contains(notification)) {
                    container.removeChild(notification);
                }
            }, 4000);
        }

        function formatTime(timestamp) {
            if (!timestamp) return '';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'Just now';
            if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
            if (diff < 604800000) return `${Math.floor(diff / 86400000)}d ago`;
            
            return date.toLocaleDateString();
        }

        function generateAvatar(name) {
            const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8'];
            const color = colors[name.charCodeAt(0) % colors.length];
            const initial = name.charAt(0).toUpperCase();
            
            const canvas = document.createElement('canvas');
            canvas.width = 100;
            canvas.height = 100;
            const ctx = canvas.getContext('2d');
            
            ctx.fillStyle = color;
            ctx.fillRect(0, 0, 100, 100);
            
            ctx.fillStyle = 'white';
            ctx.font = 'bold 40px Inter';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(initial, 50, 50);
            
            return canvas.toDataURL();
        }

        // Authentication Functions
        function showSignUp() {
            document.getElementById('signin-form').classList.add('hidden');
            document.getElementById('signup-form').classList.remove('hidden');
            document.getElementById('forgot-password-form').classList.add('hidden');
        }

        function showSignIn() {
            document.getElementById('signin-form').classList.remove('hidden');
            document.getElementById('signup-form').classList.add('hidden');
            document.getElementById('forgot-password-form').classList.add('hidden');
        }

        function showForgotPassword() {
            document.getElementById('signin-form').classList.add('hidden');
            document.getElementById('signup-form').classList.add('hidden');
            document.getElementById('forgot-password-form').classList.remove('hidden');
        }

        async function signUp() {
            const name = document.getElementById('signup-name').value.trim();
            const username = document.getElementById('signup-username').value.trim();
            const email = document.getElementById('signup-email').value.trim();
            const password = document.getElementById('signup-password').value;

            if (!name || !username || !email || !password) {
                showNotification('Please fill in all fields', 'error');
                return;
            }

            if (password.length < 6) {
                showNotification('Password must be at least 6 characters', 'error');
                return;
            }

            try {
                // Check if username is taken
                const usernameQuery = await db.collection('users').where('username', '==', username).get();
                if (!usernameQuery.empty) {
                    showNotification('Username is already taken', 'error');
                    return;
                }

                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;

                // Create user profile
                await db.collection('users').doc(user.uid).set({
                    name: name,
                    username: username,
                    email: email,
                    avatar: generateAvatar(name),
                    status: 'online',
                    lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                showNotification('Account created successfully!');
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }

        async function signIn() {
            const email = document.getElementById('signin-email').value.trim();
            const password = document.getElementById('signin-password').value;

            if (!email || !password) {
                showNotification('Please enter email and password', 'error');
                return;
            }

            try {
                await auth.signInWithEmailAndPassword(email, password);
                showNotification('Welcome back!');
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }

        async function resetPassword() {
            const email = document.getElementById('forgot-email').value.trim();
            
            if (!email) {
                showNotification('Please enter your email', 'error');
                return;
            }

            try {
                await auth.sendPasswordResetEmail(email);
                showNotification('Password reset email sent!');
                showSignIn();
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }

        async function signOut() {
            try {
                if (currentUser) {
                    await db.collection('users').doc(currentUser.uid).update({
                        status: 'offline',
                        lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                // Clean up listeners
                unsubscribers.forEach(unsubscribe => unsubscribe());
                unsubscribers = [];
                
                await auth.signOut();
                showNotification('Signed out successfully');
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }

        // App Initialization
        function initializeApp() {
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            
            loadUserProfile();
            setupRealtimeListeners();
            showTab('chats');
        }

        async function loadUserProfile() {
            if (!currentUser) return;
            
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                const userData = userDoc.data();
                
                // Update UI with user data
                document.getElementById('user-name').textContent = userData.name;
                document.getElementById('user-username').textContent = '@' + userData.username;
                document.getElementById('user-avatar').src = userData.avatar;
                
                // Update profile modal
                document.getElementById('profile-name').value = userData.name;
                document.getElementById('profile-username').value = userData.username;
                document.getElementById('profile-status').value = userData.status || 'online';
                document.getElementById('profile-avatar').src = userData.avatar;
                
                // Update user status to online
                await db.collection('users').doc(currentUser.uid).update({
                    status: 'online',
                    lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                });
                
            } catch (error) {
                console.error('Error loading user profile:', error);
            }
        }

        function setupRealtimeListeners() {
            // Listen for direct messages
            const messagesUnsubscribe = db.collection('directMessages')
                .where('participants', 'array-contains', currentUser.uid)
                .orderBy('lastMessageTime', 'desc')
                .onSnapshot(snapshot => {
                    loadDirectMessages(snapshot.docs);
                });
            unsubscribers.push(messagesUnsubscribe);

            // Listen for friend requests
            const friendRequestsUnsubscribe = db.collection('friendRequests')
                .where('to', '==', currentUser.uid)
                .where('status', '==', 'pending')
                .onSnapshot(snapshot => {
                    loadFriendRequests(snapshot.docs);
                });
            unsubscribers.push(friendRequestsUnsubscribe);

            // Listen for friends
            const friendsUnsubscribe = db.collection('friends')
                .where('users', 'array-contains', currentUser.uid)
                .onSnapshot(snapshot => {
                    loadFriends(snapshot.docs);
                });
            unsubscribers.push(friendsUnsubscribe);

            // Listen for rooms
            const roomsUnsubscribe = db.collection('rooms')
                .where('members', 'array-contains', currentUser.uid)
                .orderBy('lastActivity', 'desc')
                .onSnapshot(snapshot => {
                    loadRooms(snapshot.docs);
                });
            unsubscribers.push(roomsUnsubscribe);
        }

        // Tab Management
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.remove('hidden');
            
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active', 'text-white', 'bg-white/10');
                btn.classList.add('text-white/80');
            });
            
            const activeBtn = document.querySelector(`[data-tab="${tabName}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active', 'text-white', 'bg-white/10');
                activeBtn.classList.remove('text-white/80');
            }
        }

        // Direct Messages
        function loadDirectMessages(docs) {
            const container = document.getElementById('direct-messages-list');
            
            if (docs.length === 0) {
                container.innerHTML = '<p class="text-white/60 text-center py-8">No conversations yet</p>';
                return;
            }

            container.innerHTML = docs.map(doc => {
                const data = doc.data();
                const otherUserId = data.participants.find(id => id !== currentUser.uid);
                
                return `
                    <div class="p-3 hover:bg-white/5 rounded-xl cursor-pointer transition-colors hover-lift" onclick="openDirectMessage('${doc.id}', '${otherUserId}')">
                        <div class="flex items-center space-x-3">
                            <div class="relative">
                                <img src="${data.otherUserAvatar || generateAvatar(data.otherUserName || 'User')}" alt="Avatar" class="w-12 h-12 rounded-full object-cover">
                                <div class="absolute -bottom-1 -right-1 w-4 h-4 bg-green-500 rounded-full border-2 border-white"></div>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center justify-between">
                                    <h4 class="text-white font-medium truncate">${data.otherUserName || 'Unknown User'}</h4>
                                    <span class="text-white/60 text-xs">${formatTime(data.lastMessageTime)}</span>
                                </div>
                                <p class="text-white/60 text-sm truncate">${data.lastMessage || 'No messages yet'}</p>
                            </div>
                            ${data.unreadCount > 0 ? `<div class="w-5 h-5 bg-red-500 rounded-full flex items-center justify-center"><span class="text-white text-xs">${data.unreadCount}</span></div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function openDirectMessage(chatId, otherUserId) {
            currentChat = { id: chatId, type: 'direct', otherUserId: otherUserId };
            
            try {
                // Get other user's data
                const otherUserDoc = await db.collection('users').doc(otherUserId).get();
                const otherUserData = otherUserDoc.data();
                
                // Update chat header
                document.getElementById('chat-name').textContent = otherUserData.name;
                document.getElementById('chat-avatar').src = otherUserData.avatar;
                document.getElementById('chat-status').textContent = getStatusText(otherUserData.status, otherUserData.lastSeen);
                
                // Update status dot
                const statusDot = document.getElementById('chat-status-dot');
                statusDot.className = `absolute -bottom-1 -right-1 w-3 h-3 rounded-full border-2 border-white ${getStatusColor(otherUserData.status)}`;
                
                // Show chat interface
                document.getElementById('welcome-screen').classList.add('hidden');
                document.getElementById('chat-interface').classList.remove('hidden');
                
                // Load messages
                loadChatMessages();
                
                // Mark messages as read
                await markMessagesAsRead(chatId);
                
            } catch (error) {
                console.error('Error opening direct message:', error);
                showNotification('Error opening chat', 'error');
            }
        }

        function loadChatMessages() {
            if (!currentChat) return;
            
            const messagesContainer = document.getElementById('messages-container');
            
            // Clean up existing listener
            if (currentChat.messagesUnsubscribe) {
                currentChat.messagesUnsubscribe();
            }
            
            // Listen for messages
            currentChat.messagesUnsubscribe = db.collection('messages')
                .where('chatId', '==', currentChat.id)
                .orderBy('timestamp', 'asc')
                .onSnapshot(snapshot => {
                    const messages = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    
                    renderMessages(messages);
                });
        }

        function renderMessages(messages) {
            const container = document.getElementById('messages-container');
            
            container.innerHTML = messages.map(message => {
                const isOwn = message.senderId === currentUser.uid;
                const messageTime = formatTime(message.timestamp);
                
                return `
                    <div class="chat-bubble flex ${isOwn ? 'justify-end' : 'justify-start'}">
                        <div class="max-w-xs lg:max-w-md">
                            <div class="p-3 rounded-2xl ${isOwn ? 'bg-white text-purple-600' : 'bg-white/10 text-white'}">
                                <p class="break-words">${message.text}</p>
                                ${message.reactions && Object.keys(message.reactions).length > 0 ? `
                                    <div class="flex flex-wrap gap-1 mt-2">
                                        ${Object.entries(message.reactions).map(([emoji, users]) => `
                                            <button onclick="toggleReaction('${message.id}', '${emoji}')" class="px-2 py-1 bg-white/20 rounded-full text-xs flex items-center space-x-1 hover:bg-white/30 transition-colors">
                                                <span>${emoji}</span>
                                                <span>${users.length}</span>
                                            </button>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                            <div class="flex items-center justify-between mt-1 px-1">
                                <span class="text-white/40 text-xs">${messageTime}</span>
                                ${isOwn ? `
                                    <div class="flex items-center space-x-1">
                                        <span class="message-status ${message.status === 'seen' ? 'message-seen' : 'message-delivered'}">
                                            ${message.status === 'seen' ? '‚úì‚úì' : '‚úì'}
                                        </span>
                                        <button onclick="showReactionPicker('${message.id}')" class="text-white/40 hover:text-white/60 text-xs">
                                            üòä
                                        </button>
                                    </div>
                                ` : `
                                    <button onclick="showReactionPicker('${message.id}')" class="text-white/40 hover:text-white/60 text-xs">
                                        üòä
                                    </button>
                                `}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }

        async function sendMessage() {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            
            if (!text || !currentChat) return;
            
            try {
                const messageData = {
                    chatId: currentChat.id,
                    senderId: currentUser.uid,
                    text: text,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'delivered',
                    reactions: {}
                };
                
                // Add message to messages collection
                await db.collection('messages').add(messageData);
                
                // Update chat's last message
                const chatUpdate = {
                    lastMessage: text,
                    lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(),
                    lastMessageSender: currentUser.uid
                };
                
                if (currentChat.type === 'direct') {
                    await db.collection('directMessages').doc(currentChat.id).update(chatUpdate);
                } else if (currentChat.type === 'room') {
                    await db.collection('rooms').doc(currentChat.id).update({
                        ...chatUpdate,
                        lastActivity: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                input.value = '';
                input.style.height = 'auto';
                
            } catch (error) {
                console.error('Error sending message:', error);
                showNotification('Error sending message', 'error');
            }
        }

        // Message input auto-resize
        document.getElementById('message-input').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 128) + 'px';
        });

        // Send message on Enter
        document.getElementById('message-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Emoji Functions
        function toggleEmojiPicker() {
            const picker = document.getElementById('emoji-picker');
            picker.classList.toggle('show');
        }

        function addEmoji(emoji) {
            const input = document.getElementById('message-input');
            input.value += emoji;
            input.focus();
            document.getElementById('emoji-picker').classList.remove('show');
        }

        async function toggleReaction(messageId, emoji) {
            try {
                const messageRef = db.collection('messages').doc(messageId);
                const messageDoc = await messageRef.get();
                const messageData = messageDoc.data();
                
                const reactions = messageData.reactions || {};
                
                if (!reactions[emoji]) {
                    reactions[emoji] = [];
                }
                
                const userIndex = reactions[emoji].indexOf(currentUser.uid);
                if (userIndex > -1) {
                    reactions[emoji].splice(userIndex, 1);
                    if (reactions[emoji].length === 0) {
                        delete reactions[emoji];
                    }
                } else {
                    reactions[emoji].push(currentUser.uid);
                }
                
                await messageRef.update({ reactions });
                
            } catch (error) {
                console.error('Error toggling reaction:', error);
            }
        }

        // Friends System
        async function searchUsers() {
            const query = document.getElementById('search-users').value.trim().toLowerCase();
            const resultsContainer = document.getElementById('search-results');
            
            if (!query) {
                resultsContainer.classList.add('hidden');
                return;
            }
            
            try {
                const usersSnapshot = await db.collection('users')
                    .where('username', '>=', query)
                    .where('username', '<=', query + '\uf8ff')
                    .limit(10)
                    .get();
                
                const users = usersSnapshot.docs
                    .map(doc => ({ id: doc.id, ...doc.data() }))
                    .filter(user => user.id !== currentUser.uid);
                
                if (users.length === 0) {
                    resultsContainer.innerHTML = '<p class="text-white/60 text-center py-4">No users found</p>';
                } else {
                    resultsContainer.innerHTML = users.map(user => `
                        <div class="p-3 bg-white/5 rounded-xl flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <img src="${user.avatar}" alt="Avatar" class="w-10 h-10 rounded-full object-cover">
                                <div>
                                    <h4 class="text-white font-medium">${user.name}</h4>
                                    <p class="text-white/60 text-sm">@${user.username}</p>
                                </div>
                            </div>
                            <button onclick="sendFriendRequest('${user.id}')" class="px-4 py-2 bg-white text-purple-600 rounded-lg hover:bg-white/90 transition-colors text-sm font-medium">
                                Add Friend
                            </button>
                        </div>
                    `).join('');
                }
                
                resultsContainer.classList.remove('hidden');
                
            } catch (error) {
                console.error('Error searching users:', error);
                showNotification('Error searching users', 'error');
            }
        }

        async function sendFriendRequest(userId) {
            try {
                // Check if request already exists
                const existingRequest = await db.collection('friendRequests')
                    .where('from', '==', currentUser.uid)
                    .where('to', '==', userId)
                    .get();
                
                if (!existingRequest.empty) {
                    showNotification('Friend request already sent', 'error');
                    return;
                }
                
                // Check if already friends
                const existingFriendship = await db.collection('friends')
                    .where('users', 'array-contains', currentUser.uid)
                    .get();
                
                const alreadyFriends = existingFriendship.docs.some(doc => 
                    doc.data().users.includes(userId)
                );
                
                if (alreadyFriends) {
                    showNotification('Already friends with this user', 'error');
                    return;
                }
                
                await db.collection('friendRequests').add({
                    from: currentUser.uid,
                    to: userId,
                    status: 'pending',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showNotification('Friend request sent!');
                
            } catch (error) {
                console.error('Error sending friend request:', error);
                showNotification('Error sending friend request', 'error');
            }
        }

        function loadFriendRequests(docs) {
            const container = document.getElementById('friend-requests-list');
            
            if (docs.length === 0) {
                container.innerHTML = '<p class="text-white/60 text-center py-4">No pending requests</p>';
                return;
            }
            
            Promise.all(docs.map(async doc => {
                const data = doc.data();
                const fromUserDoc = await db.collection('users').doc(data.from).get();
                const fromUser = fromUserDoc.data();
                
                return `
                    <div class="p-3 bg-white/5 rounded-xl flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <img src="${fromUser.avatar}" alt="Avatar" class="w-10 h-10 rounded-full object-cover">
                            <div>
                                <h4 class="text-white font-medium">${fromUser.name}</h4>
                                <p class="text-white/60 text-sm">@${fromUser.username}</p>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="respondToFriendRequest('${doc.id}', 'accepted')" class="px-3 py-1 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors text-sm">
                                Accept
                            </button>
                            <button onclick="respondToFriendRequest('${doc.id}', 'declined')" class="px-3 py-1 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors text-sm">
                                Decline
                            </button>
                        </div>
                    </div>
                `;
            })).then(htmlArray => {
                container.innerHTML = htmlArray.join('');
            });
        }

        async function respondToFriendRequest(requestId, response) {
            try {
                const requestDoc = await db.collection('friendRequests').doc(requestId).get();
                const requestData = requestDoc.data();
                
                await db.collection('friendRequests').doc(requestId).update({
                    status: response
                });
                
                if (response === 'accepted') {
                    // Create friendship
                    await db.collection('friends').add({
                        users: [requestData.from, requestData.to],
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    showNotification('Friend request accepted!');
                } else {
                    showNotification('Friend request declined');
                }
                
            } catch (error) {
                console.error('Error responding to friend request:', error);
                showNotification('Error responding to request', 'error');
            }
        }

        function loadFriends(docs) {
            const container = document.getElementById('friends-list');
            
            if (docs.length === 0) {
                container.innerHTML = '<p class="text-white/60 text-center py-4">No friends yet</p>';
                return;
            }
            
            Promise.all(docs.map(async doc => {
                const data = doc.data();
                const friendId = data.users.find(id => id !== currentUser.uid);
                const friendDoc = await db.collection('users').doc(friendId).get();
                const friend = friendDoc.data();
                
                return `
                    <div class="p-3 hover:bg-white/5 rounded-xl cursor-pointer transition-colors hover-lift" onclick="startDirectMessage('${friendId}')">
                        <div class="flex items-center space-x-3">
                            <div class="relative">
                                <img src="${friend.avatar}" alt="Avatar" class="w-10 h-10 rounded-full object-cover">
                                <div class="absolute -bottom-1 -right-1 w-3 h-3 ${getStatusColor(friend.status)} rounded-full border-2 border-white"></div>
                            </div>
                            <div class="flex-1">
                                <h4 class="text-white font-medium">${friend.name}</h4>
                                <p class="text-white/60 text-sm">${getStatusText(friend.status, friend.lastSeen)}</p>
                            </div>
                        </div>
                    </div>
                `;
            })).then(htmlArray => {
                container.innerHTML = htmlArray.join('');
            });
        }

        async function startDirectMessage(friendId) {
            try {
                // Check if direct message already exists
                const existingChat = await db.collection('directMessages')
                    .where('participants', 'array-contains', currentUser.uid)
                    .get();
                
                let chatDoc = existingChat.docs.find(doc => 
                    doc.data().participants.includes(friendId)
                );
                
                if (!chatDoc) {
                    // Create new direct message
                    const friendDoc = await db.collection('users').doc(friendId).get();
                    const friendData = friendDoc.data();
                    const currentUserDoc = await db.collection('users').doc(currentUser.uid).get();
                    const currentUserData = currentUserDoc.data();
                    
                    const chatRef = await db.collection('directMessages').add({
                        participants: [currentUser.uid, friendId],
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastMessage: '',
                        lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(),
                        otherUserName: friendData.name,
                        otherUserAvatar: friendData.avatar,
                        unreadCount: 0
                    });
                    
                    chatDoc = await chatRef.get();
                }
                
                await openDirectMessage(chatDoc.id, friendId);
                showTab('chats');
                
            } catch (error) {
                console.error('Error starting direct message:', error);
                showNotification('Error starting chat', 'error');
            }
        }

        // Status Functions
        function getStatusColor(status) {
            switch (status) {
                case 'online': return 'bg-green-500';
                case 'away': return 'bg-yellow-500';
                case 'busy': return 'bg-red-500';
                default: return 'bg-gray-500';
            }
        }

        function getStatusText(status, lastSeen) {
            if (status === 'online') return 'Online';
            if (status === 'away') return 'Away';
            if (status === 'busy') return 'Busy';
            return `Last seen ${formatTime(lastSeen)}`;
        }

        // Profile Functions
        function showProfile() {
            document.getElementById('profile-modal').classList.remove('hidden');
            loadRoomActivity();
        }

        function closeProfile() {
            document.getElementById('profile-modal').classList.add('hidden');
        }

        function changeProfilePicture() {
            document.getElementById('avatar-input').click();
        }

        async function uploadProfilePicture() {
            const file = document.getElementById('avatar-input').files[0];
            if (!file) return;
            
            try {
                const storageRef = storage.ref(`avatars/${currentUser.uid}`);
                const snapshot = await storageRef.put(file);
                const downloadURL = await snapshot.ref.getDownloadURL();
                
                await db.collection('users').doc(currentUser.uid).update({
                    avatar: downloadURL
                });
                
                document.getElementById('user-avatar').src = downloadURL;
                document.getElementById('profile-avatar').src = downloadURL;
                
                showNotification('Profile picture updated!');
                
            } catch (error) {
                console.error('Error uploading profile picture:', error);
                showNotification('Error uploading image', 'error');
            }
        }

        async function updateProfile() {
            const name = document.getElementById('profile-name').value.trim();
            const username = document.getElementById('profile-username').value.trim();
            const status = document.getElementById('profile-status').value;
            
            if (!name || !username) {
                showNotification('Name and username are required', 'error');
                return;
            }
            
            try {
                // Check if username is taken by another user
                const usernameQuery = await db.collection('users')
                    .where('username', '==', username)
                    .get();
                
                const existingUser = usernameQuery.docs.find(doc => doc.id !== currentUser.uid);
                if (existingUser) {
                    showNotification('Username is already taken', 'error');
                    return;
                }
                
                await db.collection('users').doc(currentUser.uid).update({
                    name: name,
                    username: username,
                    status: status
                });
                
                document.getElementById('user-name').textContent = name;
                document.getElementById('user-username').textContent = '@' + username;
                
                showNotification('Profile updated successfully!');
                closeProfile();
                
            } catch (error) {
                console.error('Error updating profile:', error);
                showNotification('Error updating profile', 'error');
            }
        }

        async function loadRoomActivity() {
            const container = document.getElementById('room-activity-list');
            
            try {
                const roomsSnapshot = await db.collection('rooms')
                    .where('creator', '==', currentUser.uid)
                    .get();
                
                if (roomsSnapshot.empty) {
                    container.innerHTML = '<p class="text-white/60 text-center py-4">No rooms created yet</p>';
                    return;
                }
                
                const activities = await Promise.all(roomsSnapshot.docs.map(async doc => {
                    const roomData = doc.data();
                    const activitySnapshot = await db.collection('roomActivity')
                        .where('roomId', '==', doc.id)
                        .orderBy('timestamp', 'desc')
                        .limit(5)
                        .get();
                    
                    const recentActivity = activitySnapshot.docs.map(activityDoc => {
                        const activity = activityDoc.data();
                        return {
                            ...activity,
                            roomName: roomData.name
                        };
                    });
                    
                    return recentActivity;
                }));
                
                const flatActivities = activities.flat().sort((a, b) => 
                    b.timestamp?.toDate() - a.timestamp?.toDate()
                );
                
                container.innerHTML = flatActivities.slice(0, 10).map(activity => `
                    <div class="p-3 bg-white/5 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-white text-sm font-medium">${activity.roomName}</p>
                                <p class="text-white/60 text-xs">${activity.action} ‚Ä¢ ${formatTime(activity.timestamp)}</p>
                            </div>
                            <span class="text-white/40 text-xs">${Math.floor(activity.duration / 60000)}m</span>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error loading room activity:', error);
                container.innerHTML = '<p class="text-white/60 text-center py-4">Error loading activity</p>';
            }
        }

        // Room Functions
        function showCreateRoomModal() {
            document.getElementById('create-room-modal').classList.remove('hidden');
        }

        function closeCreateRoom() {
            document.getElementById('create-room-modal').classList.add('hidden');
            document.getElementById('room-name').value = '';
            document.getElementById('room-description').value = '';
            document.querySelector('input[name="room-type"][value="public"]').checked = true;
        }

        async function createRoom() {
            const name = document.getElementById('room-name').value.trim();
            const description = document.getElementById('room-description').value.trim();
            const type = document.querySelector('input[name="room-type"]:checked').value;
            
            if (!name) {
                showNotification('Room name is required', 'error');
                return;
            }
            
            try {
                const currentUserDoc = await db.collection('users').doc(currentUser.uid).get();
                const currentUserData = currentUserDoc.data();
                
                await db.collection('rooms').add({
                    name: name,
                    description: description,
                    type: type,
                    creator: currentUser.uid,
                    creatorName: currentUserData.name,
                    members: [currentUser.uid],
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastActivity: firebase.firestore.FieldValue.serverTimestamp(),
                    lastMessage: '',
                    lastMessageTime: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showNotification('Room created successfully!');
                closeCreateRoom();
                showTab('rooms');
                
            } catch (error) {
                console.error('Error creating room:', error);
                showNotification('Error creating room', 'error');
            }
        }

        function loadRooms(docs) {
            const container = document.getElementById('rooms-list');
            
            if (docs.length === 0) {
                container.innerHTML = '<p class="text-white/60 text-center py-8">No rooms yet</p>';
                return;
            }
            
            container.innerHTML = docs.map(doc => {
                const data = doc.data();
                return `
                    <div class="p-3 hover:bg-white/5 rounded-xl cursor-pointer transition-colors hover-lift" onclick="joinRoom('${doc.id}')">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2">
                                    <h4 class="text-white font-medium">${data.name}</h4>
                                    <span class="px-2 py-1 text-xs rounded-full ${data.type === 'public' ? 'bg-green-500/20 text-green-300' : 'bg-blue-500/20 text-blue-300'}">${data.type}</span>
                                </div>
                                <p class="text-white/60 text-sm truncate">${data.description || 'No description'}</p>
                                <p class="text-white/40 text-xs">${data.members.length} members ‚Ä¢ ${formatTime(data.lastActivity)}</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function joinRoom(roomId) {
            currentChat = { id: roomId, type: 'room' };
            
            try {
                const roomDoc = await db.collection('rooms').doc(roomId).get();
                const roomData = roomDoc.data();
                
                // Update chat header
                document.getElementById('chat-name').textContent = roomData.name;
                document.getElementById('chat-avatar').src = generateAvatar(roomData.name);
                document.getElementById('chat-status').textContent = `${roomData.members.length} members`;
                
                // Hide status dot for rooms
                document.getElementById('chat-status-dot').style.display = 'none';
                
                // Show chat interface
                document.getElementById('welcome-screen').classList.add('hidden');
                document.getElementById('chat-interface').classList.remove('hidden');
                
                // Load messages
                loadChatMessages();
                
                // Track room activity
                await db.collection('roomActivity').add({
                    roomId: roomId,
                    userId: currentUser.uid,
                    action: 'joined',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
            } catch (error) {
                console.error('Error joining room:', error);
                showNotification('Error joining room', 'error');
            }
        }

        // New Chat Modal
        function showNewChatModal() {
            document.getElementById('new-chat-modal').classList.remove('hidden');
            loadNewChatFriends();
        }

        function closeNewChat() {
            document.getElementById('new-chat-modal').classList.add('hidden');
        }

        async function loadNewChatFriends() {
            const container = document.getElementById('new-chat-friends');
            
            try {
                const friendsSnapshot = await db.collection('friends')
                    .where('users', 'array-contains', currentUser.uid)
                    .get();
                
                if (friendsSnapshot.empty) {
                    container.innerHTML = '<p class="text-white/60 text-center py-4">No friends to chat with</p>';
                    return;
                }
                
                const friends = await Promise.all(friendsSnapshot.docs.map(async doc => {
                    const data = doc.data();
                    const friendId = data.users.find(id => id !== currentUser.uid);
                    const friendDoc = await db.collection('users').doc(friendId).get();
                    return { id: friendId, ...friendDoc.data() };
                }));
                
                container.innerHTML = friends.map(friend => `
                    <div class="p-3 hover:bg-white/5 rounded-xl cursor-pointer transition-colors" onclick="startDirectMessage('${friend.id}'); closeNewChat();">
                        <div class="flex items-center space-x-3">
                            <div class="relative">
                                <img src="${friend.avatar}" alt="Avatar" class="w-10 h-10 rounded-full object-cover">
                                <div class="absolute -bottom-1 -right-1 w-3 h-3 ${getStatusColor(friend.status)} rounded-full border-2 border-white"></div>
                            </div>
                            <div>
                                <h4 class="text-white font-medium">${friend.name}</h4>
                                <p class="text-white/60 text-sm">@${friend.username}</p>
                            </div>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error loading friends for new chat:', error);
                container.innerHTML = '<p class="text-white/60 text-center py-4">Error loading friends</p>';
            }
        }

        // Utility Functions
        async function markMessagesAsRead(chatId) {
            try {
                const messagesSnapshot = await db.collection('messages')
                    .where('chatId', '==', chatId)
                    .where('senderId', '!=', currentUser.uid)
                    .where('status', '==', 'delivered')
                    .get();
                
                const batch = db.batch();
                messagesSnapshot.docs.forEach(doc => {
                    batch.update(doc.ref, { status: 'seen' });
                });
                
                await batch.commit();
                
            } catch (error) {
                console.error('Error marking messages as read:', error);
            }
        }

        function closeChatMobile() {
            document.getElementById('welcome-screen').classList.remove('hidden');
            document.getElementById('chat-interface').classList.add('hidden');
            currentChat = null;
        }

        function showChatInfo() {
            if (currentChat && currentChat.type === 'room') {
                showNotification('Room info feature coming soon!', 'info');
            } else {
                showNotification('Chat info feature coming soon!', 'info');
            }
        }

        // Auth State Observer
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                document.getElementById('auth-screen').classList.add('hidden');
                setTimeout(() => {
                    initializeApp();
                }, 1000);
            } else {
                currentUser = null;
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('auth-screen').classList.remove('hidden');
                document.getElementById('main-app').classList.add('hidden');
            }
        });

        // Close modals when clicking outside
        document.addEventListener('click', function(e) {
            const emojiPicker = document.getElementById('emoji-picker');
            if (!e.target.closest('.emoji-picker') && !e.target.closest('button[onclick="toggleEmojiPicker()"]')) {
                emojiPicker.classList.remove('show');
            }
        });

        // Initialize loading screen
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                if (!currentUser) {
                    document.getElementById('loading-screen').classList.add('hidden');
                }
            }, 2000);
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'968a1a12a0955981',t:'MTc1NDEwMTI4Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
