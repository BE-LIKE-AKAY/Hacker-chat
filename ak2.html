<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Chat App</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 30px;
            margin: 20px 0;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .glass-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
        }

        .btn {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px 5px;
            font-size: 14px;
        }

        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #4834d4, #686de0);
        }

        .btn-secondary:hover {
            box-shadow: 0 5px 15px rgba(72, 52, 212, 0.4);
        }

        .input-group {
            margin: 15px 0;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #e0e0e0;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 12px 20px;
            border: none;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .input-group input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .input-group input:focus {
            outline: none;
            border-color: #ff6b6b;
            box-shadow: 0 0 20px rgba(255, 107, 107, 0.3);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 3rem;
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .nav-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .nav-tab {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            padding: 12px 25px;
            margin: 5px;
            border-radius: 20px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .nav-tab.active {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            transform: scale(1.05);
        }

        .screen {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .screen.active {
            display: block;
        }

        .chat-container {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
            height: 70vh;
        }

        .sidebar {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 20px;
            overflow-y: auto;
        }

        .chat-area {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .chat-input {
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            gap: 10px;
        }

        .message {
            margin: 10px 0;
            padding: 12px 18px;
            border-radius: 18px;
            max-width: 70%;
            position: relative;
            animation: slideInUp 0.3s ease;
        }

        .message.sent {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }

        .message.received {
            background: rgba(255, 255, 255, 0.2);
            border-bottom-left-radius: 5px;
        }

        .message-info {
            font-size: 12px;
            opacity: 0.7;
            margin-top: 5px;
        }

        .emoji-reactions {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }

        .emoji-btn {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            padding: 2px 5px;
            border-radius: 10px;
            transition: all 0.2s ease;
        }

        .emoji-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.2);
        }

        .room-item, .friend-item {
            padding: 15px;
            margin: 10px 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .room-item:hover, .friend-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(5px);
        }

        .online-status {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #2ecc71;
            display: inline-block;
            margin-left: 10px;
        }

        .offline-status {
            background: #95a5a6;
        }

        .profile-pic {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(45deg, #2ecc71, #27ae60);
            padding: 15px 25px;
            border-radius: 15px;
            color: white;
            z-index: 1000;
            animation: slideInRight 0.5s ease;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close-btn {
            float: right;
            font-size: 24px;
            cursor: pointer;
            color: #ff6b6b;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .user-search {
            position: relative;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
        }

        .search-result-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.2s ease;
        }

        .search-result-item:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        @media (max-width: 768px) {
            .chat-container {
                grid-template-columns: 1fr;
                height: auto;
            }
            
            .sidebar {
                order: 2;
                height: 300px;
            }
            
            .chat-area {
                order: 1;
                height: 400px;
            }
            
            .grid-2 {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .nav-tabs {
                flex-direction: column;
                align-items: center;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(100px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .typing-indicator {
            display: none;
            padding: 10px;
            font-style: italic;
            opacity: 0.7;
        }

        .message-status {
            font-size: 10px;
            opacity: 0.6;
            text-align: right;
            margin-top: 2px;
        }

        .room-stats {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 5px;
        }

        .friend-request-item {
            background: rgba(255, 193, 7, 0.2);
            border-left: 4px solid #ffc107;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="animate__animated animate__fadeInDown">üöÄ FutureChat</h1>
            <p class="animate__animated animate__fadeInUp">Advanced Messaging Platform</p>
        </div>

        <!-- Navigation -->
        <div class="nav-tabs" id="navTabs">
            <button class="nav-tab active" onclick="showScreen('auth')">üîê Auth</button>
            <button class="nav-tab" onclick="showScreen('dashboard')" id="dashboardTab" style="display: none;">üì± Dashboard</button>
            <button class="nav-tab" onclick="showScreen('profile')" id="profileTab" style="display: none;">üë§ Profile</button>
            <button class="nav-tab" onclick="showScreen('friends')" id="friendsTab" style="display: none;">üë• Friends</button>
            <button class="nav-tab" onclick="showScreen('rooms')" id="roomsTab" style="display: none;">üí¨ Rooms</button>
        </div>

        <!-- Authentication Screen -->
        <div id="authScreen" class="screen active">
            <div class="glass-card animate__animated animate__fadeInUp">
                <div class="nav-tabs">
                    <button class="nav-tab active" onclick="showAuthTab('signin')">Sign In</button>
                    <button class="nav-tab" onclick="showAuthTab('signup')">Sign Up</button>
                    <button class="nav-tab" onclick="showAuthTab('forgot')">Forgot Password</button>
                </div>

                <!-- Sign In -->
                <div id="signinTab" class="auth-tab">
                    <h2>Welcome Back! üëã</h2>
                    <div class="input-group">
                        <label>Email</label>
                        <input type="email" id="signinEmail" placeholder="Enter your email">
                    </div>
                    <div class="input-group">
                        <label>Password</label>
                        <input type="password" id="signinPassword" placeholder="Enter your password">
                    </div>
                    <button class="btn" onclick="signIn()">Sign In</button>
                    <button class="btn btn-secondary" onclick="signInWithGoogle()">üîç Sign In with Google</button>
                </div>

                <!-- Sign Up -->
                <div id="signupTab" class="auth-tab" style="display: none;">
                    <h2>Join FutureChat! üéâ</h2>
                    <div class="grid-2">
                        <div class="input-group">
                            <label>Full Name</label>
                            <input type="text" id="signupName" placeholder="Your full name">
                        </div>
                        <div class="input-group">
                            <label>Username</label>
                            <input type="text" id="signupUsername" placeholder="Unique username">
                        </div>
                    </div>
                    <div class="grid-2">
                        <div class="input-group">
                            <label>Age</label>
                            <input type="number" id="signupAge" placeholder="Your age">
                        </div>
                        <div class="input-group">
                            <label>Gender</label>
                            <select id="signupGender">
                                <option value="">Select Gender</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Mobile Number</label>
                        <input type="tel" id="signupMobile" placeholder="Your mobile number">
                    </div>
                    <div class="input-group">
                        <label>Email</label>
                        <input type="email" id="signupEmail" placeholder="Your email address">
                    </div>
                    <div class="input-group">
                        <label>Password</label>
                        <input type="password" id="signupPassword" placeholder="Create a strong password">
                    </div>
                    <button class="btn" onclick="signUp()">Create Account</button>
                    <button class="btn btn-secondary" onclick="signUpWithGoogle()">üîç Sign Up with Google</button>
                </div>

                <!-- Forgot Password -->
                <div id="forgotTab" class="auth-tab" style="display: none;">
                    <h2>Reset Password üîë</h2>
                    <div class="input-group">
                        <label>Email</label>
                        <input type="email" id="forgotEmail" placeholder="Enter your email">
                    </div>
                    <button class="btn" onclick="resetPassword()">Send Reset Link</button>
                </div>
            </div>
        </div>

        <!-- Dashboard Screen -->
        <div id="dashboardScreen" class="screen">
            <div class="glass-card">
                <div class="chat-container">
                    <div class="sidebar">
                        <h3>üí¨ Active Chats</h3>
                        <div id="activeChats"></div>
                        
                        <h3 style="margin-top: 30px;">üåü Online Friends</h3>
                        <div id="onlineFriends"></div>
                    </div>
                    
                    <div class="chat-area">
                        <div class="chat-header">
                            <div>
                                <h3 id="currentChatName">Select a chat to start messaging</h3>
                                <div id="currentChatStatus"></div>
                            </div>
                            <button class="btn" onclick="logout()">Logout</button>
                        </div>
                        
                        <div class="chat-messages" id="chatMessages">
                            <div style="text-align: center; opacity: 0.7; margin-top: 50px;">
                                <h3>üöÄ Welcome to FutureChat!</h3>
                                <p>Select a friend or room to start chatting</p>
                            </div>
                        </div>
                        
                        <div class="typing-indicator" id="typingIndicator">
                            Someone is typing...
                        </div>
                        
                        <div class="chat-input">
                            <input type="text" id="messageInput" placeholder="Type your message..." style="flex: 1;">
                            <button class="btn" onclick="sendMessage()">Send</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile Screen -->
        <div id="profileScreen" class="screen">
            <div class="glass-card animate__animated animate__fadeInUp">
                <h2>üë§ My Profile</h2>
                <div class="grid-2">
                    <div>
                        <div class="profile-pic" id="profilePicDisplay" style="width: 100px; height: 100px; font-size: 36px; margin: 20px auto;"></div>
                        <div class="input-group">
                            <label>Profile Picture URL</label>
                            <input type="url" id="profilePicUrl" placeholder="Enter image URL">
                            <button class="btn" onclick="updateProfilePic()">Update Picture</button>
                        </div>
                    </div>
                    <div>
                        <div class="input-group">
                            <label>Full Name</label>
                            <input type="text" id="profileName">
                        </div>
                        <div class="input-group">
                            <label>Age</label>
                            <input type="number" id="profileAge">
                        </div>
                        <div class="input-group">
                            <label>Gender</label>
                            <select id="profileGender">
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>
                </div>
                <button class="btn" onclick="updateProfile()">Update Profile</button>
                
                <h3 style="margin-top: 40px;">üìä My Room Activity</h3>
                <div id="roomActivity"></div>
            </div>
        </div>

        <!-- Friends Screen -->
        <div id="friendsScreen" class="screen">
            <div class="glass-card animate__animated animate__fadeInUp">
                <h2>üë• Friends & Connections</h2>
                
                <div class="user-search">
                    <div class="input-group">
                        <label>üîç Search Users</label>
                        <input type="text" id="userSearch" placeholder="Search by username..." oninput="searchUsers()">
                    </div>
                    <div class="search-results" id="searchResults"></div>
                </div>
                
                <div class="grid-2">
                    <div>
                        <h3>üì® Friend Requests</h3>
                        <div id="friendRequests"></div>
                    </div>
                    <div>
                        <h3>‚úÖ My Friends</h3>
                        <div id="friendsList"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Rooms Screen -->
        <div id="roomsScreen" class="screen">
            <div class="glass-card animate__animated animate__fadeInUp">
                <div class="grid-2">
                    <div>
                        <h2>üí¨ Chat Rooms</h2>
                        <button class="btn" onclick="showCreateRoomModal()">+ Create Room</button>
                    </div>
                    <div>
                        <button class="btn btn-secondary" onclick="showJoinRoomModal()">üîó Join Private Room</button>
                    </div>
                </div>
                
                <div id="roomsList"></div>
            </div>
        </div>
    </div>

    <!-- Create Room Modal -->
    <div id="createRoomModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('createRoomModal')">&times;</span>
            <h2>Create New Room</h2>
            <div class="input-group">
                <label>Room Name</label>
                <input type="text" id="roomName" placeholder="Enter room name">
            </div>
            <div class="input-group">
                <label>Room Type</label>
                <select id="roomType">
                    <option value="public">Public Room</option>
                    <option value="private">Private Room</option>
                </select>
            </div>
            <div class="input-group">
                <label>Description</label>
                <input type="text" id="roomDescription" placeholder="Room description (optional)">
            </div>
            <button class="btn" onclick="createRoom()">Create Room</button>
        </div>
    </div>

    <!-- Join Room Modal -->
    <div id="joinRoomModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('joinRoomModal')">&times;</span>
            <h2>Join Private Room</h2>
            <div class="input-group">
                <label>Room Code</label>
                <input type="text" id="roomCode" placeholder="Enter room invitation code">
            </div>
            <button class="btn" onclick="joinPrivateRoom()">Join Room</button>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB_Q5EseET7WykS4WcIQs1Y7a-CMmcbnp8",
            authDomain: "aapurti-9e385.firebaseapp.com",
            databaseURL: "https://aapurti-9e385-default-rtdb.firebaseio.com",
            projectId: "aapurti-9e385",
            storageBucket: "aapurti-9e385.appspot.com",
            messagingSenderId: "72618637937",
            appId: "1:72618637937:web:e89cca640172708f23f9d0",
            measurementId: "G-4C479V87YN"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const rtdb = firebase.database();

        // Global Variables
        let currentUser = null;
        let currentChat = null;
        let currentChatType = null; // 'friend' or 'room'

        // Authentication Functions
        async function signIn() {
            const email = document.getElementById('signinEmail').value;
            const password = document.getElementById('signinPassword').value;

            if (!email || !password) {
                showNotification('Please fill in all fields', 'error');
                return;
            }

            try {
                await auth.signInWithEmailAndPassword(email, password);
                showNotification('Welcome back! üéâ');
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }

        async function signUp() {
            const name = document.getElementById('signupName').value;
            const username = document.getElementById('signupUsername').value;
            const age = document.getElementById('signupAge').value;
            const gender = document.getElementById('signupGender').value;
            const mobile = document.getElementById('signupMobile').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;

            if (!name || !username || !age || !gender || !mobile || !email || !password) {
                showNotification('Please fill in all fields', 'error');
                return;
            }

            try {
                // Check if username is unique
                const usernameCheck = await db.collection('users').where('username', '==', username).get();
                if (!usernameCheck.empty) {
                    showNotification('Username already taken! Please choose another.', 'error');
                    return;
                }

                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;

                // Create user profile
                await db.collection('users').doc(user.uid).set({
                    name: name,
                    username: username,
                    age: parseInt(age),
                    gender: gender,
                    mobile: mobile,
                    email: email,
                    profilePic: '',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
                    isOnline: true
                });

                showNotification('Account created successfully! üéâ');
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }

        async function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            try {
                const result = await auth.signInWithPopup(provider);
                const user = result.user;
                
                // Check if user profile exists
                const userDoc = await db.collection('users').doc(user.uid).get();
                if (!userDoc.exists) {
                    // Create profile for new Google user
                    const username = user.email.split('@')[0] + Math.floor(Math.random() * 1000);
                    await db.collection('users').doc(user.uid).set({
                        name: user.displayName,
                        username: username,
                        email: user.email,
                        profilePic: user.photoURL || '',
                        age: 0,
                        gender: '',
                        mobile: '',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
                        isOnline: true
                    });
                }
                
                showNotification('Welcome! üéâ');
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }

        async function signUpWithGoogle() {
            await signInWithGoogle();
        }

        async function resetPassword() {
            const email = document.getElementById('forgotEmail').value;
            if (!email) {
                showNotification('Please enter your email', 'error');
                return;
            }

            try {
                await auth.sendPasswordResetEmail(email);
                showNotification('Password reset email sent! Check your inbox üìß');
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }

        async function logout() {
            try {
                if (currentUser) {
                    await db.collection('users').doc(currentUser.uid).update({
                        isOnline: false,
                        lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                await auth.signOut();
                showNotification('Goodbye! üëã');
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }

        // Profile Functions
        async function updateProfile() {
            if (!currentUser) return;

            const name = document.getElementById('profileName').value;
            const age = document.getElementById('profileAge').value;
            const gender = document.getElementById('profileGender').value;

            try {
                await db.collection('users').doc(currentUser.uid).update({
                    name: name,
                    age: parseInt(age),
                    gender: gender
                });
                showNotification('Profile updated successfully! ‚úÖ');
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }

        async function updateProfilePic() {
            if (!currentUser) return;

            const profilePicUrl = document.getElementById('profilePicUrl').value;
            if (!profilePicUrl) {
                showNotification('Please enter a valid image URL', 'error');
                return;
            }

            try {
                await db.collection('users').doc(currentUser.uid).update({
                    profilePic: profilePicUrl
                });
                document.getElementById('profilePicDisplay').innerHTML = `<img src="${profilePicUrl}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
                showNotification('Profile picture updated! üì∏');
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }

        // Friends Functions
        async function searchUsers() {
            const searchTerm = document.getElementById('userSearch').value.toLowerCase();
            const resultsDiv = document.getElementById('searchResults');

            if (searchTerm.length < 2) {
                resultsDiv.innerHTML = '';
                return;
            }

            try {
                const users = await db.collection('users')
                    .where('username', '>=', searchTerm)
                    .where('username', '<=', searchTerm + '\uf8ff')
                    .limit(5)
                    .get();

                let html = '';
                users.forEach(doc => {
                    const user = doc.data();
                    if (doc.id !== currentUser.uid) {
                        html += `
                            <div class="search-result-item" onclick="sendFriendRequest('${doc.id}', '${user.username}')">
                                <div class="profile-pic" style="width: 30px; height: 30px; font-size: 12px; display: inline-block; margin-right: 10px;">
                                    ${user.profilePic ? `<img src="${user.profilePic}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">` : user.name.charAt(0)}
                                </div>
                                <strong>@${user.username}</strong> - ${user.name}
                                <span class="online-status ${user.isOnline ? '' : 'offline-status'}"></span>
                            </div>
                        `;
                    }
                });
                resultsDiv.innerHTML = html;
            } catch (error) {
                console.error('Search error:', error);
            }
        }

        async function sendFriendRequest(userId, username) {
            if (!currentUser) return;

            try {
                // Check if already friends or request exists
                const existingRequest = await db.collection('friendRequests')
                    .where('from', '==', currentUser.uid)
                    .where('to', '==', userId)
                    .get();

                if (!existingRequest.empty) {
                    showNotification('Friend request already sent!', 'error');
                    return;
                }

                const friendship = await db.collection('friends')
                    .where('users', 'array-contains', currentUser.uid)
                    .get();

                let alreadyFriends = false;
                friendship.forEach(doc => {
                    if (doc.data().users.includes(userId)) {
                        alreadyFriends = true;
                    }
                });

                if (alreadyFriends) {
                    showNotification('Already friends!', 'error');
                    return;
                }

                await db.collection('friendRequests').add({
                    from: currentUser.uid,
                    to: userId,
                    status: 'pending',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                showNotification(`Friend request sent to @${username}! üì§`);
                document.getElementById('userSearch').value = '';
                document.getElementById('searchResults').innerHTML = '';
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }

        async function respondToFriendRequest(requestId, response) {
            try {
                const requestDoc = await db.collection('friendRequests').doc(requestId).get();
                const request = requestDoc.data();

                if (response === 'accept') {
                    // Create friendship
                    await db.collection('friends').add({
                        users: [request.from, request.to],
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    // Create direct message channel
                    await db.collection('directMessages').add({
                        users: [request.from, request.to],
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastMessage: '',
                        lastMessageTime: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    showNotification('Friend request accepted! üéâ');
                } else {
                    showNotification('Friend request declined');
                }

                // Update request status
                await db.collection('friendRequests').doc(requestId).update({
                    status: response,
                    respondedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                loadFriendRequests();
                loadFriends();
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }

        // Room Functions
        async function createRoom() {
            if (!currentUser) return;

            const name = document.getElementById('roomName').value;
            const type = document.getElementById('roomType').value;
            const description = document.getElementById('roomDescription').value;

            if (!name) {
                showNotification('Please enter a room name', 'error');
                return;
            }

            try {
                const roomCode = type === 'private' ? generateRoomCode() : null;
                
                const roomData = {
                    name: name,
                    type: type,
                    description: description,
                    creator: currentUser.uid,
                    members: [currentUser.uid],
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastActivity: firebase.firestore.FieldValue.serverTimestamp()
                };

                if (roomCode) {
                    roomData.code = roomCode;
                }

                const roomRef = await db.collection('rooms').add(roomData);
                
                // Add creator to room members
                await db.collection('roomMembers').add({
                    roomId: roomRef.id,
                    userId: currentUser.uid,
                    joinedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    role: 'creator'
                });

                closeModal('createRoomModal');
                showNotification(`Room "${name}" created successfully! ${roomCode ? `Code: ${roomCode}` : ''} üéâ`);
                loadRooms();
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }

        async function joinPrivateRoom() {
            if (!currentUser) return;

            const code = document.getElementById('roomCode').value;
            if (!code) {
                showNotification('Please enter a room code', 'error');
                return;
            }

            try {
                const rooms = await db.collection('rooms').where('code', '==', code).get();
                
                if (rooms.empty) {
                    showNotification('Invalid room code', 'error');
                    return;
                }

                const roomDoc = rooms.docs[0];
                const room = roomDoc.data();

                // Check if already a member
                const membership = await db.collection('roomMembers')
                    .where('roomId', '==', roomDoc.id)
                    .where('userId', '==', currentUser.uid)
                    .get();

                if (!membership.empty) {
                    showNotification('You are already a member of this room', 'error');
                    return;
                }

                // Add to room members
                await db.collection('roomMembers').add({
                    roomId: roomDoc.id,
                    userId: currentUser.uid,
                    joinedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    role: 'member'
                });

                // Update room members array
                await db.collection('rooms').doc(roomDoc.id).update({
                    members: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
                });

                closeModal('joinRoomModal');
                showNotification(`Joined "${room.name}" successfully! üéâ`);
                loadRooms();
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }

        // Chat Functions
        async function sendMessage() {
            if (!currentUser || !currentChat) return;

            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message) return;

            try {
                const messageData = {
                    text: message,
                    sender: currentUser.uid,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'sent',
                    reactions: {}
                };

                if (currentChatType === 'friend') {
                    messageData.chatId = currentChat;
                    await db.collection('directMessages').doc(currentChat).collection('messages').add(messageData);
                    
                    // Update last message
                    await db.collection('directMessages').doc(currentChat).update({
                        lastMessage: message,
                        lastMessageTime: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } else if (currentChatType === 'room') {
                    messageData.roomId = currentChat;
                    await db.collection('rooms').doc(currentChat).collection('messages').add(messageData);
                    
                    // Update room activity
                    await db.collection('rooms').doc(currentChat).update({
                        lastActivity: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }

                messageInput.value = '';
                scrollToBottom();
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }

        async function openChat(chatId, chatType, chatName) {
            currentChat = chatId;
            currentChatType = chatType;
            
            document.getElementById('currentChatName').textContent = chatName;
            document.getElementById('chatMessages').innerHTML = '';
            
            // Load messages
            let messagesRef;
            if (chatType === 'friend') {
                messagesRef = db.collection('directMessages').doc(chatId).collection('messages');
            } else {
                messagesRef = db.collection('rooms').doc(chatId).collection('messages');
            }
            
            messagesRef.orderBy('timestamp', 'asc').limit(50).onSnapshot(snapshot => {
                loadMessages(snapshot);
            });
        }

        async function loadMessages(snapshot) {
            const messagesDiv = document.getElementById('chatMessages');
            messagesDiv.innerHTML = '';

            for (const doc of snapshot.docs) {
                const message = doc.data();
                const messageElement = await createMessageElement(message, doc.id);
                messagesDiv.appendChild(messageElement);
            }
            
            scrollToBottom();
        }

        async function createMessageElement(message, messageId) {
            const messageDiv = document.createElement('div');
            const isOwn = message.sender === currentUser.uid;
            
            messageDiv.className = `message ${isOwn ? 'sent' : 'received'}`;
            
            let senderName = 'Unknown';
            if (!isOwn) {
                try {
                    const senderDoc = await db.collection('users').doc(message.sender).get();
                    if (senderDoc.exists) {
                        senderName = senderDoc.data().name;
                    }
                } catch (error) {
                    console.error('Error fetching sender:', error);
                }
            }
            
            const timestamp = message.timestamp ? new Date(message.timestamp.toDate()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 'Sending...';
            
            messageDiv.innerHTML = `
                <div>${message.text}</div>
                <div class="message-info">
                    ${!isOwn ? senderName + ' ‚Ä¢ ' : ''}${timestamp}
                    ${isOwn ? `<span class="message-status">‚úì‚úì</span>` : ''}
                </div>
                <div class="emoji-reactions">
                    <button class="emoji-btn" onclick="addReaction('${messageId}', '‚ù§Ô∏è')">‚ù§Ô∏è</button>
                    <button class="emoji-btn" onclick="addReaction('${messageId}', 'üòÇ')">üòÇ</button>
                    <button class="emoji-btn" onclick="addReaction('${messageId}', 'üî•')">üî•</button>
                    <button class="emoji-btn" onclick="addReaction('${messageId}', 'üëç')">üëç</button>
                </div>
            `;
            
            return messageDiv;
        }

        async function addReaction(messageId, emoji) {
            if (!currentUser || !currentChat) return;

            try {
                let messageRef;
                if (currentChatType === 'friend') {
                    messageRef = db.collection('directMessages').doc(currentChat).collection('messages').doc(messageId);
                } else {
                    messageRef = db.collection('rooms').doc(currentChat).collection('messages').doc(messageId);
                }

                await messageRef.update({
                    [`reactions.${emoji}.${currentUser.uid}`]: true
                });
            } catch (error) {
                console.error('Error adding reaction:', error);
            }
        }

        // UI Functions
        function showScreen(screenName) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenName + 'Screen').classList.add('active');
            
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        function showAuthTab(tabName) {
            document.querySelectorAll('.auth-tab').forEach(tab => {
                tab.style.display = 'none';
            });
            document.getElementById(tabName + 'Tab').style.display = 'block';
            
            document.querySelectorAll('#authScreen .nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        function showCreateRoomModal() {
            document.getElementById('createRoomModal').classList.add('active');
        }

        function showJoinRoomModal() {
            document.getElementById('joinRoomModal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            
            if (type === 'error') {
                notification.style.background = 'linear-gradient(45deg, #e74c3c, #c0392b)';
            }
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 4000);
        }

        function generateRoomCode() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        function scrollToBottom() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Load Data Functions
        async function loadProfile() {
            if (!currentUser) return;

            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    document.getElementById('profileName').value = userData.name || '';
                    document.getElementById('profileAge').value = userData.age || '';
                    document.getElementById('profileGender').value = userData.gender || '';
                    
                    const profilePicDisplay = document.getElementById('profilePicDisplay');
                    if (userData.profilePic) {
                        profilePicDisplay.innerHTML = `<img src="${userData.profilePic}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
                    } else {
                        profilePicDisplay.textContent = userData.name ? userData.name.charAt(0) : '?';
                    }
                }
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }

        async function loadFriendRequests() {
            if (!currentUser) return;

            try {
                const requests = await db.collection('friendRequests')
                    .where('to', '==', currentUser.uid)
                    .where('status', '==', 'pending')
                    .get();

                const requestsDiv = document.getElementById('friendRequests');
                let html = '';

                for (const doc of requests.docs) {
                    const request = doc.data();
                    const senderDoc = await db.collection('users').doc(request.from).get();
                    const sender = senderDoc.data();

                    html += `
                        <div class="friend-request-item friend-item">
                            <div class="profile-pic">
                                ${sender.profilePic ? `<img src="${sender.profilePic}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">` : sender.name.charAt(0)}
                            </div>
                            <div style="flex: 1;">
                                <strong>${sender.name}</strong><br>
                                <small>@${sender.username}</small>
                            </div>
                            <div>
                                <button class="btn" style="padding: 5px 15px; margin: 2px;" onclick="respondToFriendRequest('${doc.id}', 'accept')">‚úì</button>
                                <button class="btn" style="padding: 5px 15px; margin: 2px; background: #e74c3c;" onclick="respondToFriendRequest('${doc.id}', 'decline')">‚úó</button>
                            </div>
                        </div>
                    `;
                }

                requestsDiv.innerHTML = html || '<p style="opacity: 0.7;">No pending requests</p>';
            } catch (error) {
                console.error('Error loading friend requests:', error);
            }
        }

        async function loadFriends() {
            if (!currentUser) return;

            try {
                const friendships = await db.collection('friends')
                    .where('users', 'array-contains', currentUser.uid)
                    .get();

                const friendsDiv = document.getElementById('friendsList');
                const onlineFriendsDiv = document.getElementById('onlineFriends');
                let friendsHtml = '';
                let onlineHtml = '';

                for (const doc of friendships.docs) {
                    const friendship = doc.data();
                    const friendId = friendship.users.find(id => id !== currentUser.uid);
                    
                    const friendDoc = await db.collection('users').doc(friendId).get();
                    if (friendDoc.exists) {
                        const friend = friendDoc.data();
                        const isOnline = friend.isOnline;
                        
                        const friendHtml = `
                            <div class="friend-item" onclick="startDirectMessage('${friendId}', '${friend.name}')">
                                <div class="profile-pic">
                                    ${friend.profilePic ? `<img src="${friend.profilePic}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">` : friend.name.charAt(0)}
                                </div>
                                <div style="flex: 1;">
                                    <strong>${friend.name}</strong><br>
                                    <small>@${friend.username}</small>
                                </div>
                                <span class="online-status ${isOnline ? '' : 'offline-status'}"></span>
                            </div>
                        `;
                        
                        friendsHtml += friendHtml;
                        if (isOnline) {
                            onlineHtml += friendHtml;
                        }
                    }
                }

                friendsDiv.innerHTML = friendsHtml || '<p style="opacity: 0.7;">No friends yet</p>';
                onlineFriendsDiv.innerHTML = onlineHtml || '<p style="opacity: 0.7;">No friends online</p>';
            } catch (error) {
                console.error('Error loading friends:', error);
            }
        }

        async function startDirectMessage(friendId, friendName) {
            try {
                // Find or create direct message channel
                const dmQuery = await db.collection('directMessages')
                    .where('users', 'array-contains', currentUser.uid)
                    .get();

                let dmDoc = null;
                dmQuery.forEach(doc => {
                    if (doc.data().users.includes(friendId)) {
                        dmDoc = doc;
                    }
                });

                if (!dmDoc) {
                    // Create new DM channel
                    const newDM = await db.collection('directMessages').add({
                        users: [currentUser.uid, friendId],
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastMessage: '',
                        lastMessageTime: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    dmDoc = { id: newDM.id };
                }

                openChat(dmDoc.id, 'friend', friendName);
                showScreen('dashboard');
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }

        async function loadRooms() {
            if (!currentUser) return;

            try {
                const memberships = await db.collection('roomMembers')
                    .where('userId', '==', currentUser.uid)
                    .get();

                const roomsDiv = document.getElementById('roomsList');
                let html = '';

                for (const memberDoc of memberships.docs) {
                    const membership = memberDoc.data();
                    const roomDoc = await db.collection('rooms').doc(membership.roomId).get();
                    
                    if (roomDoc.exists) {
                        const room = roomDoc.data();
                        const memberCount = room.members ? room.members.length : 0;
                        
                        html += `
                            <div class="room-item" onclick="openChat('${roomDoc.id}', 'room', '${room.name}')">
                                <div class="profile-pic">
                                    ${room.type === 'private' ? 'üîí' : 'üåê'}
                                </div>
                                <div style="flex: 1;">
                                    <strong>${room.name}</strong><br>
                                    <small>${room.description || 'No description'}</small>
                                    <div class="room-stats">
                                        ${memberCount} members ‚Ä¢ ${room.type} room
                                        ${room.code ? ` ‚Ä¢ Code: ${room.code}` : ''}
                                    </div>
                                </div>
                                ${membership.role === 'creator' ? '<span style="color: #feca57;">üëë</span>' : ''}
                            </div>
                        `;
                    }
                }

                roomsDiv.innerHTML = html || '<p style="opacity: 0.7;">No rooms joined yet</p>';
            } catch (error) {
                console.error('Error loading rooms:', error);
            }
        }

        // Auth State Observer
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                
                // Update online status
                await db.collection('users').doc(user.uid).update({
                    isOnline: true,
                    lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Show authenticated screens
                document.getElementById('dashboardTab').style.display = 'block';
                document.getElementById('profileTab').style.display = 'block';
                document.getElementById('friendsTab').style.display = 'block';
                document.getElementById('roomsTab').style.display = 'block';
                
                showScreen('dashboard');
                
                // Load data
                loadProfile();
                loadFriendRequests();
                loadFriends();
                loadRooms();
                
            } else {
                currentUser = null;
                currentChat = null;
                currentChatType = null;
                
                // Hide authenticated screens
                document.getElementById('dashboardTab').style.display = 'none';
                document.getElementById('profileTab').style.display = 'none';
                document.getElementById('friendsTab').style.display = 'none';
                document.getElementById('roomsTab').style.display = 'none';
                
                showScreen('auth');
            }
        });

        // Message input enter key
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Close modals when clicking outside
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });

        // Initialize animations
        gsap.from('.header h1', {duration: 1, y: -50, opacity: 0, ease: 'bounce.out'});
        gsap.from('.nav-tabs', {duration: 0.8, y: 30, opacity: 0, delay: 0.3});
        gsap.from('.glass-card', {duration: 1, scale: 0.9, opacity: 0, delay: 0.5});
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9689e8f957ed54b6',t:'MTc1NDA5OTI3Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
